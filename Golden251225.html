<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>天象集成 G - 3.0 GOLD 視覺奢華系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root { 
    --gold-bright: #fff3a0;
    --gold-main: #d4af37; 
    --gold-deep: #8a6d3b;
    --bg-luxury: #fdfbf0;
    --accent: #b8860b;
    --fs-nano: 0.4rem; 
  } 
  body { 
    font-family: 'PingFang TC', 'Inter', sans-serif; 
    background: linear-gradient(135deg, #fdfbf0 0%, #f7e695 50%, #d4af37 100%);
    background-attachment: fixed;
    color: #4a3708; 
    margin: 0; padding: 0; 
    font-size: var(--fs-nano); 
    overflow-x: hidden; 
  }
  .container { width: 100%; max-width: 100vw; box-sizing: border-box; }
  
  .tabs { 
    display: flex; 
    background: linear-gradient(to bottom, #d4af37, #8a6d3b); 
    border-bottom: 2px solid #fff3a0; 
    position: sticky; top: 0; z-index: 1000;
  }
  .tab-btn { 
    flex: 1; padding: 12px 5px; border: none; background: transparent; 
    color: #fff; font-size: 0.6rem; cursor: pointer; 
    font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  .tab-btn.active { background: rgba(255,255,255,0.4); border-bottom: 3px solid #fff; }

  .tab-content { display: none; padding: 15px; min-height: 85vh; box-sizing: border-box; }
  .tab-content.active { display: block; }

  #status-display { 
    background: rgba(255,255,255,0.85); border: 2px solid var(--gold-main); border-radius: 8px; 
    padding: 10px; margin-bottom: 15px; display: none; color: var(--gold-deep);
    box-shadow: 0 4px 15px rgba(212,175,55,0.2);
  }
  .status-step { font-size: 0.45rem; margin-bottom: 3px; display: flex; align-items: center; }
  .status-step .spinner { border: 2px solid rgba(212,175,55,0.1); border-top: 2px solid var(--gold-main); border-radius: 50%; width: 10px; height: 10px; animation: spin 1s linear infinite; margin-right: 8px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  textarea { 
    width: 100%; background: #fffdf5; border: 2px solid #d4af37; color: #4a3708;
    border-radius: 8px; padding: 10px; font-size: 0.52rem; height: 280px;
    box-sizing: border-box; margin-bottom: 12px; outline: none;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }
  button { 
    width: 100%; padding: 14px; border-radius: 8px; border: none; 
    background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%); 
    color: #fff; font-weight: 900; font-size: 0.65rem; cursor: pointer;
    box-shadow: 0 4px 0 #8a6d3b, 0 8px 15px rgba(184,134,11,0.3);
    transition: all 0.2s;
  }
  button:active { transform: translateY(2px); box-shadow: 0 2px 0 #8a6d3b; }

  .analysis-card { background: rgba(255,255,255,0.8); border: 2px solid #d4af37; border-radius: 12px; padding: 15px; margin-bottom: 15px; }

  .slider { display: flex; overflow-x: auto; gap: 20px; snap-type: x mandatory; padding: 10px 0 30px 0; scrollbar-width: none; }
  .slide { flex: 0 0 85%; snap-align: center; background: #fff; border: 2px solid #d4af37; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(184,134,11,0.2); }

  /* 隱藏的渲染區 */
  .export-layer { position: absolute; left: -9999px; top: 0; }
  .render-canvas { width: 1000px; height: 1250px; background: #fffdf0; display: flex; flex-direction: column; position: relative; border: 20px solid #d4af37; box-sizing: border-box; }
  .canvas-header { height: 120px; background: #d4af37; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 900; letter-spacing: 10px; text-transform: uppercase; }
  .canvas-body { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
  .vision-image { width: 100%; height: 60%; object-fit: cover; border-bottom: 5px solid #d4af37; }
  .canvas-content { padding: 40px; flex: 1; background: #fff; }
  .canvas-math { font-size: 28px; line-height: 1.6; color: #4a3708; border-left: 10px solid #d4af37; padding-left: 25px; margin-bottom: 30px; }
  .canvas-footer { height: 150px; background: #fdfbf0; border-top: 2px solid #d4af37; display: flex; align-items: center; justify-content: space-around; padding: 0 40px; }
  .stat-pill { text-align: center; }
  .stat-pill label { display: block; font-size: 16px; color: #8a6d3b; font-weight: bold; }
  .stat-pill span { font-size: 32px; color: #b8860b; font-weight: 900; }
  .canvas-logo { position: absolute; bottom: 30px; right: 30px; width: 180px; height: 180px; opacity: 0.8; mix-blend-mode: multiply; transform: rotate(-10deg); }

  #msg-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #b8860b; color:#fff; padding: 12px 25px; border-radius: 30px; z-index: 2000; display: none; font-size: 0.55rem; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<div class="container">
    <div style="padding:15px; background:linear-gradient(to right, #d4af37, #fff3a0); border-bottom:2px solid #b8860b; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; color:#8a6d3b; font-size:0.75rem; letter-spacing:2px;">GOLDEN VISUAL G-3.0</div>
        <button onclick="downloadCode()" style="width:auto; padding:6px 12px; font-size:0.4rem; background:rgba(255,255,255,0.5); color:#8a6d3b; border-radius:4px; box-shadow:none; border:1px solid #8a6d3b;">源碼下載</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('t1', this)">數據核算</button>
        <button class="tab-btn" onclick="switchTab('t3', this)">視覺報告</button>
    </div>

    <div id="msg-box"></div>

    <div id="t1" class="tab-content active">
        <div id="status-display"></div>
        <textarea id="dataInput" placeholder="請在此貼入天象觀測數據..."></textarea>
        <button id="runBtn" onclick="runProcess()">啟動金光意象生成</button>
        
        <div id="quickResult" style="margin-top:20px;"></div>
    </div>

    <div id="t3" class="tab-content">
        <div class="slider" id="reportSlider">
            <div style="padding:40px; color:#8a6d3b; text-align:center; width:100%;">尚未生成報告，請先於數據頁進行核算</div>
        </div>
        <div id="actionArea" style="display:none;">
            <button onclick="downloadBatch()" style="background:#b8860b;">下載全部奢華報告 (.PNG)</button>
        </div>
    </div>
</div>

<!-- 隱藏渲染模組 -->
<div class="export-layer">
    <div id="canvas-report" class="render-canvas">
        <div class="canvas-header" id="cv-title">GOLDEN VISION</div>
        <div class="canvas-body">
            <img id="cv-img" class="vision-image" src="" crossorigin="anonymous">
            <div class="canvas-content">
                <div class="canvas-math" id="cv-math"></div>
                <div style="font-size:20px; color:#8a6d3b; font-weight:bold; margin-top:10px;" id="cv-desc"></div>
            </div>
        </div>
        <div class="canvas-footer">
            <div class="stat-pill"><label>ENERGY</label><span id="cv-v1">88</span></div>
            <div class="stat-pill"><label>WEALTH</label><span id="cv-v2">92</span></div>
            <div class="stat-pill"><label>STABLE</label><span id="cv-v3">HIGH</span></div>
        </div>
        <img src="https://iili.io/fGM9XsV.jpg" class="canvas-logo">
    </div>
</div>

<script>
const apiKey = "";
const appId = typeof __app_id !== 'undefined' ? __app_id : 'gold-visual-app';

function switchTab(id, el) { 
    $('.tab-content').removeClass('active'); $('.tab-btn').removeClass('active'); 
    $('#'+id).addClass('active'); $(el).addClass('active');
}
function notify(m) { $('#msg-box').text(m).fadeIn(); setTimeout(() => $('#msg-box').fadeOut(), 3000); }

async function logStatus(m, isDone=false) {
    const display = $('#status-display').show();
    const icon = isDone ? '✨' : '<div class="spinner"></div>';
    display.append(`<div class="status-step">${icon} ${m}</div>`);
    await new Promise(r => setTimeout(r, 400));
}

async function runProcess() {
    const raw = $('#dataInput').val();
    if(!raw) {
        $('#dataInput').val("太陽: 56.7° | 月相：上弦 | 五行：木:25 火:33 土:25 金:20 水:38 | 氣運指數: 88");
        return notify("已載入預設範本，請再次點擊");
    }
    
    $('#status-display').empty();
    $('#runBtn').prop('disabled', true).text('分析核算中...');

    await logStatus("讀取星象字典與五行配置...");
    
    // AI 分析
    const aiPrompt = `分析這段數據：${raw}。
    請以「奢華金光」為主題，回傳 JSON：
    {
        "title": "金運氣旋解析",
        "math_formula": "G = (Wealth * Luck) + SolarRefraction",
        "analysis": "一段富有詩意且專業的財氣解析文字",
        "score_energy": 88,
        "score_wealth": 95,
        "vision_prompt": "A macro shot of liquid gold flowing into a gear shape, extreme detail, sunlight reflecting off golden surfaces, floating sparks, luxury aesthetic, cinematic lighting, 8k"
    }`;

    await logStatus("Gemini 核算深度特徵...");
    const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: [{ text: aiPrompt }] }], generationConfig: { responseMimeType: "application/json" } })
    }).then(r => r.json()).then(d => JSON.parse(d.candidates[0].content.parts[0].text));

    await logStatus("Imagen 繪製意象圖檔...");
    const imgData = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ instances: { prompt: aiRes.vision_prompt }, parameters: { sampleCount: 1 } })
    }).then(r => r.json()).then(d => d.predictions?.[0]?.bytesBase64Encoded ? `data:image/png;base64,${d.predictions[0].bytesBase64Encoded}` : null);

    await logStatus("視覺畫布合成中...");
    
    // 填充渲染區
    $('#cv-title').text(aiRes.title);
    $('#cv-img').attr('src', imgData);
    $('#cv-math').text(aiRes.math_formula);
    $('#cv-desc').text(aiRes.analysis);
    $('#cv-v1').text(aiRes.score_energy);
    $('#cv-v2').text(aiRes.score_wealth);

    // 延遲確保圖片載入
    await new Promise(r => setTimeout(r, 1000));
    
    const canvas = await html2canvas(document.getElementById('canvas-report'), { scale: 0.4, useCORS: true });
    
    $('#reportSlider').empty().append($('<div class="slide"></div>').append(canvas));
    $('#actionArea').show();
    
    await logStatus("金光視覺報告生成完畢", true);
    $('#runBtn').prop('disabled', false).text('啟動金光意象生成');
    switchTab('t3', $('.tab-btn')[1]);
}

async function downloadBatch() {
    const canvas = await html2canvas(document.getElementById('canvas-report'), { scale: 1.5, useCORS: true });
    const link = document.createElement('a');
    link.download = `G_GOLDEN_REPORT_${Date.now()}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
    notify("報告已導出");
}

function downloadCode() {
    const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'G_CORE_GOLDEN_VISUAL.html';
    a.click();
}
</script>
</body>
</html>

