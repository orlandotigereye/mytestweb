<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Shizuku èƒŒæ™¯éŒ„è£½å¼•æ“ (v4.5) - AIç‰ˆæ‰‹æ©ŸéŸ¿æ‡‰å¼å„ªåŒ–</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
    <style>
        /* 1. CSS (RWD éŸ¿æ‡‰å¼ä½ˆå±€) */
        :root { --gold: #D4AF37; --bg: #FDFDFD; --dark: #333; }
        
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            font-size: 10px; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 10px; 
            color: var(--dark); 
            display: flex; 
            justify-content: center;
        }

        .card { 
            width: 100%;
            max-width: 854px; 
            background: var(--bg); 
            border-radius: 8px; 
            border: 1px solid var(--gold); 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            position: relative; 
            z-index: 10; 
        }

        /* é ‚éƒ¨æ¨™é¡Œ */
        .header { background: #fff; padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        .header h2 { margin: 0; font-size: 14px; color: var(--gold); }

        /* åˆ†é æŒ‰éˆ• */
        .tabs { display: flex; background: #eee; border-bottom: 1px solid var(--gold); }
        .tab-btn { 
            flex: 1; 
            padding: 10px 5px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-size: 10px; 
            font-weight: bold; 
            color: #666; 
            transition: 0.3s; 
            white-space: nowrap;
        }
        .tab-btn.active { background: #fff; color: var(--gold); border-bottom: 2px solid var(--gold); }

        /* å…§å®¹å€ */
        .tab-content { display: none; padding: 15px; min-height: 300px; box-sizing: border-box; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        /* æŒ‰éˆ•å„ªåŒ– */
        .btn { 
            background: linear-gradient(135deg, var(--gold), #f1c40f); 
            color: #000; 
            border: none; 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 12px; 
            margin-top: 8px;
            touch-action: manipulation;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* æ—¥èªŒå€ */
        #log { 
            margin-top: 10px; 
            padding: 8px; 
            background: #fafafa; 
            border-radius: 4px; 
            border: 1px dashed #ccc; 
            font-family: 'Consolas', monospace; 
            font-size: 9px; 
            white-space: pre-wrap; 
            height: 120px; 
            overflow-y: auto; 
        }
        
        /* ç•«å¸ƒå®¹å™¨ - é—œéµ RWD */
        #canvas-wrap { 
            width: 100%;
            display: flex; 
            justify-content: center; 
            background: #222; 
            padding: 5px; 
            border-radius: 6px; 
            margin-top: 5px; 
            box-sizing: border-box;
            overflow: hidden;
        }
        canvas { 
            max-width: 100%; 
            height: auto !important; 
            border: 1px solid var(--gold); 
            background: #fff; 
        }

        /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
        @media (max-width: 600px) {
            body { padding: 5px; }
            .header { padding: 8px; }
            .header h2 { font-size: 12px; }
            .tab-content { padding: 10px; }
            .btn { padding: 14px; font-size: 13px; } /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•æ›´å¤§å¥½æŒ‰ */
        }

        /* Live2D éš”é›¢ */
        #l2d-isolate-zone { position: absolute; left: -5000px; top: -5000px; width: 300px; height: 400px; z-index: -9999; pointer-events: none; }
        #live2d-widget, .live2d-widget-container { position: fixed !important; left: -5000px !important; top: -5000px !important; visibility: visible !important; opacity: 1 !important; }

        .footer { padding: 10px; text-align: center; background: #f9f9f9; font-size: 8px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2>Shizuku Studio AI (æ‰‹æ©ŸéŸ¿æ‡‰å¼ç‰ˆ)</h2>
        <div style="font-size:8px;color:#999;margin-top:2px">RWD æŠ€è¡“ Â· æ“¦é™¤è½‰å ´ Â· è§’è‰²å®Œå…¨éš”é›¢</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'control')">1. è¨­å®š</button>
        <button class="tab-btn" onclick="switchTab(event, 'progress')">2. æ—¥èªŒ</button>
        <button class="tab-btn" onclick="switchTab(event, 'preview')">3. é è¦½</button>
    </div>

    <div id="control" class="tab-content active">
        <div style="margin-bottom:10px">
            <label style="font-weight:bold; font-size:10px">æ•™å­¸æ•™æ (.txt, .md):</label>
            <input type="file" id="f" accept=".txt,.md" multiple style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-top:5px; font-size:10px" />
        </div>
        
        <div style="background:#fffbe6; padding:12px; border-radius:6px; border:1px solid #ffe58f; line-height:1.6; font-size:9px">
            <strong style="color:#faad14">ğŸ“± AI ç‰ˆ RWD ç‰¹è‰²ï¼š</strong>
            <ul style="margin:5px 0 0 15px; padding:0">
                <li><strong>å¯¬åº¦è‡ªå‹•é©é…</strong>ï¼šå®Œç¾æ”¯æŒæ‰‹æ©Ÿç›´å‘/æ©«å‘æ“ä½œï¼Œä¸æº¢å‡ºã€‚</li>
                <li><strong>ç•«å¸ƒæ™ºèƒ½ç¸®æ”¾</strong>ï¼šé è¦½ç•«å¸ƒæœƒéš¨è¢å¹•å¤§å°ç¸®æ”¾ï¼ŒéŒ„è£½å‰‡ç¶­æŒ 854x480ã€‚</li>
                <li><strong>è§’è‰²å¾¹åº•éš”é›¢</strong>ï¼šç¹¼æ‰¿ AH ç‰ˆï¼Œè§’è‰²çµ•ä¸å¹²æ“¾æ‰‹æ©Ÿæ“ä½œä»‹é¢ã€‚</li>
                <li><strong>é‡‘è‰²æ“¦é™¤è½‰å ´</strong>ï¼šä¿ç•™å°ˆæ¥­å‹•ç•«ç‰¹æ•ˆã€‚</li>
            </ul>
        </div>

        <button class="btn" id="start-btn" onclick="startProduction()" disabled>æ­£åœ¨é©é…è£ç½®ä¸¦è¼‰å…¥å¼•æ“...</button>
    </div>

    <div id="progress" class="tab-content">
        <div id="progress-container">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:10px">
                <span id="status-text">åŒæ­¥éŒ„è£½ä¸­...</span>
                <span id="percent-text">0%</span>
            </div>
            <div style="width:100%; height:8px; background:#eee; border-radius:4px; overflow:hidden; margin:10px 0">
                <div id="p-bar-fill" style="width:0%; height:100%; background:var(--gold); transition:0.3s"></div>
            </div>
        </div>
        <div id="log">ç³»çµ±å°±ç·’ã€‚</div>
    </div>

    <div id="preview" class="tab-content">
        <div id="canvas-wrap"><canvas id="master-canvas" width="854" height="480"></canvas></div>
        <p style="text-align:center; color:#888; font-size:8px; margin-top:10px">é è¦½ç•«é¢æœƒä¾è£ç½®å¯¬åº¦ç¸®æ”¾</p>
    </div>

    <div class="footer">
        <button onclick="downloadSource()" style="background:none; border:1px solid #ccc; padding:4px 12px; font-size:8px; color:#aaa; border-radius:4px; cursor:pointer">ä¸‹è¼‰æ­¤ç³»çµ±æºç¢¼ (AIç‰ˆ)</button>
    </div>
</div>

<div id="l2d-isolate-zone"></div>

<script>
// 2. Fixed Data & Buffers
const CONFIG = {
    SEC_PER_SLIDE: 6,
    TRANSITION_SEC: 1.0,
    FPS: 20,
    MODEL_PATH: "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
    CANVAS_WIDTH: 854,
    CANVAS_HEIGHT: 480,
    TEXT_MARGIN_X: 85,
    TEXT_MARGIN_Y: 185,
    TEXT_MAX_WIDTH: 450,
    LINE_HEIGHT: 48,
    AVATAR_RADIUS: 125
};

let slides = [];
let mediaRecorder;
let recordedChunks = [];
let isModelReady = false;
let l2dCanvasReference = null;

const prevBuffer = document.createElement('canvas');
const nextBuffer = document.createElement('canvas');
[prevBuffer, nextBuffer].forEach(c => { c.width = CONFIG.CANVAS_WIDTH; c.height = CONFIG.CANVAS_HEIGHT; });

// 3. Script Logic
window.onload = () => {
    addLog("ğŸš€ ç³»çµ±å•Ÿå‹•ï¼šæ­£åœ¨é€²è¡Œè£ç½®é©é…èˆ‡å¼•æ“åˆå§‹åŒ–...");
    initLive2D();
    switchTab(null, 'control');
};

function addLog(msg) {
    const log = document.getElementById("log");
    log.textContent += `\n[${new Date().toLocaleTimeString()}] ${msg}`;
    log.scrollTop = log.scrollHeight;
}

function switchTab(e, id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(e) e.currentTarget.classList.add('active');
    else document.querySelector(`[onclick*="${id}"]`).classList.add('active');
}

function initLive2D() {
    try {
        L2Dwidget.init({
            model: { jsonPath: CONFIG.MODEL_PATH, scale: 1 },
            display: { superBase: document.getElementById('l2d-isolate-zone'), width: 300, height: 400 },
            mobile: { show: true, scale: 0.5 },
            react: { opacity: 1 }
        });
        let attempts = 0;
        const check = setInterval(() => {
            const canvas = document.querySelector('#live2d-widget canvas') || document.querySelector('#l2d-isolate-zone canvas');
            if (canvas) {
                clearInterval(check);
                l2dCanvasReference = canvas;
                isModelReady = true;
                addLog("âœ… å¼•æ“å·²éš”é›¢ã€‚æ”¯æ´æ‰‹æ©Ÿèˆ‡ PC é›™æ¨¡å¼ã€‚");
                document.getElementById("start-btn").disabled = false;
                document.getElementById("start-btn").textContent = "å•Ÿå‹• RWD åŒæ­¥éŒ„è£½";
            }
            if (++attempts > 150) clearInterval(check);
        }, 200);
    } catch (e) { addLog("âŒ å¼•æ“ç•°å¸¸: " + e.message); }
}

async function startProduction() {
    const fileInput = document.getElementById("f");
    if (!fileInput.files.length) { alert("è«‹æä¾›æ•™ææª”æ¡ˆ"); return; }
    switchTab(null, 'progress');
    document.getElementById("start-btn").disabled = true;
    addLog("ğŸ“¡ æ­£åœ¨è§£æå…§å®¹ä¸¦è¦åŠƒéŸ¿æ‡‰å¼è·¯å¾‘...");

    slides = [];
    let fileTitles = [];
    for (let file of fileInput.files) {
        const decoder = new TextDecoder('utf-8');
        const rawText = decoder.decode(await file.arrayBuffer());
        let lines = rawText.split(/\r?\n/).filter(l => l.trim());
        if (lines.length > 0) {
            let title = lines[0].replace(/^#+\s*/, '').trim();
            fileTitles.push(title);
            const sentences = lines.slice(1).join(" ").replace(/\s+/g, ' ').match(/[^ã€‚.]*[ã€‚.]/g) || [lines.slice(1).join(" ")];
            let temp = "";
            sentences.forEach(s => {
                if ((temp + s).length > 100) { if (temp) slides.push({ title, body: temp }); temp = s; } 
                else { temp += s; }
            });
            if (temp) slides.push({ title, body: temp });
        }
    }
    const summaryList = fileTitles.map((t, idx) => `${idx + 1}. ${t}`).join("\n");
    slides.push({ title: "èª²ç¨‹å…§å®¹ç¸½çµ", body: `ä»Šå¤©è¨è«–çš„ä¸»é¡ŒåŒ…å«ï¼š\n${summaryList}\n\nä»Šå¤©è¨è«–çš„å…§å®¹å¦‚ä¸Šï¼Œä¸‹æ¬¡è¦‹ã€‚æˆ‘æ˜¯ Oeye (Orlandotigereye)ï¼Œä¸‹æ¬¡è¦‹ã€‚` });

    addLog(`ğŸ“ è§£æå®Œç•¢ï¼šå…± ${slides.length} å€‹åˆ†é¡å°‡é€²è¡Œè½‰å ´éŒ„è£½ã€‚`);
    prepareRecording();
}

function prepareRecording() {
    const master = document.getElementById("master-canvas");
    const stream = master.captureStream(CONFIG.FPS);
    recordedChunks = [];
    try { mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' }); } 
    catch(e) { mediaRecorder = new MediaRecorder(stream); }
    mediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = exportVideo;
    mediaRecorder.start();
    renderLoop(master.getContext("2d"), 0);
}

function renderLoop(ctx, slideIdx) {
    if (slideIdx >= slides.length) { mediaRecorder.stop(); return; }
    const s = slides[slideIdx];
    const totalFrames = CONFIG.SEC_PER_SLIDE * CONFIG.FPS;
    const transitionFrames = CONFIG.TRANSITION_SEC * CONFIG.FPS;
    let currentFrame = 0;

    if (slideIdx > 0) drawSlideToCanvas(prevBuffer.getContext('2d'), slides[slideIdx - 1]);
    drawSlideToCanvas(nextBuffer.getContext('2d'), s);

    const interval = setInterval(() => {
        ctx.clearRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
        if (slideIdx > 0 && currentFrame < transitionFrames) {
            const ratio = currentFrame / transitionFrames;
            const wipeX = CONFIG.CANVAS_WIDTH * ratio;
            ctx.drawImage(prevBuffer, 0, 0);
            ctx.save();
            ctx.beginPath(); ctx.rect(0, 0, wipeX, CONFIG.CANVAS_HEIGHT); ctx.clip();
            ctx.drawImage(nextBuffer, 0, 0);
            ctx.restore();
            ctx.fillStyle = "rgba(212, 175, 55, 0.8)"; ctx.fillRect(wipeX - 4, 0, 8, CONFIG.CANVAS_HEIGHT);
            ctx.shadowBlur = 15; ctx.shadowColor = "var(--gold)"; ctx.fillRect(wipeX - 1, 0, 2, CONFIG.CANVAS_HEIGHT);
            ctx.shadowBlur = 0;
        } else {
            ctx.drawImage(nextBuffer, 0, 0);
        }
        drawHost(ctx);
        const total = slides.length * totalFrames;
        const prog = ((slideIdx * totalFrames + currentFrame) / total) * 100;
        document.getElementById("p-bar-fill").style.width = prog + "%";
        document.getElementById("percent-text").textContent = Math.round(prog) + "%";
        currentFrame++;
        if (currentFrame >= totalFrames) { clearInterval(interval); renderLoop(ctx, slideIdx + 1); }
    }, 1000 / CONFIG.FPS);
}

function drawSlideToCanvas(targetCtx, slide) {
    targetCtx.fillStyle = "#FFFFFF"; targetCtx.fillRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
    targetCtx.strokeStyle = "#D4AF37"; targetCtx.lineWidth = 14; targetCtx.strokeRect(7, 7, CONFIG.CANVAS_WIDTH - 14, CONFIG.CANVAS_HEIGHT - 14);
    drawSmartTitle(targetCtx, slide.title, 60, 50, 500);
    targetCtx.fillStyle = "#333";
    if (slide.title === "èª²ç¨‹å…§å®¹ç¸½çµ") {
        targetCtx.font = "19px 'PingFang TC', 'Microsoft JhengHei', sans-serif";
        drawElegantText(targetCtx, slide.body, CONFIG.TEXT_MARGIN_X, CONFIG.TEXT_MARGIN_Y - 20, CONFIG.TEXT_MAX_WIDTH, 34, 1.2);
    } else {
        targetCtx.font = "22px 'PingFang TC', 'Microsoft JhengHei', sans-serif";
        drawElegantText(targetCtx, slide.body, CONFIG.TEXT_MARGIN_X, CONFIG.TEXT_MARGIN_Y, CONFIG.TEXT_MAX_WIDTH, CONFIG.LINE_HEIGHT, 1.5);
    }
}

function drawHost(ctx) {
    if (!l2dCanvasReference) return;
    const cx = CONFIG.CANVAS_WIDTH - 160, cy = CONFIG.CANVAS_HEIGHT - 160, radius = CONFIG.AVATAR_RADIUS;
    ctx.save();
    ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI * 2); ctx.clip();
    ctx.fillStyle = "#fff"; ctx.fill();
    ctx.drawImage(l2dCanvasReference, cx - radius, cy - radius - 35, radius * 2, radius * 2.8);
    ctx.restore();
    ctx.strokeStyle = "#D4AF37"; ctx.lineWidth = 6; ctx.stroke();
}

function drawSmartTitle(ctx, title, x, y, maxBoxWidth) {
    ctx.font = `bold 26px 'PingFang TC', 'Microsoft JhengHei', sans-serif`;
    let m = ctx.measureText(title);
    if (m.width > 440) {
        let mid = Math.floor(title.length / 2);
        ctx.fillStyle = "#D4AF37"; ctx.fillRect(x, y, maxBoxWidth, 80);
        ctx.fillStyle = "#FFF"; ctx.font = `bold 22px 'PingFang TC', 'Microsoft JhengHei', sans-serif`;
        ctx.fillText(title.substring(0, mid), x + 35, y + 32); ctx.fillText(title.substring(mid), x + 35, y + 62);
    } else {
        ctx.fillStyle = "#D4AF37"; ctx.fillRect(x, y, maxBoxWidth, 55);
        ctx.fillStyle = "#FFF"; ctx.fillText(title, x + 35, y + 38);
    }
}

function drawElegantText(ctx, text, x, y, maxWidth, lineHeight, charSpacing) {
    const lines = text.split('\n');
    let curY = y;
    lines.forEach(l => {
        const chars = l.split('');
        let curX = x, lineText = '';
        for (let i = 0; i < chars.length; i++) {
            const w = ctx.measureText(chars[i]).width;
            if (ctx.measureText(lineText + chars[i]).width > maxWidth) { curY += lineHeight; curX = x; lineText = ''; }
            ctx.fillText(chars[i], curX, curY);
            curX += w + charSpacing; lineText += chars[i];
        }
        curY += lineHeight;
    });
}

function exportVideo() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = `Studio_AI_RWD_${Date.now()}.webm`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    addLog("âœ¨ éŸ¿æ‡‰å¼éŒ„è£½å®Œæˆï¼Œå½±ç‰‡å·²ä¸‹è¼‰ã€‚");
    document.getElementById("start-btn").disabled = false;
}

function downloadSource() {
    const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
    const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'TextToVideoAI.html' });
    a.click();
}
</script>
</body>
</html>