<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Shizuku èƒŒæ™¯éŒ„è£½å¼•æ“ (v5.1) - APç‰ˆ æ¨™é¡ŒåŒæ­¥åŒ¯å‡º</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
    
    <style>
        /* 1. CSS (ç²¾ç°¡ã€RWDã€å°å­—æ¨¡å¼) */
        :root { --gold: #D4AF37; --bg: #FDFDFD; --dark: #333; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; font-size: 10px; background: #f0f2f5; margin: 0; padding: 5px; color: var(--dark); display: flex; justify-content: center; }
        .card { width: 100%; max-width: 854px; background: var(--bg); border-radius: 8px; border: 1px solid var(--gold); overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .header { background: #fff; padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        .header h2 { margin: 0; font-size: 13px; color: var(--gold); }
        .tabs { display: flex; background: #eee; border-bottom: 1px solid var(--gold); }
        .tab-btn { flex: 1; padding: 10px 5px; border: none; background: none; cursor: pointer; font-size: 10px; font-weight: bold; color: #666; transition: 0.3s; }
        .tab-btn.active { background: #fff; color: var(--gold); border-bottom: 2px solid var(--gold); }
        .tab-content { display: none; padding: 12px; min-height: 300px; box-sizing: border-box; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .btn { background: linear-gradient(135deg, var(--gold), #f1c40f); color: #000; border: none; width: 100%; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 12px; margin-top: 5px; touch-action: manipulation; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #log { margin-top: 8px; padding: 8px; background: #fafafa; border-radius: 4px; border: 1px dashed #ccc; font-family: 'Consolas', monospace; font-size: 9px; white-space: pre-wrap; height: 110px; overflow-y: auto; }
        #canvas-wrap { width: 100%; display: flex; justify-content: center; background: #222; padding: 4px; border-radius: 6px; margin-top: 5px; box-sizing: border-box; overflow: hidden; }
        canvas { max-width: 100%; height: auto !important; border: 1px solid var(--gold); background: #fff; }
        @media (max-width: 600px) { .btn { padding: 15px; font-size: 13px; } .header h2 { font-size: 11px; } }
        #l2d-isolate-zone { position: absolute; left: -5000px; top: -5000px; width: 300px; height: 400px; z-index: -9999; pointer-events: none; }
        #live2d-widget, .live2d-widget-container { position: fixed !important; left: -5000px !important; top: -5000px !important; visibility: visible !important; opacity: 1 !important; }
        .footer { padding: 8px; text-align: center; background: #f9f9f9; font-size: 8px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>

    <script>
        // 2. Fixed Data
        const CONFIG = {
            VERSION: "AP (v5.1)",
            SEC_PER_SLIDE: 6,
            TRANSITION_SEC: 1.0,
            FPS: 20,
            MODEL_PATH: "https://cdn.jsdelivr.net/gh/fghrsh/live2d_demo@v1.4.3/model/shizuku/model.json",
            CANVAS_WIDTH: 854,
            CANVAS_HEIGHT: 480,
            TEXT_MARGIN_X: 85,
            TEXT_MARGIN_Y: 185,
            TEXT_MAX_WIDTH: 450,
            LINE_HEIGHT: 48,
            AVATAR_RADIUS: 125,
            CHAR_HARD_LIMIT: 100,
            MOTION_INTERVAL_MIN: 3,
            MOTION_INTERVAL_MAX: 6
        };

        // 3. Script
        let slides = [];
        let mediaRecorder;
        let recordedChunks = [];
        let isModelReady = false;
        let l2dCanvasReference = null;
        let rafId = null;
        let nextMotionFrame = 0;

        const prevBuffer = document.createElement('canvas');
        const nextBuffer = document.createElement('canvas');
        [prevBuffer, nextBuffer].forEach(c => { c.width = CONFIG.CANVAS_WIDTH; c.height = CONFIG.CANVAS_HEIGHT; });

        window.onload = () => {
            addLog(`ğŸš€ ${CONFIG.VERSION} å•Ÿå‹•ï¼šæ¨™é¡ŒåŒæ­¥åŒ¯å‡ºæ¨¡çµ„å·²åŠ è¼‰ã€‚`);
            initLive2D();
        };

        function addLog(msg) {
            const log = document.getElementById("log");
            if(log) {
                log.textContent += `\n[${new Date().toLocaleTimeString()}] ${msg}`;
                log.scrollTop = log.scrollHeight;
            }
        }

        function switchTab(e, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(e) e.currentTarget.classList.add('active');
            else { 
                const btn = document.querySelector(`[onclick*="'${id}'"]`);
                if(btn) btn.classList.add('active');
            }
        }

        function initLive2D() {
            try {
                L2Dwidget.init({
                    model: { jsonPath: CONFIG.MODEL_PATH, scale: 1 },
                    display: { superBase: document.getElementById('l2d-isolate-zone'), width: 300, height: 400 },
                    mobile: { show: true, scale: 0.5 },
                    react: { opacity: 1 },
                    dialog: { enable: false }
                });
                let attempts = 0;
                const check = setInterval(() => {
                    const canvas = document.querySelector('#live2d-widget canvas') || document.querySelector('#l2d-isolate-zone canvas');
                    if (canvas) {
                        clearInterval(check);
                        l2dCanvasReference = canvas;
                        isModelReady = true;
                        addLog("âœ… è§’è‰²åŠ è¼‰å®Œæˆã€‚å‹•æ…‹å¼•æ“å°±ç·’ã€‚");
                        document.getElementById("start-btn").disabled = false;
                        document.getElementById("start-btn").textContent = "å•Ÿå‹•åŒæ­¥åŒ¯å‡ºéŒ„è£½";
                    }
                    if (++attempts > 150) clearInterval(check);
                }, 200);
            } catch (e) { addLog("âŒ éŒ¯èª¤: " + e.message); }
        }

        function triggerRandomAction() {
            if (!l2dCanvasReference) return;
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            window.dispatchEvent(new MouseEvent('mousemove', { clientX: x, clientY: y }));
            const rect = l2dCanvasReference.getBoundingClientRect();
            const clickEvt = new MouseEvent('click', {
                clientX: rect.left + rect.width / 2,
                clientY: rect.top + rect.height / 2,
                bubbles: true
            });
            l2dCanvasReference.dispatchEvent(clickEvt);
        }

        async function startProduction() {
            const fileInput = document.getElementById("f");
            if (!fileInput.files.length) { alert("è«‹æä¾›æ•™ææª”æ¡ˆ"); return; }
            switchTab(null, 'progress');
            document.getElementById("start-btn").disabled = true;

            slides = [];
            let fileTitles = [];
            for (let file of fileInput.files) {
                const decoder = new TextDecoder('utf-8');
                const text = decoder.decode(await file.arrayBuffer());
                let lines = text.split(/\r?\n/).filter(l => l.trim());
                if (lines.length > 0) {
                    let title = lines[0].replace(/^#+\s*/, '').trim();
                    fileTitles.push(title);
                    const fullBody = lines.slice(1).join(" ").replace(/\s+/g, ' ');
                    const rawSentences = fullBody.match(/[^ã€‚.]*[ã€‚.]/g) || [fullBody];
                    
                    let processedSentences = [];
                    rawSentences.forEach(s => {
                        if (s.length > CONFIG.CHAR_HARD_LIMIT) {
                            for (let i = 0; i < s.length; i += CONFIG.CHAR_HARD_LIMIT) {
                                processedSentences.push(s.substring(i, i + CONFIG.CHAR_HARD_LIMIT));
                            }
                        } else {
                            processedSentences.push(s);
                        }
                    });

                    let temp = "";
                    processedSentences.forEach(s => {
                        if ((temp + s).length > CONFIG.CHAR_HARD_LIMIT) {
                            if (temp) slides.push({ title, body: temp });
                            temp = s;
                        } else {
                            temp += s;
                        }
                    });
                    if (temp) slides.push({ title, body: temp });
                }
            }
            const summaryList = fileTitles.map((t, idx) => `${idx + 1}. ${t}`).join("\n");
            slides.push({ title: "èª²ç¨‹å…§å®¹ç¸½çµ", body: `ä»Šå¤©è¨è«–çš„ä¸»é¡ŒåŒ…å«ï¼š\n${summaryList}\n\nä»Šå¤©è¨è«–çš„å…§å®¹å¦‚ä¸Šï¼Œä¸‹æ¬¡è¦‹ã€‚æˆ‘æ˜¯ Oeye (Orlandotigereye)ï¼Œä¸‹æ¬¡è¦‹ã€‚` });

            addLog(`ğŸ“ åˆ†é¡è™•ç†å®Œæˆã€‚å•Ÿå‹•åŒæ­¥éŒ„è£½ã€‚`);
            prepareRecording();
        }

        function prepareRecording() {
            const master = document.getElementById("master-canvas");
            const stream = master.captureStream(CONFIG.FPS);
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = exportVideo;
            mediaRecorder.start();
            
            nextMotionFrame = CONFIG.FPS * (CONFIG.MOTION_INTERVAL_MIN + Math.random() * (CONFIG.MOTION_INTERVAL_MAX - CONFIG.MOTION_INTERVAL_MIN));
            renderLoopRAF(master.getContext("2d"), 0, 0);
        }

        function renderLoopRAF(ctx, slideIdx, totalFrameCounter) {
            if (slideIdx >= slides.length) { mediaRecorder.stop(); return; }

            const s = slides[slideIdx];
            const totalFrames = CONFIG.SEC_PER_SLIDE * CONFIG.FPS;
            const transitionFrames = CONFIG.TRANSITION_SEC * CONFIG.FPS;
            let currentFrame = 0;
            let lastTime = performance.now();
            const frameInterval = 1000 / CONFIG.FPS;

            if (slideIdx > 0) drawSlide(prevBuffer.getContext('2d'), slides[slideIdx - 1]);
            drawSlide(nextBuffer.getContext('2d'), s);

            function frame(time) {
                const delta = time - lastTime;
                if (delta >= frameInterval) {
                    lastTime = time - (delta % frameInterval);
                    totalFrameCounter++;
                    
                    if (totalFrameCounter >= nextMotionFrame) {
                        triggerRandomAction();
                        nextMotionFrame = totalFrameCounter + CONFIG.FPS * (CONFIG.MOTION_INTERVAL_MIN + Math.random() * (CONFIG.MOTION_INTERVAL_MAX - CONFIG.MOTION_INTERVAL_MIN));
                    }

                    ctx.clearRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
                    if (slideIdx > 0 && currentFrame < transitionFrames) {
                        const wipeX = CONFIG.CANVAS_WIDTH * (currentFrame / transitionFrames);
                        ctx.drawImage(prevBuffer, 0, 0);
                        ctx.save();
                        ctx.beginPath(); ctx.rect(0, 0, wipeX, CONFIG.CANVAS_HEIGHT); ctx.clip();
                        ctx.drawImage(nextBuffer, 0, 0);
                        ctx.restore();
                        ctx.fillStyle = "rgba(212, 175, 55, 0.8)"; ctx.fillRect(wipeX - 4, 0, 8, CONFIG.CANVAS_HEIGHT);
                    } else {
                        ctx.drawImage(nextBuffer, 0, 0);
                    }
                    drawHost(ctx);
                    
                    const totalS = slides.length * totalFrames;
                    const prog = ((slideIdx * totalFrames + currentFrame) / totalS) * 100;
                    document.getElementById("p-bar-fill").style.width = prog + "%à®¿à®•à®³à¯ˆà®•à¯";
                    document.getElementById("percent-text").textContent = Math.round(prog) + "%à®¿à®•à®³à¯ˆà®•à¯";

                    currentFrame++;
                    if (currentFrame >= totalFrames) {
                        renderLoopRAF(ctx, slideIdx + 1, totalFrameCounter);
                        return;
                    }
                }
                rafId = requestAnimationFrame(frame);
            }
            rafId = requestAnimationFrame(frame);
        }

        function drawSlide(tCtx, slide) {
            tCtx.fillStyle = "#FFFFFF"; tCtx.fillRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
            tCtx.strokeStyle = "#D4AF37"; tCtx.lineWidth = 14; tCtx.strokeRect(7, 7, CONFIG.CANVAS_WIDTH - 14, CONFIG.CANVAS_HEIGHT - 14);
            drawSmartTitle(tCtx, slide.title, 60, 50, 500);
            tCtx.fillStyle = "#333";
            tCtx.font = "22px 'PingFang TC', 'Microsoft JhengHei', sans-serif";
            drawWrappedText(tCtx, slide.body, CONFIG.TEXT_MARGIN_X, CONFIG.TEXT_MARGIN_Y, CONFIG.TEXT_MAX_WIDTH, CONFIG.LINE_HEIGHT);
        }

        function drawSmartTitle(ctx, title, x, y, maxBoxWidth) {
            ctx.font = `bold 26px 'PingFang TC', 'Microsoft JhengHei', sans-serif`;
            let m = ctx.measureText(title);
            if (m.width > 440) {
                let mid = Math.floor(title.length / 2);
                ctx.fillStyle = "#D4AF37"; ctx.fillRect(x, y, maxBoxWidth, 80);
                ctx.fillStyle = "#FFF"; ctx.font = `bold 22px 'PingFang TC', 'Microsoft JhengHei', sans-serif`;
                ctx.fillText(title.substring(0, mid), x + 35, y + 32); ctx.fillText(title.substring(mid), x + 35, y + 62);
            } else {
                ctx.fillStyle = "#D4AF37"; ctx.fillRect(x, y, maxBoxWidth, 55);
                ctx.fillStyle = "#FFF"; ctx.fillText(title, x + 35, y + 38);
            }
        }

        function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
            const lines = text.split('\n');
            let curY = y;
            lines.forEach(l => {
                const chars = l.split('');
                let lineText = '';
                let curX = x;
                for (let char of chars) {
                    const w = ctx.measureText(char).width;
                    if (ctx.measureText(lineText + char).width > maxWidth) {
                        curY += lineHeight; curX = x; lineText = '';
                    }
                    ctx.fillText(char, curX, curY);
                    curX += w + 1.5; lineText += char;
                }
                curY += lineHeight;
            });
        }

        function drawHost(ctx) {
            if (!l2dCanvasReference) return;
            const cx = CONFIG.CANVAS_WIDTH - 160, cy = CONFIG.CANVAS_HEIGHT - 160, radius = CONFIG.AVATAR_RADIUS;
            ctx.save();
            ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI * 2); ctx.clip();
            ctx.fillStyle = "#fff"; ctx.fill();
            ctx.drawImage(l2dCanvasReference, cx - radius, cy - radius - 35, radius * 2, radius * 2.8);
            ctx.restore();
            ctx.strokeStyle = "#D4AF37"; ctx.lineWidth = 6; ctx.stroke();
        }

        function exportVideo() {
            cancelAnimationFrame(rafId);
            const ts = Date.now();
            const baseFilename = `Studio_AP_${ts}`;
            
            // 1. åŒ¯å‡ºå½±ç‰‡
            const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(videoBlob);
            const aVideo = document.createElement("a");
            aVideo.href = videoUrl;
            aVideo.download = `${baseFilename}.mp4`;
            aVideo.click();

            // 2. åŒ¯å‡ºæ¨™é¡Œæ–‡å­—æª” (åˆ†è¡Œ)
            const titlesText = slides.map(s => s.title).join('\n');
            const textBlob = new Blob([titlesText], { type: 'text/plain' });
            const textUrl = URL.createObjectURL(textBlob);
            const aText = document.createElement("a");
            aText.href = textUrl;
            aText.download = `${baseFilename}.txt`;
            aText.click();

            addLog("âœ¨ å½±ç‰‡èˆ‡æ¨™é¡Œæ¸…å–® (.txt) å·²åŒæ­¥åŒ¯å‡ºã€‚");
            document.getElementById("start-btn").disabled = false;
        }

        function downloadSource() {
            const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
            const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'TextToVideoAP.html' });
            a.click();
        }
    </script>
</head>
<body>

<div class="card">
    <!-- 4. HTML -->
    <div class="header">
        <h2>Shizuku Studio AP (v5.1 åŒæ­¥åŒ¯å‡ºç‰ˆ)</h2>
        <div style="font-size:8px;color:#999;margin-top:2px">æ¨™é¡Œæ¸…å–®ä¸‹è¼‰ Â· å‹•æ…‹è§’è‰² Â· çµ±ä¸€å‘½åç©ºé–“</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'control')">1. è¨­å®š</button>
        <button class="tab-btn" onclick="switchTab(event, 'progress')">2. éŒ„è£½</button>
        <button class="tab-btn" onclick="switchTab(event, 'preview')">3. é è¦½</button>
    </div>

    <div id="control" class="tab-content active">
        <input type="file" id="f" accept=".txt,.md" multiple style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:10px" />
        <div style="background:#f9f0ff; padding:10px; border-radius:6px; border:1px solid #d3adf7; line-height:1.5; font-size:9px; margin-top:10px">
            <strong style="color:#722ed1">ğŸ“¦ AP ç‰ˆåŒæ­¥åŠŸèƒ½ï¼š</strong>
            <ul style="margin:3px 0 0 15px; padding:0">
                <li><strong>é›™é‡åŒ¯å‡º</strong>ï¼šå®ŒæˆéŒ„è£½å¾Œè‡ªå‹•ä¸‹è¼‰ <code>.mp4</code> å½±ç‰‡èˆ‡ <code>.txt</code> æ¨™é¡Œæª”ã€‚</li>
                <li><strong>å°é½Šå‘½å</strong>ï¼šæ–‡å­—æª”èˆ‡å½±ç‰‡æª”ä½¿ç”¨ç›¸åŒçš„æ™‚é–“æˆ³è¨˜å‘½åï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</li>
                <li><strong>æ¨™é¡Œæ¸…å–®</strong>ï¼šæ–‡å­—æª”å…§å®¹ç‚ºæ‰€æœ‰åˆ†é¡æ¨™é¡Œï¼Œæ¯è¡Œä¸€å€‹ï¼Œæ–¹ä¾¿å¾Œè£½å°é½Šã€‚</li>
            </ul>
        </div>
        <button class="btn" id="start-btn" onclick="startProduction()" disabled>æ­£åœ¨å•Ÿå‹•åŒæ­¥å¼•æ“...</button>
    </div>

    <div id="progress" class="tab-content">
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:10px">
            <span id="status-text">åŒæ­¥éŒ„è£½ä¸­...</span>
            <span id="percent-text">0%</span>
        </div>
        <div style="width:100%; height:6px; background:#eee; border-radius:3px; overflow:hidden; margin:8px 0">
            <div id="p-bar-fill" style="width:0%; height:100%; background:var(--gold); transition:0.3s"></div>
        </div>
        <div id="log">ç³»çµ±å°±ç·’ã€‚</div>
    </div>

    <div id="preview" class="tab-content">
        <div id="canvas-wrap"><canvas id="master-canvas" width="854" height="480"></canvas></div>
    </div>

    <div class="footer">
        <button onclick="downloadSource()" style="background:none; border:1px solid #ccc; padding:3px 10px; font-size:8px; color:#aaa; border-radius:4px; cursor:pointer">ä¸‹è¼‰æºç¢¼ (APç‰ˆ)</button>
    </div>
</div>

<div id="l2d-isolate-zone"></div>

</body>
</html>