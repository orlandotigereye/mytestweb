<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Joint Skeleton → Skin → Comic SVG</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #111;
  color: #eee;
}
#topbar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 8px;
  background: #222;
}
button {
  background: #333;
  color: #fff;
  border: 1px solid #555;
  padding: 6px 10px;
  border-radius: 6px;
}
button:hover { background:#444; }
canvas {
  touch-action: none;
  display: block;
  background: #fafafa;
}
</style>
</head>

<body>

<div id="topbar">
  <button onclick="addJoint()">＋關節</button>
  <button onclick="addBone()">＋骨架連線</button>
  <button onclick="generateSkin()">骨架→包皮</button>
  <button onclick="refineComic()">包皮→漫畫線</button>
  <button onclick="savePose()">儲存姿勢</button>
  <button onclick="loadPose()">讀取姿勢</button>
  <button onclick="exportSVG()">匯出 SVG</button>
</div>

<canvas id="c"></canvas>

<script>
/* ================= 基本設定 ================= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
resize();
window.addEventListener('resize', resize);

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 52;
  draw();
}

/* ================= 資料結構 ================= */
let joints = [];     // {x,y,r}
let bones = [];      // [i,j]
let skinPaths = [];  // [{points:[]}]
let selectedJoint = null;
let mode = 'move';

/* ================= 互動 ================= */
canvas.addEventListener('pointerdown', e=>{
  const p = getPos(e);
  selectedJoint = joints.find(j=>dist(j,p)<j.r+5);
  if(!selectedJoint && mode==='addJoint'){
    joints.push({x:p.x,y:p.y,r:6});
  }
  draw();
});
canvas.addEventListener('pointermove', e=>{
  if(selectedJoint){
    const p = getPos(e);
    selectedJoint.x = p.x;
    selectedJoint.y = p.y;
    draw();
  }
});
canvas.addEventListener('pointerup', ()=>selectedJoint=null);

function getPos(e){
  const r = canvas.getBoundingClientRect();
  return {x:e.clientX-r.left,y:e.clientY-r.top};
}
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }

/* ================= 操作 ================= */
function addJoint(){ mode='addJoint'; }
function addBone(){
  if(joints.length>=2){
    bones.push([joints.length-2,joints.length-1]);
    draw();
  }
}

/* ================= 骨架→包皮 ================= */
function generateSkin(){
  skinPaths=[];
  bones.forEach(b=>{
    const a=joints[b[0]], c=joints[b[1]];
    const dx=c.x-a.x, dy=c.y-a.y;
    const len=Math.hypot(dx,dy);
    const nx=-dy/len, ny=dx/len;
    const w = 12;
    skinPaths.push({
      points:[
        {x:a.x+nx*w,y:a.y+ny*w},
        {x:c.x+nx*w,y:c.y+ny*w},
        {x:c.x-nx*w,y:c.y-ny*w},
        {x:a.x-nx*w,y:a.y-ny*w}
      ]
    });
  });
  draw();
}

/* ================= 包皮→漫畫線（AI風） ================= */
function refineComic(){
  skinPaths.forEach(p=>{
    p.points = p.points.map(pt=>({
      x: pt.x + (Math.random()-0.5)*2,
      y: pt.y + (Math.random()-0.5)*2
    }));
  });
  draw();
}

/* ================= 姿勢儲存 ================= */
function savePose(){
  localStorage.setItem('pose',JSON.stringify({joints,bones}));
  alert('姿勢已存');
}
function loadPose(){
  const d=localStorage.getItem('pose');
  if(!d)return;
  const o=JSON.parse(d);
  joints=o.joints; bones=o.bones;
  draw();
}

/* ================= SVG 匯出 ================= */
function exportSVG(){
  let paths='';
  skinPaths.forEach(p=>{
    let d=`M ${p.points[0].x} ${p.points[0].y}`;
    for(let i=1;i<p.points.length;i++){
      d+=` L ${p.points[i].x} ${p.points[i].y}`;
    }
    d+=' Z';
    paths+=`<path d="${d}" fill="none" stroke="black" stroke-width="2"/>`;
  });
  const svg=
`<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">
${paths}
</svg>`;
  download(svg,'sketch.svg');
}
function download(t,n){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([t],{type:'image/svg+xml'}));
  a.download=n; a.click();
}

/* ================= 繪製 ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // bones
  ctx.strokeStyle='#888';
  ctx.lineWidth=2;
  bones.forEach(b=>{
    const a=joints[b[0]], c=joints[b[1]];
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.lineTo(c.x,c.y);
    ctx.stroke();
  });

  // joints
  joints.forEach(j=>{
    ctx.fillStyle='#000';
    ctx.beginPath();
    ctx.arc(j.x,j.y,j.r,0,Math.PI*2);
    ctx.fill();
  });

  // skin
  ctx.strokeStyle='#000';
  ctx.lineWidth=2;
  skinPaths.forEach(p=>{
    ctx.beginPath();
    p.points.forEach((pt,i)=>{
      if(i===0)ctx.moveTo(pt.x,pt.y);
      else ctx.lineTo(pt.x,pt.y);
    });
    ctx.closePath();
    ctx.stroke();
  });
}
draw();
</script>
</body>
</html>
