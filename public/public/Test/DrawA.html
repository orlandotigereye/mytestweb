<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é»ƒé‡‘ AI ç°¡ç­†è‰åœ–å·¥ä½œç«™</title>
    <!-- æ ¸å¿ƒç¹ªåœ–èˆ‡æ‹–æ›³åº« -->
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.1.2/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.draggable.js@3.0.2/dist/svg.draggable.min.js"></script>
    <!-- åœ–åƒè½‰æ›åº« (UMDç‰ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.js"></script>
    <style>
        :root {
            --gold-primary: #ffd700;
            --gold-light: #fff3b0;
            --gold-dark: #b8860b;
            --text-size: 0.5rem;
            --bg-pattern: url('https://www.transparenttextures.com/patterns/gold-glitter.png');
        }

        * {
            box-sizing: border-box;
            font-size: var(--text-size);
            font-family: "Microsoft JhengHei", sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 5px;
            background: var(--gold-dark) var(--bg-pattern) fixed;
            color: #333;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        .main-card {
            width: 100%;
            max-width: 600px;
            height: 98vh;
            background: linear-gradient(135deg, #fff9e6 0%, #ffeb99 100%);
            border: 4px ridge var(--gold-primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 2px;
            border-bottom: 2px solid var(--gold-primary);
            margin-bottom: 4px;
        }

        .header h1 {
            margin: 0;
            font-size: 0.7rem;
            color: #7a5d00;
            text-shadow: 1px 1px 0px white;
        }

        /* åˆ†é  */
        .tabs {
            display: flex;
            margin-bottom: 4px;
            background: rgba(184, 134, 11, 0.2);
            border-radius: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 3px 1px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #555;
            transition: 0.2s;
        }

        .tab-btn.active {
            background: var(--gold-primary);
            color: #000;
            font-weight: bold;
            border-radius: 4px;
        }

        .tab-content {
            display: none;
            padding: 2px;
            background: rgba(255,255,255,0.4);
            border-radius: 4px;
            margin-bottom: 2px;
            border: 1px inset var(--gold-primary);
        }

        .tab-content.active { display: block; }

        /* å·¥å…·åˆ— */
        .toolbar {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
        }

        .tool-btn {
            background: linear-gradient(to bottom, #fff, #ffd700);
            border: 1px solid var(--gold-dark);
            border-radius: 3px;
            padding: 2px 0;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 26px;
        }

        .tool-btn span { font-size: 0.5rem; transform: scale(0.95); }

        .tool-btn.selected {
            background: #ff4500 !important;
            color: white !important;
            border-color: #8b0000;
        }

        /* ç•«å¸ƒ */
        #viewport {
            flex: 1;
            width: 100%;
            background: white;
            border: 2px double var(--gold-dark);
            border-radius: 4px;
            position: relative;
            touch-action: none;
            overflow: hidden;
            cursor: crosshair;
        }

        #canvas-inner { width: 100%; height: 100%; }

        /* ç‹€æ…‹åˆ— */
        .status-msg {
            background: white;
            border-radius: 8px;
            padding: 2px 6px;
            margin: 2px 0;
            border: 1px solid var(--gold-primary);
            text-align: center;
            font-weight: bold;
            min-height: 1.2rem;
            white-space: normal;
            word-break: break-all;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å­˜æª”åˆ—è¡¨ */
        .archive-list {
            max-height: 120px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .archive-item {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 2px;
            border-radius: 3px;
            border: 1px solid var(--gold-primary);
            gap: 4px;
        }

        /* Loading */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--gold-dark);
            font-weight: bold;
            flex-direction: column;
        }

        .line-counter {
            position: absolute;
            bottom: 4px; right: 8px; color: #7a5d00; font-size: 0.5rem; pointer-events: none;
        }

        input, textarea { 
            width: 100%; padding: 3px; border: 1px solid var(--gold-dark); border-radius: 3px; background: #fff;
        }

        .source-btn {
            position: absolute;
            top: 2px; right: 4px; background: #000; color: #ffd700; padding: 1px 4px; border-radius: 3px; text-decoration: none; z-index: 100; font-size: 0.5rem;
        }
    </style>
</head>
<body>

<div class="main-card">
    <a href="javascript:void(0)" class="source-btn" onclick="downloadCode()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼</a>
    
    <div class="header">
        <h1>ğŸ† é»ƒé‡‘ AI ç°¡ç­†è‰åœ–å·¥ä½œç«™</h1>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="setTab(0)">ğŸ¨ ç¹ªè£½</button>
        <button class="tab-btn" onclick="setTab(1)">ğŸ“ ç­†è§¸</button>
        <button class="tab-btn" onclick="setTab(2)">ğŸª„ AI ç”Ÿæˆ</button>
        <button class="tab-btn" onclick="setTab(3)">ğŸ“¦ çè—åº«</button>
    </div>

    <!-- ç¹ªåœ–å·¥å…· -->
    <div id="tab-0" class="tab-content active">
        <div class="toolbar">
            <div id="btn-draw" class="tool-btn selected" onclick="setTool('draw')"><span>ğŸ–‹ï¸ æ‰‹ç¹ª</span></div>
            <div id="btn-move" class="tool-btn" onclick="setTool('move')"><span>ğŸ–ï¸ ç§»å‹•</span></div>
            <div class="tool-btn" onclick="undo()"><span>â†©ï¸ ä¸Šä¸€æ­¥</span></div>
            <div class="tool-btn" onclick="cloneSelected()"><span>ğŸ‘¯ è¤‡è£½</span></div>
            <div class="tool-btn" onclick="mirrorSelected()"><span>â†”ï¸ ç¿»è½‰</span></div>
            <div class="tool-btn" onclick="setTool('erase')"><span>ğŸ§½ æ©¡çš®</span></div>
        </div>
        <div class="toolbar" style="margin-top:2px;">
            <div class="tool-btn" onclick="clearCanvas()"><span>ğŸš« æ¸…ç©º</span></div>
            <div class="tool-btn" onclick="saveToArchive()"><span>ğŸ’¾ å­˜æª”</span></div>
            <div class="tool-btn" onclick="exportImg()"><span>ğŸ“¤ åŒ¯å‡º</span></div>
        </div>
    </div>

    <!-- ç­†è§¸è¨­å®š -->
    <div id="tab-1" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 3fr; gap:4px; align-items:center;">
            <span>ç­†è‰²:</span><input type="color" id="colorPicker" value="#000000">
            <span>ç²—ç´°:</span><input type="range" id="sizeSlider" min="1" max="20" value="2">
            <span>é€æ˜:</span><input type="range" id="opacitySlider" min="1" max="10" value="10" oninput="adjustOpacity(this.value)">
        </div>
        <p style="margin:2px 0; color:#666; font-size:0.5rem;">* é€æ˜åº¦å½±éŸ¿é¸ä¸­ç‰©ä»¶ï¼Œæ–¹ä¾¿æåœ–ã€‚</p>
    </div>

    <!-- AI ç”Ÿæˆ -->
    <div id="tab-2" class="tab-content">
        <div style="display:flex; flex-direction:column; gap:3px;">
            <textarea id="aiPrompt" rows="1" placeholder="ç•™ç©ºå‰‡ä¾ç•«ç”Ÿæˆï¼Œæˆ–è¼¸å…¥æŒ‡ä»¤ä¿®æ”¹..."></textarea>
            <div class="toolbar" style="grid-template-columns: 1fr 1fr;">
                <button class="tool-btn" onclick="generateFromCanvas()">ğŸ–¼ï¸ ä¾ç•«åœ–ç”Ÿæˆ (ç™½åº•ç°¡ç­†)</button>
                <button class="tool-btn" onclick="generateAISketch()">âœ¨ æ–‡ç”Ÿç°¡ç­†åœ–</button>
            </div>
            <div id="ai-preview-panel" style="display:none; text-align:center; padding:3px; border:1px dashed var(--gold-primary); background:#fff; border-radius:4px;">
                <img id="ai-preview-img" style="max-height:100px; border:1px solid #ccc;">
                <div style="display:flex; gap:2px; margin-top:2px;">
                    <button class="tool-btn" style="flex:1" onclick="applyPreviewToCanvas()">ğŸ“¥ è¼‰å…¥ç•«å¸ƒ</button>
                    <button class="tool-btn" style="flex:1" onclick="saveToArchiveFromAI()">ğŸ“¦ å­˜å…¥çè—</button>
                    <button class="tool-btn" style="flex:0.2" onclick="closePreview()">âŒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- çè—åº« -->
    <div id="tab-3" class="tab-content">
        <div id="archive-list" class="archive-list"></div>
        <button class="tool-btn" style="width:100%; color:red; margin-top:4px; border-color:red;" onclick="clearArchive()">ğŸ”¥ æ¸…ç©ºæœ¬æ©Ÿç´€éŒ„</button>
    </div>

    <div id="status" class="status-msg">ç³»çµ±å°±ç·’ã€‚</div>

    <div id="viewport">
        <div id="loading-overlay">
            <div style="font-size:1rem;">âœ¨</div>
            <span>AI é‹ç®—ä¸­ï¼Œè«‹ç¨å€™...</span>
        </div>
        <div id="canvas-inner"></div>
    </div>

    <div id="line-info" class="line-counter">Lines: 0</div>
</div>

<script>
    const apiKey = ""; // ç³»çµ±è‡ªå‹•æ³¨å…¥
    const V_W = 800, V_H = 1000, STORAGE_KEY = "SIMPLE_SKETCH_V3";
    let mainDraw, toolMode = 'draw', isMouseDown = false, activeStroke = null, sceneObjects = [], selectedElement = null;
    let undoStack = [], lastGeneratedB64 = "";

    window.onload = () => {
        mainDraw = SVG().addTo('#canvas-inner').viewbox(0, 0, V_W, V_H).size('100%', '100%');
        initInteraction();
        renderArchive();
        updateLineCount();
    };

    function updateLineCount() {
        const lines = document.documentElement.outerHTML.split('\n').length;
        document.getElementById('line-info').innerText = `Lines: ${lines}`;
    }

    // --- æŒ‡æ•¸é€€é¿è«‹æ±‚æ©Ÿåˆ¶ ---
    async function fetchWithRetry(url, options, maxRetries = 5) {
        let delay = 1000;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) return await response.json();
                if (response.status >= 500 || response.status === 429) {
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                    continue;
                }
                const errData = await response.json();
                throw new Error(errData.error?.message || `HTTP ${response.status}`);
            } catch (err) {
                if (i === maxRetries - 1) throw err;
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }
    }

    // --- æ’¤éŠ·ç³»çµ± ---
    function pushUndo() {
        undoStack.push(mainDraw.svg());
        if(undoStack.length > 30) undoStack.shift();
    }

    function undo() {
        if(undoStack.length > 0) {
            const last = undoStack.pop();
            mainDraw.clear();
            mainDraw.svg(last);
            sceneObjects = Array.from(mainDraw.children());
            refreshEventHandlers();
            msg("å·²å¾©åŸã€‚");
        } else {
            msg("ç„¡æ›´å¤šç´€éŒ„ã€‚");
        }
    }

    function setTab(i) {
        document.querySelectorAll('.tab-btn').forEach((b,idx)=>b.classList.toggle('active', idx===i));
        document.querySelectorAll('.tab-content').forEach((c,idx)=>c.classList.toggle('active', idx===i));
    }

    function msg(m) { document.getElementById('status').innerText = m; }

    function setTool(t) {
        toolMode = t;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('selected'));
        if(document.getElementById('btn-' + t)) document.getElementById('btn-' + t).classList.add('selected');
        refreshEventHandlers();
    }

    function refreshEventHandlers() {
        const isMove = (toolMode === 'move');
        sceneObjects.forEach(obj => {
            if (obj && typeof obj.draggable === 'function') {
                obj.draggable(isMove);
                if(isMove) {
                    obj.off('click').on('click', function(e) { e.stopPropagation(); selectElement(this); });
                } else {
                    obj.off('click');
                }
            }
        });
    }

    function selectElement(el) {
        if(selectedElement) selectedElement.attr('stroke-dasharray', null);
        selectedElement = el;
        selectedElement.attr('stroke-dasharray', '8,4');
        msg("ç‰©ä»¶å·²é¸å–ã€‚");
    }

    function cloneSelected() {
        if(!selectedElement) { msg("è«‹å…ˆé¸å–ç‰©ä»¶ã€‚"); return; }
        pushUndo();
        const clone = selectedElement.clone();
        clone.move(selectedElement.x() + 20, selectedElement.y() + 20);
        mainDraw.add(clone);
        sceneObjects.push(clone);
        refreshEventHandlers();
        selectElement(clone);
        msg("ç‰©ä»¶å·²è¤‡è£½ã€‚");
    }

    function mirrorSelected() {
        if(!selectedElement) return;
        pushUndo();
        const box = selectedElement.bbox();
        selectedElement.transform({ flip: 'x', origin: [box.cx, box.cy] }, true);
        msg("ç‰©ä»¶å·²æ°´å¹³ç¿»è½‰ã€‚");
    }

    function adjustOpacity(val) {
        if(selectedElement) selectedElement.opacity(val / 10);
    }

    // --- ç¹ªåœ–äº’å‹• ---
    function initInteraction() {
        const viewport = document.getElementById('viewport');
        const getXY = (e) => {
            const r = viewport.getBoundingClientRect();
            const cx = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
            const cy = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
            return { x: (cx - r.left) * (V_W / r.width), y: (cy - r.top) * (V_H / r.height) };
        };

        const onStart = (e) => {
            if(toolMode === 'move') return;
            pushUndo();
            isMouseDown = true;
            const p = getXY(e);
            if (toolMode === 'draw') {
                const color = document.getElementById('colorPicker').value;
                const width = document.getElementById('sizeSlider').value;
                activeStroke = mainDraw.path(`M ${p.x} ${p.y}`).fill('none').stroke({ color, width, linecap: 'round', linejoin: 'round' });
                sceneObjects.push(activeStroke);
            }
        };

        const onMove = (e) => {
            if(!isMouseDown || toolMode !== 'draw' || !activeStroke) return;
            e.preventDefault();
            const p = getXY(e);
            const arr = activeStroke.array();
            const lastPt = arr[arr.length - 1];
            if (Math.hypot(p.x - lastPt[1], p.y - lastPt[2]) > 3) { 
                arr.push(['L', p.x, p.y]);
                activeStroke.plot(arr);
            }
        };

        const onEnd = () => { isMouseDown = false; activeStroke = null; updateLineCount(); };

        viewport.addEventListener('mousedown', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        viewport.addEventListener('touchstart', onStart, {passive:false});
        window.addEventListener('touchmove', onMove, {passive:false});
        window.addEventListener('touchend', onEnd);
    }

    // --- AI ç”Ÿæˆ æ ¸å¿ƒåŠŸèƒ½ ---
    async function generateAISketch() {
        const userPrompt = document.getElementById('aiPrompt').value || "a cute animal";
        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';
        msg("æ–‡ç”Ÿåœ–è«‹æ±‚ä¸­...");
        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instances: [{ prompt: `Minimalist simple line art, rough hand-drawn sketch, black lines, pure white background, no shading, no colors, high contrast, ${userPrompt}` }],
                    parameters: { sampleCount: 1 }
                })
            });
            if(data.predictions && data.predictions[0]) {
                lastGeneratedB64 = data.predictions[0].bytesBase64Encoded;
                showPreview(`data:image/png;base64,${lastGeneratedB64}`);
                msg("ç”ŸæˆæˆåŠŸï¼");
            } else { throw new Error("AI å›å‚³æ ¼å¼ä¸æ­£ç¢º"); }
        } catch (e) { 
            msg(`ç”Ÿæˆå¤±æ•—: ${e.message}`); 
        } finally { loading.style.display = 'none'; }
    }

    async function generateFromCanvas() {
        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';
        msg("è§£æç•«å¸ƒä¸¦æäº¤ AI...");
        try {
            const svgStr = mainDraw.svg();
            const canvas = document.createElement('canvas');
            canvas.width = V_W; canvas.height = V_H;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, V_W, V_H);
            
            const v = await canvg.Canvg.fromString(ctx, svgStr);
            await v.render();
            const b64 = canvas.toDataURL('image/png').split(',')[1];

            let userPrompt = document.getElementById('aiPrompt').value;
            let finalPrompt = userPrompt 
                ? `Redraw this sketch based on instruction: "${userPrompt}". Style: Minimalist simple line art, black lines, PURE WHITE BACKGROUND. NO DARK BACKGROUND.`
                : `Refine this sketch into clean minimalist line art. Output: black lines, pure white background, simple hand-drawn style. No textures.`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: finalPrompt }, { inlineData: { mimeType: "image/png", data: b64 } }] }],
                    generationConfig: { responseModalities: ['IMAGE'] }
                })
            });
            const resultPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
            if(resultPart) {
                lastGeneratedB64 = resultPart.inlineData.data;
                showPreview(`data:image/png;base64,${lastGeneratedB64}`);
                msg("ä¾åœ–ç”Ÿæˆå®Œç•¢ã€‚");
            } else { throw new Error("AI ç„¡æ³•è­˜åˆ¥å…§å®¹"); }
        } catch (e) { 
            msg(`è™•ç†å¤±æ•—: ${e.message}`); 
        } finally { loading.style.display = 'none'; }
    }

    function showPreview(src) {
        document.getElementById('ai-preview-img').src = src;
        document.getElementById('ai-preview-panel').style.display = 'block';
    }

    function applyPreviewToCanvas() {
        if(!lastGeneratedB64) return;
        pushUndo();
        const img = mainDraw.image(`data:image/png;base64,${lastGeneratedB64}`).size(500, 500).center(V_W/2, V_H/2);
        sceneObjects.push(img);
        refreshEventHandlers();
        closePreview();
        setTool('move');
        selectElement(img);
        msg("å·²åŒ¯å…¥ç•«å¸ƒã€‚");
    }

    function saveToArchiveFromAI() {
        if(!lastGeneratedB64) return;
        const tempDraw = SVG().size(V_W, V_H);
        tempDraw.image(`data:image/png;base64,${lastGeneratedB64}`).size(500, 500).center(V_W/2, V_H/2);
        saveData(tempDraw.svg(), "AI ç”Ÿæˆè‰åœ–");
        closePreview();
    }

    function closePreview() { document.getElementById('ai-preview-panel').style.display = 'none'; }

    // --- å­˜æª”èˆ‡ç®¡ç† ---
    function saveToArchive() { saveData(mainDraw.svg(), "æ‰‹ç¹ªä½œå“"); }

    function saveData(svg, label) {
        const archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        archives.unshift({ id: Date.now(), svg: svg, label: label, time: new Date().toLocaleTimeString() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(archives.slice(0, 30)));
        renderArchive();
        msg(`ã€Œ${label}ã€å·²å­˜å…¥çè—åº«ã€‚`);
    }

    function renderArchive() {
        const list = document.getElementById('archive-list');
        const archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        list.innerHTML = archives.length === 0 ? "<div style='text-align:center; color:#888;'>æš«ç„¡å­˜æª”</div>" : "";
        archives.forEach(item => {
            const div = document.createElement('div');
            div.className = "archive-item";
            div.innerHTML = `
                <div style="flex:1;"><b>${item.label}</b> <span style="color:#666;">${item.time}</span></div>
                <div>
                    <button class="tool-btn" style="min-height:auto; padding:2px 6px;" onclick="loadArchive(${item.id})">è¼‰å…¥</button>
                    <button class="tool-btn" style="min-height:auto; padding:2px 6px; border-color:red; color:red;" onclick="deleteArchive(${item.id})">åˆªé™¤</button>
                </div>`;
            list.appendChild(div);
        });
    }

    function loadArchive(id) {
        const archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        const item = archives.find(a => a.id === id);
        if(item) { 
            pushUndo(); mainDraw.clear(); mainDraw.svg(item.svg); 
            sceneObjects = Array.from(mainDraw.children()); 
            refreshEventHandlers();
            msg("å­˜æª”è¼‰å…¥æˆåŠŸã€‚"); 
            setTool('move'); 
        }
    }

    function deleteArchive(id) {
        let archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        archives = archives.filter(a => a.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(archives));
        renderArchive();
    }

    function clearArchive() { 
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) {
            localStorage.removeItem(STORAGE_KEY); 
            renderArchive(); 
            msg("çè—åº«å·²æ¸…ç©ºã€‚"); 
        }
    }

    function clearCanvas() { 
        if(confirm("ç¢ºå®šæ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")) { 
            pushUndo(); 
            mainDraw.clear(); 
            sceneObjects = []; 
            selectedElement = null; 
            msg("ç•«å¸ƒå·²æ¸…ç©ºã€‚"); 
            updateLineCount();
        }
    }

    function exportImg() {
        const svgStr = mainDraw.svg();
        const canvas = document.createElement('canvas'); canvas.width = V_W; canvas.height = V_H;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = () => {
            ctx.fillStyle = 'white'; ctx.fillRect(0,0,V_W,V_H); ctx.drawImage(img, 0, 0);
            const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = 'sketch_export.png'; a.click();
        };
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgStr)));
    }

    function downloadCode() {
        const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'golden_ai_sketch.html'; a.click();
    }
</script>
</body>
</html>

