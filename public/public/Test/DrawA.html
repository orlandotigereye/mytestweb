<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é»ƒé‡‘ AI ç°¡ç­†è‰åœ–å·¥ä½œç«™</title>
    <!-- å¤–éƒ¨é…ç½®è¼‰å…¥ -->
    <script src="https://orlandotigereye.github.io/mytestweb/config/api.js" id="api-config"></script>
    <!-- æ ¸å¿ƒç¹ªåœ–èˆ‡æ‹–æ›³åº« -->
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.1.2/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.draggable.js@3.0.2/dist/svg.draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.js"></script>
    <style>
        :root {
            --gold-primary: #ffd700;
            --gold-light: #fff3b0;
            --gold-dark: #b8860b;
            --text-size: 0.5rem;
            --bg-pattern: url('https://www.transparenttextures.com/patterns/gold-glitter.png');
        }

        * {
            box-sizing: border-box;
            font-size: var(--text-size);
            font-family: "Microsoft JhengHei", sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 5px;
            background: var(--gold-dark) var(--bg-pattern) fixed;
            color: #333;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        .main-card {
            width: 100%;
            max-width: 600px;
            height: 98vh;
            background: linear-gradient(135deg, #fff9e6 0%, #ffeb99 100%);
            border: 4px ridge var(--gold-primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 2px;
            border-bottom: 2px solid var(--gold-primary);
            margin-bottom: 4px;
        }

        .header h1 {
            margin: 0;
            font-size: 0.7rem;
            color: #7a5d00;
            text-shadow: 1px 1px 0px white;
        }

        .tabs {
            display: flex;
            margin-bottom: 4px;
            background: rgba(184, 134, 11, 0.2);
            border-radius: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 4px 1px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #555;
            transition: 0.2s;
        }

        .tab-btn.active {
            background: var(--gold-primary);
            color: #000;
            font-weight: bold;
            border-radius: 4px;
        }

        .tab-content {
            display: none;
            padding: 2px;
            background: rgba(255,255,255,0.4);
            border-radius: 4px;
            margin-bottom: 2px;
            border: 1px inset var(--gold-primary);
        }

        .tab-content.active { display: block; }

        .toolbar {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
        }

        .tool-btn {
            background: linear-gradient(to bottom, #fff, #ffd700);
            border: 1px solid var(--gold-dark);
            border-radius: 3px;
            padding: 2px 0;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 28px;
        }

        .tool-btn span { font-size: 0.5rem; transform: scale(0.95); }

        .tool-btn.selected {
            background: #ff4500 !important;
            color: white !important;
            border-color: #8b0000;
        }

        #viewport {
            flex: 1;
            width: 100%;
            background: white;
            border: 2px double var(--gold-dark);
            border-radius: 4px;
            position: relative;
            touch-action: none;
            overflow: hidden;
            cursor: crosshair;
        }

        #canvas-inner { width: 100%; height: 100%; }

        .status-msg {
            background: white;
            border-radius: 8px;
            padding: 2px 6px;
            margin: 2px 0;
            border: 1px solid var(--gold-primary);
            text-align: center;
            font-weight: bold;
            min-height: 1.2rem;
            white-space: normal;
            word-break: break-all;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .archive-list {
            max-height: 120px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .archive-item {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 2px;
            border-radius: 3px;
            border: 1px solid var(--gold-primary);
            gap: 4px;
        }

        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--gold-dark);
            font-weight: bold;
            flex-direction: column;
        }

        .line-counter {
            position: absolute;
            bottom: 4px; right: 8px; color: #7a5d00; font-size: 0.5rem; pointer-events: none;
        }

        input, textarea { 
            width: 100%; padding: 3px; border: 1px solid var(--gold-dark); border-radius: 3px; background: #fff;
        }

        .source-btn {
            position: absolute;
            top: 2px; right: 4px; background: #000; color: #ffd700; padding: 1px 4px; border-radius: 3px; text-decoration: none; z-index: 100; font-size: 0.5rem;
        }
    </style>
</head>
<body>

<div class="main-card">
    <a href="javascript:void(0)" class="source-btn" onclick="downloadCode()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼</a>
    
    <div class="header">
        <h1>ğŸ† é»ƒé‡‘ AI ç°¡ç­†è‰åœ–å·¥ä½œç«™</h1>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="setTab(0)">ğŸ¨ ç¹ªè£½</button>
        <button class="tab-btn" onclick="setTab(1)">ğŸ“ ç­†è§¸</button>
        <button class="tab-btn" onclick="setTab(2)">ğŸª„ AI ç”Ÿæˆ</button>
        <button class="tab-btn" onclick="setTab(3)">ğŸ“¦ çè—åº«</button>
    </div>

    <div id="tab-0" class="tab-content active">
        <div class="toolbar">
            <div id="btn-draw" class="tool-btn selected" onclick="setTool('draw')"><span>ğŸ–‹ï¸ æ‰‹ç¹ª</span></div>
            <div id="btn-move" class="tool-btn" onclick="setTool('move')"><span>ğŸ–ï¸ ç§»å‹•</span></div>
            <div class="tool-btn" onclick="undo()"><span>â†©ï¸ ä¸Šä¸€æ­¥</span></div>
            <div class="tool-btn" onclick="cloneSelected()"><span>ğŸ‘¯ è¤‡è£½</span></div>
            <div class="tool-btn" onclick="mirrorSelected()"><span>â†”ï¸ ç¿»è½‰</span></div>
            <div class="tool-btn" onclick="setTool('erase')"><span>ğŸ§½ æ©¡çš®</span></div>
        </div>
        <div class="toolbar" style="margin-top:2px;">
            <div class="tool-btn" onclick="clearCanvas()"><span>ğŸš« æ¸…ç©º</span></div>
            <div class="tool-btn" onclick="saveToArchive()"><span>ğŸ’¾ å­˜æª”</span></div>
            <div class="tool-btn" onclick="exportImg()"><span>ğŸ“¤ åŒ¯å‡º</span></div>
        </div>
    </div>

    <div id="tab-1" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 3fr; gap:4px; align-items:center;">
            <span>ç­†è‰²:</span><input type="color" id="colorPicker" value="#000000">
            <span>ç²—ç´°:</span><input type="range" id="sizeSlider" min="1" max="20" value="2">
            <span>é€æ˜:</span><input type="range" id="opacitySlider" min="1" max="10" value="10" oninput="adjustOpacity(this.value)">
        </div>
    </div>

    <div id="tab-2" class="tab-content">
        <div style="display:flex; flex-direction:column; gap:3px;">
            <textarea id="aiPrompt" rows="1" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šè®Šè²“å’ªã€ç•«ä¸€æœµèŠ±..."></textarea>
            <div class="toolbar" style="grid-template-columns: 1fr 1fr;">
                <button class="tool-btn" onclick="generateFromCanvas()">ğŸ–¼ï¸ ä¾ç•«åœ–ç”Ÿæˆ</button>
                <button class="tool-btn" onclick="generateAISketch()">âœ¨ æ–‡ç”Ÿç°¡ç­†åœ–</button>
            </div>
            <div id="ai-preview-panel" style="display:none; text-align:center; padding:3px; border:1px dashed var(--gold-primary); background:#fff; border-radius:4px;">
                <img id="ai-preview-img" style="max-height:100px; border:1px solid #ccc;">
                <div style="display:flex; gap:2px; margin-top:2px;">
                    <button class="tool-btn" style="flex:1" onclick="applyPreviewToCanvas()">ğŸ“¥ è¼‰å…¥ç•«å¸ƒ</button>
                    <button class="tool-btn" style="flex:0.2" onclick="closePreview()">âŒ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-3" class="tab-content">
        <div id="archive-list" class="archive-list"></div>
        <button class="tool-btn" style="width:100%; color:red; margin-top:4px; border-color:red;" onclick="clearArchive()">ğŸ”¥ æ¸…ç©ºç´€éŒ„</button>
    </div>

    <div id="status" class="status-msg">ç­‰å¾… API é…ç½®åŠ è¼‰ä¸­...</div>

    <div id="viewport">
        <div id="loading-overlay"><div style="font-size:1rem;">âœ¨</div><span>é‹ç®—ä¸­...</span></div>
        <div id="canvas-inner"></div>
    </div>

    <div id="line-info" class="line-counter">Lines: 0</div>
</div>

<script>
    let dynamicApiKey = "";
    
    // 16ä½å…ƒè§£ç¢¼
    function hexDecode(hex) {
        if (!hex) return "";
        let str = '';
        for (let i = 0; i < hex.length; i += 2) {
            str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
        }
        return str;
    }

    // å¼·åŒ–ç‰ˆé‡‘é‘°è®€å–ï¼šç›£è½è…³æœ¬åŠ è¼‰
    function loadAndInitKey() {
        const checkConfig = () => {
            if (typeof config !== 'undefined' && config.apiKey) {
                dynamicApiKey = hexDecode(config.apiKey);
                msg("ç³»çµ±å°±ç·’ (é‡‘é‘°å·²ç²å–)ã€‚");
                return true;
            }
            return false;
        };

        if (!checkConfig()) {
            const script = document.getElementById('api-config');
            script.onload = checkConfig;
            // é›™é‡æª¢æŸ¥
            setTimeout(() => { if(!dynamicApiKey) checkConfig(); }, 2000);
        }
    }

    const V_W = 800, V_H = 1000, STORAGE_KEY = "GOLD_SKETCH_V4";
    let mainDraw, toolMode = 'draw', isMouseDown = false, activeStroke = null, sceneObjects = [], selectedElement = null;
    let undoStack = [], lastGeneratedB64 = "";

    window.onload = () => {
        mainDraw = SVG().addTo('#canvas-inner').viewbox(0, 0, V_W, V_H).size('100%', '100%');
        loadAndInitKey();
        initInteraction();
        renderArchive();
        updateLineCount();
    };

    function updateLineCount() {
        const lines = document.documentElement.outerHTML.split('\n').length;
        document.getElementById('line-info').innerText = `Lines: ${lines}`;
    }

    async function fetchWithRetry(url, options, maxRetries = 5) {
        let delay = 1000;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) return await response.json();
                if (response.status === 429 || response.status >= 500) {
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; continue;
                }
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `HTTP ${response.status}`);
            } catch (err) {
                if (i === maxRetries - 1) throw err;
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }
    }

    function pushUndo() {
        undoStack.push(mainDraw.svg());
        if(undoStack.length > 30) undoStack.shift();
    }

    function undo() {
        if(undoStack.length > 0) {
            mainDraw.clear().svg(undoStack.pop());
            sceneObjects = Array.from(mainDraw.children());
            refreshEventHandlers();
            msg("å·²æ’¤éŠ·ã€‚");
        } else msg("ç„¡ç´€éŒ„ã€‚");
    }

    function setTab(i) {
        document.querySelectorAll('.tab-btn').forEach((b,idx)=>b.classList.toggle('active', idx===i));
        document.querySelectorAll('.tab-content').forEach((c,idx)=>c.classList.toggle('active', idx===i));
    }

    function msg(m) { document.getElementById('status').innerText = m; }

    function setTool(t) {
        toolMode = t;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('selected'));
        if(document.getElementById('btn-' + t)) document.getElementById('btn-' + t).classList.add('selected');
        refreshEventHandlers();
    }

    function refreshEventHandlers() {
        const isMove = (toolMode === 'move');
        sceneObjects.forEach(obj => {
            if (obj && obj.draggable) {
                obj.draggable(isMove);
                if(isMove) obj.off('click').on('click', function(e) { e.stopPropagation(); selectElement(this); });
                else obj.off('click');
            }
        });
    }

    function selectElement(el) {
        if(selectedElement) selectedElement.attr('stroke-dasharray', null);
        selectedElement = el;
        selectedElement.attr('stroke-dasharray', '8,4');
    }

    function cloneSelected() {
        if(!selectedElement) return;
        pushUndo();
        const c = selectedElement.clone().move(selectedElement.x()+10, selectedElement.y()+10);
        sceneObjects.push(c); refreshEventHandlers(); selectElement(c);
    }

    function mirrorSelected() {
        if(!selectedElement) return;
        pushUndo();
        const b = selectedElement.bbox();
        selectedElement.transform({ flip: 'x', origin: [b.cx, b.cy] }, true);
    }

    function adjustOpacity(v) { if(selectedElement) selectedElement.opacity(v/10); }

    function initInteraction() {
        const vp = document.getElementById('viewport');
        const getXY = (e) => {
            const r = vp.getBoundingClientRect();
            const cx = (e.touches?.[0]) ? e.touches[0].clientX : e.clientX;
            const cy = (e.touches?.[0]) ? e.touches[0].clientY : e.clientY;
            return { x: (cx-r.left)*(V_W/r.width), y: (cy-r.top)*(V_H/r.height) };
        };
        const start = (e) => {
            if(toolMode==='move') return;
            pushUndo(); isMouseDown=true; const p=getXY(e);
            if(toolMode==='draw'){
                activeStroke = mainDraw.path(`M ${p.x} ${p.y}`).fill('none').stroke({ 
                    color: document.getElementById('colorPicker').value, 
                    width: document.getElementById('sizeSlider').value, 
                    linecap: 'round', linejoin: 'round' 
                });
                sceneObjects.push(activeStroke);
            }
        };
        const move = (e) => {
            if(!isMouseDown || toolMode!=='draw' || !activeStroke) return;
            e.preventDefault(); const p=getXY(e); const arr=activeStroke.array();
            arr.push(['L', p.x, p.y]); activeStroke.plot(arr);
        };
        const end = () => { isMouseDown=false; activeStroke=null; updateLineCount(); };
        vp.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        vp.addEventListener('touchstart', start, {passive:false}); window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    }

    async function generateAISketch() {
        if(!dynamicApiKey) { msg("é‡‘é‘°æœªå°±ç·’ã€‚"); return; }
        const load = document.getElementById('loading-overlay'); load.style.display='flex';
        try {
            const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${dynamicApiKey}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    instances:[{ prompt: `Minimalist simple black line art sketch, white background, ${document.getElementById('aiPrompt').value || 'a cat'}` }],
                    parameters:{ sampleCount:1 }
                })
            });
            if(data.predictions?.[0]){
                lastGeneratedB64 = data.predictions[0].bytesBase64Encoded;
                showPreview(`data:image/png;base64,${lastGeneratedB64}`);
            }
        } catch(e) { msg(e.message); } finally { load.style.display='none'; }
    }

    async function generateFromCanvas() {
        if(!dynamicApiKey) { msg("é‡‘é‘°æœªå°±ç·’ã€‚"); return; }
        const load = document.getElementById('loading-overlay'); load.style.display='flex';
        try {
            const canvas = document.createElement('canvas'); canvas.width=V_W; canvas.height=V_H;
            const ctx = canvas.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,V_W,V_H);
            const v = await canvg.Canvg.fromString(ctx, mainDraw.svg()); await v.render();
            const b64 = canvas.toDataURL('image/png').split(',')[1];
            const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${dynamicApiKey}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    contents:[{ parts:[{text:"Refine this sketch into clean black line art on white background."}, {inlineData:{mimeType:"image/png", data:b64}}] }],
                    generationConfig:{ responseModalities:['IMAGE'] }
                })
            });
            const res = data.candidates?.[0]?.content?.parts?.find(p=>p.inlineData);
            if(res){ lastGeneratedB64=res.inlineData.data; showPreview(`data:image/png;base64,${lastGeneratedB64}`); }
        } catch(e) { msg(e.message); } finally { load.style.display='none'; }
    }

    function showPreview(s){ document.getElementById('ai-preview-img').src=s; document.getElementById('ai-preview-panel').style.display='block'; }
    function closePreview(){ document.getElementById('ai-preview-panel').style.display='none'; }
    function applyPreviewToCanvas(){
        pushUndo(); const i = mainDraw.image(`data:image/png;base64,${lastGeneratedB64}`).size(500,500).center(V_W/2, V_H/2);
        sceneObjects.push(i); refreshEventHandlers(); closePreview(); setTool('move'); selectElement(i);
    }

    function saveToArchive(){
        const a = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
        a.unshift({ id:Date.now(), svg:mainDraw.svg(), time:new Date().toLocaleTimeString() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(a.slice(0,20))); renderArchive();
    }
    function renderArchive(){
        const l = document.getElementById('archive-list'); const a = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
        l.innerHTML = a.length? "" : "ç„¡å­˜æª”";
        a.forEach(i => {
            const d = document.createElement('div'); d.className="archive-item";
            d.innerHTML = `<span>å­˜æª” ${i.time}</span><button onclick="loadArchive(${i.id})">è¼‰å…¥</button>`;
            l.appendChild(d);
        });
    }
    function loadArchive(id){
        const a = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); const i = a.find(x=>x.id===id);
        if(i){ pushUndo(); mainDraw.clear().svg(i.svg); sceneObjects=Array.from(mainDraw.children()); refreshEventHandlers(); }
    }
    function clearArchive(){ localStorage.removeItem(STORAGE_KEY); renderArchive(); }
    function clearCanvas(){ if(confirm("æ¸…ç©ºï¼Ÿ")){ pushUndo(); mainDraw.clear(); sceneObjects=[]; updateLineCount(); } }
    function exportImg(){
        const img = new Image(); img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(mainDraw.svg())));
        img.onload = () => {
            const c = document.createElement('canvas'); c.width=V_W; c.height=V_H;
            const ctx = c.getContext('2d'); ctx.fillStyle='white'; ctx.fillRect(0,0,V_W,V_H); ctx.drawImage(img,0,0);
            const a = document.createElement('a'); a.href=c.toDataURL(); a.download='sketch.png'; a.click();
        };
    }
    function downloadCode(){
        const b = new Blob([document.documentElement.outerHTML], {type:'text/html'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='app.html'; a.click();
    }
</script>
</body>
</html>

