<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>é‡‘è¼å’–å•¡å»³ V19 - å°è©±æ¡†å„ªåŒ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --gold-light: #fef3c7;
            --gold-main: #fbbf24;
            --gold-dark: #b45309;
            --panel-bg: rgba(251, 191, 36, 0.95);
        }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: #451a03;
            color: #451a03;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            overflow: hidden;
            font-size: 0.5rem; /* åš´æ ¼ 0.5rem è¦ç¯„ */
        }
        /* èƒŒæ™¯å±¤ */
        #main-bg-layer {
            position: fixed; inset: 0;
            z-index: -3;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.8s ease;
        }
        .gold-shimmer {
            position: fixed; inset: 0;
            z-index: -2;
            background-image: url('https://www.transparenttextures.com/patterns/gold-glitter.png');
            opacity: 0.2;
            pointer-events: none;
            mix-blend-mode: overlay;
        }
        /* ä»‹é¢æ¡†æ¶ */
        .main-ui {
            display: flex; flex-direction: column; height: 100vh; width: 100vw; position: relative; z-index: 10;
        }
        .ui-header {
            padding: 5px 12px; background: var(--panel-bg);
            border-bottom: 2px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .stage {
            flex: 1; display: flex; width: 100%; height: 100%; overflow: hidden;
            position: relative; align-items: flex-end; justify-content: space-around;
            pointer-events: none;
        }
        iframe { width: 50%; height: 100%; border: none; background: transparent; pointer-events: auto; }
        
        .btn-gold {
            background: linear-gradient(to bottom, #fff, var(--gold-main));
            border: 1px solid var(--gold-dark); padding: 2px 8px; border-radius: 4px;
            color: #451a03; cursor: pointer; font-weight: 900; font-size: 0.5rem;
            box-shadow: 1px 1px 0 #b45309;
        }
        .btn-gold:active { transform: translateY(1px); box-shadow: 0 0 0; }
        
        #console-log {
            font-size: 0.5rem; height: 40px; overflow-y: auto; background: rgba(255, 255, 255, 0.85);
            padding: 4px; color: #451a03; margin-top: 4px; 
            border: 1px inset var(--gold-dark); border-radius: 4px;
        }
        
        #btn-download { 
            position: fixed; right: 10px; bottom: 10px; z-index: 3000; 
            background: #059669; color: white; border: 1px solid #fff; 
            font-size: 0.5rem; padding: 4px 12px; border-radius: 15px; font-weight: bold;
        }
        
        input { 
            background: white; border: 1px solid var(--gold-dark); 
            color: #451a03; font-size: 0.5rem; padding: 2px 6px; border-radius: 4px; 
        }
        
        .status-bar {
            background: rgba(255, 255, 255, 0.5); border-radius: 4px; padding: 2px 8px;
            margin-top: 4px; display: flex; align-items: center; gap: 8px;
        }
        
        #script-display {
            font-weight: bold; color: #78350f; overflow: hidden; text-overflow: ellipsis; 
            white-space: nowrap; flex: 1; font-size: 0.5rem;
        }
    </style>
</head>
<body>

<div id="main-bg-layer"></div>
<div class="gold-shimmer"></div>

<button id="btn-download" onclick="downloadV19()">ğŸ’¾ ä¸‹è¼‰ V19</button>

<div class="main-ui">
    <div class="ui-header">
        <div class="flex justify-between items-center">
            <span class="font-bold text-amber-950" style="font-size: 0.6rem;">âœ¨ é‡‘è¼å’–å•¡å»³ V19 (å°è©±æ¡†é¿è®“å„ªåŒ–)</span>
            <div class="flex gap-1">
                <button class="btn-gold" onclick="startPlay()">å•Ÿå‹•</button>
                <button class="btn-gold" onclick="location.reload()">é‡ç½®</button>
            </div>
        </div>
        
        <div class="flex gap-2 items-center mt-1">
            <span class="font-bold">è©¦ç®—è¡¨:</span>
            <input type="text" id="sheet-id" class="flex-grow" value="15h6v7zh05fbtNfoauduL9OjpzF8pIeMl86JR9Y9aZbU">
            <button class="btn-gold" onclick="document.getElementById('input-bg').click()">ä¸Šå‚³èƒŒæ™¯</button>
            <input type="file" id="input-bg" hidden accept="image/*" onchange="handleFileBg(this)">
        </div>

        <div class="status-bar">
            <span id="play-status" class="font-black text-amber-700">READY</span>
            <div id="script-display">ç­‰å¾…åŠ‡æœ¬æŒ‡ä»¤...</div>
        </div>

        <div class="flex gap-1 mt-1">
            <button class="btn-gold" onclick="changeBg('gold')">é è¨­</button>
            <button class="btn-gold" onclick="changeBg('day')">æ™¨æ›¦</button>
            <button class="btn-gold" onclick="changeBg('dusk')">å¤•é™½</button>
            <button class="btn-gold" onclick="changeBg('night')">éœå¤œ</button>
        </div>

        <div id="console-log">ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚å·²å„ªåŒ–å°è©±æ°£æ³¡é«˜åº¦èˆ‡æ–‡å­—å¤§å°ï¼Œé˜²æ­¢äººç‰©é‡ç–Šã€‚</div>
    </div>

    <div class="stage">
        <iframe id="iframe-left"></iframe>
        <iframe id="iframe-right"></iframe>
    </div>
</div>

<script>
    const logBox = document.getElementById('console-log');
    const bgLayer = document.getElementById('main-bg-layer');

    const THEME_URLS = {
        gold: "https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?q=80&w=2400",
        day: "https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=2400",
        dusk: "https://images.unsplash.com/photo-1511920170033-f8396924c348?q=80&w=2400",
        night: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2400"
    };

    function addLog(msg) {
        const div = document.createElement('div');
        div.innerHTML = `> ${msg}`;
        logBox.prepend(div);
    }

    function changeBg(key) {
        const url = THEME_URLS[key];
        if (url) {
            bgLayer.style.backgroundImage = `url('${url}')`;
            bgLayer.style.backgroundColor = "transparent";
            addLog(`åˆ‡æ›èƒŒæ™¯: ${key}`);
        }
    }

    function handleFileBg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                bgLayer.style.backgroundColor = "transparent";
                addLog("å·²è¼‰å…¥è‡ªå®šç¾©èƒŒæ™¯åœ–ã€‚");
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    const MODELS = [
        { id: "left", url: "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json" },
        { id: "right", url: "https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json" }
    ];

    function getIframeHTML(modelPath, side) {
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"><\/script>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; }
        .bubble {
            position: fixed; 
            top: 5%; /* å‘ä¸Šç§»å‹•ï¼Œé¿é–‹äººç‰© */
            ${side === 'left' ? 'right: 5%;' : 'left: 5%;'}
            background: rgba(255, 255, 255, 0.88); 
            backdrop-filter: blur(4px);
            border: 2px solid #b45309; 
            padding: 8px 12px; 
            border-radius: 12px;
            font-size: 14px; /* å°è©±æ–‡å­—ç¨å°ä¸€é» */
            font-weight: 700; 
            color: #451a03; 
            display: none;
            max-width: 80%; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            line-height: 1.4;
        }
        /* æŒ‡å‘ç®­é ­ */
        .bubble::after {
            content: ''; position: absolute; bottom: -10px;
            ${side === 'left' ? 'right: 15px;' : 'left: 15px;'}
            border-width: 10px 10px 0; border-style: solid;
            border-color: #b45309 transparent transparent;
        }
    </style>
</head>
<body>
    <div class="bubble" id="msg"></div>
    <script>
        window.onload = () => {
            L2Dwidget.init({
                model: { jsonPath: "${modelPath}" },
                display: { 
                    position: "center", 
                    width: window.innerWidth * 0.9, 
                    height: window.innerHeight * 0.9,
                    vOffset: -20 /* ç¨å¾®ä¸‹ç§»äººç‰©ï¼Œå¢åŠ ä¸Šæ–¹ç©ºé–“ */
                },
                mobile: { show: true, scale: 0.5 }
            });
        };
        window.addEventListener('message', e => {
            if (e.data.text) {
                const el = document.getElementById('msg');
                el.innerText = e.data.text; 
                el.style.display = 'block';
                // æ ¹æ“šå­—æ•¸èª¿æ•´é¡¯ç¤ºæ™‚é–“
                setTimeout(() => el.style.display = 'none', Math.max(3000, e.data.text.length * 350));
            }
        });
    <\/script>
</body>
</html>`;
    }

    function initModels() {
        MODELS.forEach(m => {
            const f = document.getElementById(`iframe-${m.id}`);
            const d = f.contentWindow.document;
            d.open(); d.write(getIframeHTML(m.url, m.id)); d.close();
        });
        changeBg('gold');
    }

    let isPlaying = false;
    async function startPlay() {
        if (isPlaying) return;
        isPlaying = true;
        document.getElementById('play-status').innerText = "PLAYING";
        const sid = document.getElementById('sheet-id').value.trim();
        const url = `https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=0&v=${Date.now()}`;
        
        try {
            const res = await fetch(url);
            const csv = await res.text();
            const rows = csv.split(/\r?\n/).filter(r => r.trim()).slice(1);
            
            addLog(`æˆåŠŸç²å– ${rows.length} å¹•åŠ‡æœ¬ã€‚`);

            for (const row of rows) {
                if (!isPlaying) break;
                const cols = row.split(',');
                const role = (cols[0] || "").toLowerCase();
                const text = (cols[1] || "").replace(/"/g, '');
                const bgTag = cols[4] ? cols[4].trim().toLowerCase() : null;

                if (bgTag && THEME_URLS[bgTag]) changeBg(bgTag);
                document.getElementById('script-display').innerText = text;

                const isRight = (role.includes('r') || role.includes('å³') || role.includes('koharu'));
                const target = document.getElementById(isRight ? 'iframe-right' : 'iframe-left');
                
                if (target) target.contentWindow.postMessage({ text }, '*');

                if (window.speechSynthesis) {
                    speechSynthesis.cancel();
                    const msg = new SpeechSynthesisUtterance(text);
                    msg.lang = 'zh-TW';
                    speechSynthesis.speak(msg);
                }

                await new Promise(r => setTimeout(r, Math.max(4500, text.length * 400)));
            }
        } catch (err) {
            addLog("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Sheet ID æ˜¯å¦å…¬é–‹ã€‚");
        }
        
        isPlaying = false;
        document.getElementById('play-status').innerText = "END";
    }

    function downloadV19() {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: "text/html" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "Golden_Cafe_V19.html";
        a.click();
    }

    window.onload = () => setTimeout(initModels, 500);
</script>

</body>
</html>

