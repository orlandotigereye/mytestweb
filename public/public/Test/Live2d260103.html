<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Live2D å’–å•¡å»³é‡‘è¼ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
--gold-light:#fef3c7;
--gold-main:#fbbf24;
--gold-dark:#b45309;
--panel-bg:rgba(251,191,36,.94);
}

html,body{
height:100%;margin:0;
background:#92400e;
font-family:"PingFang TC","Microsoft JhengHei",sans-serif;
overflow:hidden;
font-size:.5rem;
}

/* === èƒŒæ™¯å®¹å™¨ï¼ˆæ”¹ç‚ºå¯åˆ‡æ›ï¼‰ === */
.master-bg{
position:fixed;inset:0;
background-size:cover;
background-position:center;
transition:background-image 1.2s ease, filter .8s ease;
z-index:-1;
filter:brightness(1.1) contrast(1.1);
}

.master-bg::after{
content:"";position:absolute;inset:0;
background-image:url('https://www.transparenttextures.com/patterns/gold-glitter.png');
opacity:.65;
pointer-events:none;
animation:goldShimmer 7s infinite alternate;
}

@keyframes goldShimmer{
from{background-color:rgba(251,191,36,.08)}
to{background-color:rgba(251,191,36,.25)}
}

.main-container{display:flex;flex-direction:column;height:100vh}
.ui-header{padding:4px;background:var(--panel-bg);border-bottom:2px solid #fff;z-index:10}
.stage{flex:1;display:flex;align-items:flex-end;justify-content:space-around}
iframe{width:50%;height:100%;border:none;background:transparent}
.btn{background:linear-gradient(#fff,var(--gold-main));border:1px solid var(--gold-dark);padding:2px 6px;border-radius:4px;font-weight:bold;font-size:.5rem}
#log{height:35px;overflow:auto;background:rgba(255,255,255,.8);padding:2px;border:1px inset var(--gold-dark)}
#btnDownload{position:fixed;right:5px;top:5px;z-index:20;background:#059669;color:#fff;border-radius:15px;font-size:.5rem}
</style>
</head>

<body>
<div class="master-bg" id="bg"></div>
<button id="btnDownload" onclick="downloadSource()">ä¸‹è¼‰ç¨‹å¼ç¢¼</button>

<div class="main-container">
<div class="ui-header">
<div class="flex justify-between">
<span class="font-bold">ğŸ™ï¸ ç¹å¿™å’–å•¡å»³ â€” æ¼«ç•«åŒæ­¥ç³»çµ±</span>
<div class="flex gap-1">
<button class="btn" onclick="syncCloud()">åŒæ­¥æ’­æ”¾</button>
<button class="btn" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
</div>
</div>

<div class="flex gap-2 items-center mt-1">
<input id="sid" class="w-32" value="15h6v7zh05fbtNfoauduL9OjpzF8pIeMl86JR9Y9aZbU">
<div id="status">å¾…æ©Ÿ</div>
<div id="currentLine" class="italic truncate flex-1"></div>
</div>
<pre id="log">ç³»çµ±å•Ÿå‹•å®Œæˆ</pre>
</div>

<div class="stage" id="arena"></div>
</div>

<script>
/* === èƒŒæ™¯å®šç¾©è¡¨ === */
const BG_MAP={
cafe:"linear-gradient(rgba(217,119,6,.1),rgba(217,119,6,.1)),url('https://images.unsplash.com/photo-1559925393-8be0ec41b5ec?q=80&w=2000')",
night:"linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)),url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=2000')",
rain:"linear-gradient(rgba(0,0,0,.4),rgba(0,0,0,.4)),url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=2000')",
gold:"linear-gradient(rgba(251,191,36,.25),rgba(251,191,36,.25)),url('https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=2000')"
};

let currentBG="cafe";
function setBG(key){
if(!BG_MAP[key]||key===currentBG)return;
currentBG=key;
document.getElementById("bg").style.backgroundImage=BG_MAP[key];
log("èƒŒæ™¯åˆ‡æ› â†’ "+key);
}

const CHARS=[
{id:"Left",name:"Shizuku",path:"https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json"},
{id:"Right",name:"Hibiki",path:"https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json"}
];

function log(m){
const l=document.getElementById("log");
l.textContent="["+new Date().toLocaleTimeString()+"] "+m+"\n"+l.textContent.slice(0,300);
}

/* === åŸæœ¬ iframe + æ¼«ç•«å°è©±æ¡† å®Œæ•´ä¿ç•™ === */
function getIframeTemplate(path,name,side){
return `<!DOCTYPE html><html><head><script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
<style>
body{margin:0;overflow:hidden;background:transparent}
#bubble{position:fixed;top:18%;${side==="Left"?"right":"left"}:15px;
background:#fff;border:3px solid #b45309;padding:10px 14px;
border-radius:40px;font-size:15px;font-weight:900;display:none;max-width:90%}
</style></head>
<body>
<div id="bubble"></div>
<script>
L2Dwidget.init({model:{jsonPath:"${path}",scale:1},display:{position:"${side==="Left"?"right":"left"}",width:150,height:320}});
window.addEventListener("message",e=>{
if(e.data.text){
const b=document.getElementById("bubble");
b.innerText=e.data.text;b.style.display="block";
setTimeout(()=>b.style.display="none",Math.max(3000,e.data.text.length*320));
}});
</script></body></html>`;
}

function initArena(){
const a=document.getElementById("arena");
a.innerHTML="";
CHARS.forEach(c=>{
const f=document.createElement("iframe");
a.appendChild(f);
f.contentWindow.document.write(getIframeTemplate(c.path,c.name,c.id));
});
}

async function syncCloud(){
document.getElementById("status").innerText="æ’­æ”¾ä¸­";
const id=document.getElementById("sid").value.trim();
const t=await fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=csv`).then(r=>r.text());
const rows=parseCSV(t);
for(const r of rows){
if(r.background) setBG(r.background);
const side=(r.actor||"").toLowerCase().includes("right")?"Right":"Left";
document.getElementById("currentLine").innerText=r.text||"";
document.querySelectorAll("iframe")[side==="Left"?0:1].contentWindow.postMessage({text:r.text},"*");
await new Promise(res=>setTimeout(res,Math.max(3500,(r.text||"").length*350)));
}
document.getElementById("status").innerText="å¾…æ©Ÿ";
}

function parseCSV(csv){
const [h,...l]=csv.trim().split(/\r?\n/);
const k=h.split(",").map(s=>s.trim());
return l.map(x=>{const o={};x.split(",").forEach((v,i)=>o[k[i]]=v);return o});
}

function downloadSource(){
const b=new Blob([document.documentElement.outerHTML],{type:"text/html"});
const a=document.createElement("a");
a.href=URL.createObjectURL(b);
a.download="Live2D_Golden_Cafe_Final.html";
a.click();
}

window.onload=()=>{
setBG("cafe");
initArena();
};
</script>
</body>
</html>
