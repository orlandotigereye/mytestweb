<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Live2D å’–å•¡å»³é‡‘è¼ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
--gold-light:#fef3c7;
--gold-main:#fbbf24;
--gold-dark:#b45309;
--panel-bg:rgba(251,191,36,.94);
}
html,body{
margin:0;padding:0;height:100%;
overflow:hidden;
background:#92400e;
font-family:"PingFang TC","Microsoft JhengHei",sans-serif;
font-size:.5rem;
color:#451a03;
}
.master-bg{
position:fixed;
inset:0;
background-size:cover;
background-position:center;
background-repeat:no-repeat;
z-index:-1;
transition:background-image .8s ease-in-out;
}
.main-container{display:flex;flex-direction:column;height:100vh;}
.ui-header{
padding:4px;
background:var(--panel-bg);
border-bottom:2px solid #fff;
box-shadow:0 4px 12px rgba(180,83,9,.4);
z-index:100;
}
.stage{
flex:1;
display:flex;
align-items:flex-end;
justify-content:space-around;
}
iframe{width:50%;height:100%;border:none;background:transparent;}
.btn{
background:linear-gradient(to bottom,#fff,var(--gold-main));
border:1px solid var(--gold-dark);
padding:2px 6px;
border-radius:4px;
font-size:.5rem;
font-weight:bold;
cursor:pointer;
}
#log{
height:35px;
overflow-y:auto;
font-size:.5rem;
background:rgba(255,255,255,.85);
padding:2px;
border:1px inset var(--gold-dark);
white-space:pre-wrap;
}
#btnDownload{
position:fixed;top:5px;right:5px;z-index:200;
background:#059669;color:#fff;
font-size:.5rem;padding:2px 10px;
border-radius:15px;border:1px solid #fff;
}
input{
font-size:.5rem;
padding:1px 4px;
border:1px solid var(--gold-dark);
border-radius:3px;
}
</style>
</head>

<body>

<div class="master-bg" id="bg"></div>
<button id="btnDownload" onclick="downloadSource()">ä¸‹è¼‰ç¨‹å¼ç¢¼</button>

<div class="main-container">
<div class="ui-header">

<div class="flex justify-between items-center">
<span class="font-bold" style="font-size:.55rem;">â˜• Live2D å’–å•¡å»³ Ã— åŠ‡æœ¬è‡ªå‹•å ´æ™¯</span>
<div class="flex gap-1">
<button class="btn" onclick="syncCloud()">åŒæ­¥æ’­æ”¾</button>
<button class="btn" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
</div>
</div>

<div class="flex gap-2 items-center mt-1">
<input id="sid" class="w-32"
value="15h6v7zh05fbtNfoauduL9OjpzF8pIeMl86JR9Y9aZbU">
<div id="status" class="font-bold">å¾…æ©Ÿ</div>
<div id="currentLine" class="flex-1 truncate italic"></div>
</div>

<!-- æ‰‹å‹•èƒŒæ™¯åˆ‡æ›ï¼ˆä¸å½±éŸ¿è‡ªå‹•ï¼‰ -->
<div class="flex gap-1 mt-1 flex-wrap">
<button class="btn" onclick="manualBg('day')">â˜€ï¸ ç™½å¤©</button>
<button class="btn" onclick="manualBg('dusk')">ğŸŒ† é»ƒæ˜</button>
<button class="btn" onclick="manualBg('night')">ğŸŒ™ å¤œæ™š</button>
<button class="btn" onclick="manualBg('rain')">ğŸŒ§ï¸ é›¨å¤©</button>
</div>

<pre id="log">ç³»çµ±å°±ç·’ã€‚</pre>
</div>

<div class="stage" id="arena"></div>
</div>

<script>
/* ===== èƒŒæ™¯å®šç¾© ===== */
const BACKGROUNDS={
day:{name:"ç™½å¤©",url:"https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=2400&auto=format&fit=crop"},
dusk:{name:"é»ƒæ˜",url:"https://images.unsplash.com/photo-1511920170033-f8396924c348?q=80&w=2400&auto=format&fit=crop"},
night:{name:"å¤œæ™š",url:"https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2400&auto=format&fit=crop"},
rain:{name:"é›¨å¤©",url:"https://images.unsplash.com/photo-1521017432531-fbd92d768814?q=80&w=2400&auto=format&fit=crop"}
};

let bgLocked=false;
function setBg(key){
const bg=BACKGROUNDS[key];
if(!bg)return;
document.getElementById("bg").style.backgroundImage=`url("${bg.url}")`;
log(`èƒŒæ™¯åˆ‡æ›ï¼š${bg.name}`);
}
function manualBg(key){
bgLocked=true;
setBg(key);
}

/* ===== åŸæœ¬åŠŸèƒ½ ===== */
const CHARS=[
{id:"Left",name:"Shizuku",path:"https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json"},
{id:"Right",name:"Hibiki",path:"https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json"}
];

function log(m){
const l=document.getElementById("log");
l.textContent=`[${new Date().toLocaleTimeString()}] ${m}\n`+l.textContent.slice(0,300);
}

function getIframeTemplate(path,name,side){
return `
<!DOCTYPE html><html><head><meta charset="utf-8">
<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"><\/script>
<style>
body{margin:0;overflow:hidden;background:transparent;}
#bubble{position:fixed;top:18%;${side==="Left"?"right:15px":"left:15px"};
background:#fff;border:3px solid #b45309;padding:10px 14px;
font-size:15px;font-weight:900;display:none;max-width:90%;}
.name-tag{position:fixed;bottom:5px;${side==="Left"?"left:5px":"right:5px"};
background:rgba(251,191,36,.95);padding:2px 6px;font-size:10px;font-weight:bold;}
</style></head><body>
<div id="bubble"></div><div class="name-tag">${name}</div>
<script>
L2Dwidget.init({
model:{jsonPath:"${path}",scale:1},
display:{position:"${side==="Left"?"right":"left"}",width:150,height:320,hOffset:-20,vOffset:-20},
mobile:{show:true,scale:.45}
});
window.addEventListener("message",e=>{
if(e.data.text){
const b=document.getElementById("bubble");
b.textContent=e.data.text;b.style.display="block";
setTimeout(()=>b.style.display="none",Math.max(3000,e.data.text.length*320));
}});
<\/script></body></html>`;
}

function initArena(){
const a=document.getElementById("arena");a.innerHTML="";
CHARS.forEach(c=>{
const f=document.createElement("iframe");
f.id="f_"+c.id;a.appendChild(f);
f.contentWindow.document.open();
f.contentWindow.document.write(getIframeTemplate(c.path,c.name,c.id));
f.contentWindow.document.close();
});
setBg("day");
}

async function syncCloud(){
bgLocked=false;
document.getElementById("status").textContent="æ’­æ”¾ä¸­";
const url=`https://docs.google.com/spreadsheets/d/${sid.value}/export?format=csv`;
const t=await fetch(url).then(r=>r.text());
const lines=t.split(/\r?\n/).slice(1);

for(const line of lines){
const c=line.split(",");
const side=(c[0]||"").toLowerCase().includes("right")?"Right":"Left";
const text=c[1]||"";
const bg=c[4];

document.getElementById("currentLine").textContent=text;

if(bg && BACKGROUNDS[bg] && !bgLocked) setBg(bg);

document.getElementById("f_"+side).contentWindow.postMessage({text},"*");

if(speechSynthesis){
speechSynthesis.cancel();
const u=new SpeechSynthesisUtterance(text);
u.lang="zh-TW";speechSynthesis.speak(u);
}
await new Promise(r=>setTimeout(r,Math.max(3500,text.length*350)));
}
document.getElementById("status").textContent="å¾…æ©Ÿ";
}

function downloadSource(){
const b=new Blob([document.documentElement.outerHTML],{type:"text/html"});
const a=document.createElement("a");
a.href=URL.createObjectURL(b);
a.download="Live2D_Cafe_AutoBG.html";
a.click();
}

window.onload=initArena;
</script>
</body>
</html>
