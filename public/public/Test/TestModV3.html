<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘å…‰å æ˜Ÿåˆ†æå„€ V6</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --gold: #FFD700; --dark-gold: #B8860B; --text: #5D4037; }
        * { box-sizing: border-box; }
        body { 
            font-size: 0.5rem; 
            background: #FFD700 url('https://www.transparenttextures.com/patterns/gold-dust.png') fixed;
            color: var(--text); 
            margin: 0; padding: 10px; 
            font-family: system-ui, -apple-system, sans-serif;
        }
        .app-shell { 
            max-width: 100%; width: 100%; margin: 0 auto;
            background: rgba(255, 255, 240, 0.95);
            border: 3px solid var(--dark-gold);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3), inset 0 0 10px var(--gold);
            overflow: hidden;
        }
        .tabs { display: flex; background: var(--dark-gold); }
        .tab-btn { 
            flex: 1; border: none; padding: 10px; color: white; 
            background: transparent; cursor: pointer; font-size: 0.5rem;
            transition: 0.3s; border-right: 1px solid var(--gold);
        }
        .tab-btn.active { background: var(--gold); color: var(--text); font-weight: bold; }
        .content-page { display: none; padding: 15px; min-height: 300px; }
        .content-page.active { display: block; }
        textarea { 
            width: 100%; height: 120px; font-size: 0.5rem; 
            border: 2px solid var(--gold); border-radius: 4px;
            background: #fff; padding: 8px; margin-bottom: 10px;
        }
        .btn-action { 
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            background: linear-gradient(to bottom, #FFD700, #B8860B);
            color: white; font-weight: bold; font-size: 0.6rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); cursor: pointer;
            box-shadow: 0 4px 0 #784212; margin-bottom: 10px;
        }
        .btn-action:active { transform: translateY(2px); box-shadow: 0 2px 0 #784212; }
        #report-area { 
            background: #fff; border: 2px dashed var(--dark-gold); 
            padding: 15px; margin-top: 10px; min-height: 150px;
        }
        .log-box { font-size: 0.45rem; color: #888; margin-top: 10px; line-height: 1.2; }
        .dl-btn { 
            position: fixed; bottom: 15px; right: 15px; width: 50px; height: 50px;
            background: #000; color: #fff; border-radius: 50%; border: 2px solid var(--gold);
            font-size: 0.4rem; cursor: pointer; z-index: 999;
        }
    </style>
</head>
<body>

<div class="app-shell">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-input')">ğŸ”­ è§€æ¸¬è¼¸å…¥</button>
        <button class="tab-btn" onclick="switchTab('tab-view')">ğŸ“œ å æ˜Ÿå ±å‘Š</button>
    </div>

    <div id="tab-input" class="content-page active">
        <h3 style="text-align:center; color:var(--dark-gold);">âœ¨ å‘½é‹è§€æ¸¬å° âœ¨</h3>
        <textarea id="obsInput">2025-12-27 08:00 å°åŒ—
è§€æ¸¬å¤©è±¡ï¼š
- å¤ªé™½ï¼š78.5Â°
- æœ¨æ˜Ÿï¼š240.6Â°
è«‹ä¾ç…§æ˜Ÿè±¡å­—å…¸åˆ†æå°å€‹äººçš„è²¡é‹å½±éŸ¿ã€‚</textarea>
        <button class="btn-action" onclick="runAnalysis()">ğŸš€ å•Ÿå‹•æ ¸å¿ƒé‡‘å…‰åˆ†æ</button>
        <div id="statusLog" class="log-box">ç³»çµ±å¾…å‘½ä¸­...</div>
    </div>

    <div id="tab-view" class="content-page">
        <div id="report-area">
            <h2 id="repTitle" style="color:var(--dark-gold); text-align:center;">å°šæœªåˆ†æ</h2>
            <div id="repContent">è«‹å…ˆåœ¨è¼¸å…¥é é¢é»æ“ŠæŒ‰éˆ•ã€‚</div>
        </div>
        <button class="btn-action" onclick="saveAsImage()" style="margin-top:15px;">ğŸ“¥ å°å‡ºé‡‘ç®”å ±å‘Šåœ–</button>
    </div>
</div>

<button class="dl-btn" onclick="downloadCode()">ä¸‹è¼‰<br>ä»£ç¢¼</button>

<script>
let ASTRO_DICT = null;
const URL_ASTRO = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";
const URL_API_JS = "https://orlandotigereye.github.io/mytestweb/config/api.js";

function switchTab(id) {
    $('.content-page').removeClass('active');
    $('.tab-btn').removeClass('active');
    $('#' + id).addClass('active');
    $(`button[onclick="switchTab('${id}')"]`).addClass('active');
}

function updateLog(msg, isError = false) {
    const el = document.getElementById('statusLog');
    el.innerHTML = (isError ? 'âŒ ' : 'ğŸ”” ') + msg;
    if(isError) console.error(msg);
}

// ä¿®æ­£ JSON è§£æéŒ¯èª¤ï¼šæ‰‹å‹•æå– Hex å­—ä¸²
async function fetchSafeKey() {
    try {
        const res = await fetch(URL_API_JS);
        const text = await res.text();
        // åŒ¹é…å¼•è™Ÿå…§çš„ Hex å­—ä¸²
        const match = text.match(/"([a-fA-F0-9]+)"/);
        if (match) return decodeHex(match[1]);
        return null;
    } catch (e) { return null; }
}

function decodeHex(hex) {
    let s = "";
    for (let i = 0; i < hex.length; i += 2) s += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    return s;
}

async function runAnalysis() {
    updateLog("æ­£åœ¨è¼‰å…¥æ˜Ÿè±¡å¤§æ•¸æ“š...");
    
    try {
        // è¼‰å…¥å­—å…¸
        if(!ASTRO_DICT) {
            const res = await fetch(URL_ASTRO);
            ASTRO_DICT = await res.json();
        }

        const key = await fetchSafeKey();
        const input = document.getElementById('obsInput').value;

        updateLog("æ­£åœ¨åŒ¹é…æ˜Ÿè±¡é »ç‡...");
        
        // æ¨¡æ“¬åˆ†æé‚è¼¯
        setTimeout(() => {
            document.getElementById('repTitle').innerText = "âœ¨ ä»Šæ—¥é‡‘å…‰å æ˜Ÿå ±å‘Š âœ¨";
            let html = `<b>è§€æ¸¬æ™‚é–“ï¼š</b> 2025-12-27<br><br>`;
            html += `<b>å­—å…¸æª¢ç´¢ï¼š</b> æˆåŠŸè¼‰å…¥ ${Object.keys(ASTRO_DICT).length} æ¢æ˜Ÿè±¡è¦å‰‡ã€‚<br><br>`;
            html += `<b>åˆ†æçµæœï¼š</b><br>æ ¹æ“šç•¶å‰è¡Œæ˜Ÿä½ç½®ï¼Œä»Šæ—¥å±¬æ–¼ã€Œé‡‘å¹£è¼ç…Œã€ä¹‹å±€ï¼Œå»ºè­°ç©æ¥µè™•ç†è²¡å‹™äº‹å®œï¼Œå­—å…¸ä¸­å°æ‡‰çš„æœ¨æ˜Ÿèƒ½é‡æ¥µå¼·ã€‚`;
            
            document.getElementById('repContent').innerHTML = html;
            switchTab('tab-view');
            updateLog("åˆ†æå®Œæˆï¼");
        }, 1000);

    } catch (e) {
        updateLog("éŒ¯èª¤: " + e.message, true);
    }
}

async function saveAsImage() {
    const el = document.getElementById('report-area');
    const canvas = await html2canvas(el, { backgroundColor: '#FFFEF0' });
    const link = document.createElement('a');
    link.href = canvas.toDataURL();
    link.download = 'Fortune_Report.png';
    link.click();
}

function downloadCode() {
    const code = document.documentElement.outerHTML;
    const blob = new Blob([code], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'TsetModelV01_Fixed.html';
    a.click();
}

window.onload = () => updateLog("ç³»çµ±å°±ç·’ï¼Œè«‹è¼¸å…¥è§€æ¸¬å…§å®¹ã€‚");
</script>
</body>
</html>
