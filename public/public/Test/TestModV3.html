<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡‘ç¢§åå…¨ Pro - ä¹™å·³æ·±åº¦å¼•æ“ç‰ˆ</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://orlandotigereye.github.io/mytestweb/public/public/core.js"></script>
    <style>
        :root { --bg-gold: #FFFDE7; --main-gold: #D4AF37; --deep-gold: #B8860B; --coin-gold: #FFD700; --text-brown: #3E2723; --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%); --font-size: 0.5rem; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png') fixed; color: var(--text-brown); font-size: var(--font-size); width: 100vw; overflow-x: hidden; }
        header { height: 40px; background: var(--gold-grad); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-bottom: 2px solid var(--deep-gold); position: sticky; top: 0; z-index: 1000; font-weight: 900; }
        .status-bar { background: rgba(255,255,255,0.9); padding: 5px; display: flex; gap: 8px; border-bottom: 1px solid var(--main-gold); font-size: 0.4rem; overflow-x: auto; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 2px; }
        .ok { background: #2E7D32; } .fail { background: #C62828; } .wait { background: #F9A825; }
        .nav-tabs { display: flex; background: #FFF; border-bottom: 1px solid var(--main-gold); }
        .tab { flex: 1; text-align: center; padding: 12px 0; font-weight: 900; color: #A68B5A; cursor: pointer; }
        .tab.active { background: rgba(255, 215, 0, 0.2); border-bottom: 3px solid var(--deep-gold); color: var(--text-brown); }
        .content { padding: 10px; }
        .page { display: none; } .page.active { display: block; }
        .card { background: rgba(255,255,255,0.9); border: 1.5px solid var(--coin-gold); border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .title-gold { color: var(--deep-gold); font-weight: 900; margin-bottom: 6px; border-left: 3px solid var(--main-gold); padding-left: 6px; }
        textarea { width: 100%; height: 80px; border: 1px solid var(--main-gold); border-radius: 4px; padding: 6px; font-size: var(--font-size); background: #FFFEF9; }
        .btn-p { background: var(--gold-grad); border: 1px solid var(--deep-gold); color: var(--text-brown); font-weight: 900; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .score-box { display: flex; justify-content: space-around; margin: 10px 0; text-align: center; }
        .score-val { font-size: 1rem; font-weight: 900; color: var(--deep-gold); }
        .error-note { background: #FFEBEE; border: 1px solid #FFCDD2; padding: 8px; border-radius: 4px; margin-top: 10px; color: #C62828; font-size: 0.4rem; line-height: 1.2; }
        .dl-btn { position: fixed; bottom: 10px; right: 10px; width: 45px; height: 45px; background: #000; color: #fff; border-radius: 50%; font-size: 0.4rem; z-index: 3000; border: 1px solid var(--coin-gold); }
    </style>
</head>
<body>
<header>ğŸ”± ä¹™å·³å…¨ç®—å¼•æ“ Pro</header>
<div class="status-bar" id="mod-status"></div>
<nav class="nav-tabs"><div class="tab active" onclick="goTab(0)">æ¨æ¼”è¼¸å…¥</div><div class="tab" onclick="goTab(1)">æ·±åº¦å ±å‘Š</div></nav>
<div class="content">
    <div id="p0" class="page active">
        <div class="card"><div class="title-gold">å¤©æ©Ÿè¼¸å…¥</div><textarea id="main-in">å¤ªé™½ï¼š78.5Â°, æœˆäº®ï¼šä¸Šå¼¦, åœŸæ˜Ÿï¼š2.8Â°</textarea><button class="btn-p" id="run-btn" onclick="runAnalysis()">ğŸš€ å•Ÿå‹•äº”æ¨¡çµ„å…¨æ•¸æ“šæ¨æ¼”</button></div>
        <div id="error-footer" class="error-note" style="display:none;"></div>
    </div>
    <div id="p1" class="page">
        <div class="card">
            <div class="title-gold">å®‡å®™ç´šæ·±åº¦åˆ¤åˆ†</div>
            <div class="score-box">
                <div><div style="font-size:0.4rem;">å‡¶å‰å¾—åˆ†</div><div id="total-score" class="score-val">--</div></div>
                <div><div style="font-size:0.4rem;">æ€¥ç·©æŒ‡æ¨™</div><div id="urgency-val" class="score-val">--</div></div>
            </div>
            <div id="out-report" style="white-space: pre-wrap; line-height:1.6;">ç­‰å¾…æ¨æ¼”...</div>
        </div>
    </div>
</div>
<button class="dl-btn" onclick="downloadThis()">ä¸‹è¼‰<br>ä»£ç¢¼</button>
<script>
    let API_KEY = ""; let IS_AI_OK = false;
    const URL_CONFIG = "https://orlandotigereye.github.io/mytestweb/config/api.js";
    
    // æ•´åˆ ä¹™å·³å  V10.5 æ•¸æ“šæ¬Šé‡
    const ECI_ENGINE = {
        Planets: { "å¤ªé™½": 8, "æœˆäº®": 7, "æœ¨æ˜Ÿ": 9, "ç«æ˜Ÿ": -7, "åœŸæ˜Ÿ": -6, "æ°´æ˜Ÿ": 5, "é‡‘æ˜Ÿ": 6 },
        Urgency: { "ä¸Šå¼¦": 33, "ä¸‹å¼¦": 67, "æ»¿æœˆ": 50, "æ–°æœˆ": 10 }
    };

    async function init(){
        try {
            const res = await fetch(URL_CONFIG);
            const txt = await res.text();
            const match = txt.match(/"([a-fA-F0-9]+)"/);
            if(match) {
                API_KEY = decodeHex(match[1]);
                const check = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                IS_AI_OK = check.ok;
            }
        } catch(e) { IS_AI_OK = false; }
        await Core.initAll(); renderStatus(); checkFailures();
    }

    function decodeHex(h){ let s=""; for(let i=0;i<h.length;i+=2) s+=String.fromCharCode(parseInt(h.substr(i,2),16)); return s; }

    function renderStatus(){
        const con = $('#mod-status').empty();
        con.append(`<span><i class="status-dot ${IS_AI_OK?'ok':'fail'}"></i>AI_Key</span>`);
        if(Core.modules) Object.entries(Core.modules).forEach(([k,v])=>{ con.append(`<span><i class="status-dot ${v.status?'ok':'fail'}"></i>${k}</span>`); });
    }

    function checkFailures(){
        let m = [];
        if(!IS_AI_OK) m.push("âš ï¸ AI Key å¤±æ•ˆï¼šå·²è‡ªå‹•åˆ‡æ›ã€ä¹™å·³å  V10.5 åœ¨åœ°æ¨æ¼”å¼•æ“ã€‘ã€‚");
        if(m.length > 0) $('#error-footer').html(m.join('<br>')).show();
    }

    // åœ¨åœ°æ¨æ¼”é‚è¼¯ (æ ¸å¿ƒï¼šäº”æ¨¡çµ„åˆ¤åˆ†æ¨¡æ“¬)
    function runLocalEngine(input) {
        let score = 0; let urgency = 50; let report = "ã€åœ¨åœ°å¼•æ“æ·±åº¦å ±å‘Šã€‘\n";
        let matches = [];
        
        // 1. æ˜Ÿé«”å½±éŸ¿åŠ›æ¨¡çµ„
        Object.entries(ECI_ENGINE.Planets).forEach(([name, val]) => {
            if(input.includes(name)) { score += val; matches.push(name); }
        });
        // 2. æ€¥ç·©åº¦æ¨¡çµ„
        Object.entries(ECI_ENGINE.Urgency).forEach(([name, val]) => {
            if(input.includes(name)) { urgency = val; }
        });

        $('#total-score').text((score > 0 ? "+" : "") + score);
        $('#urgency-val').text(urgency);

        report += `â— æ•¸æ“šæ¯”å°ï¼šæª¢æ¸¬åˆ° ${matches.length} å€‹æ ¸å¿ƒæ˜Ÿæ¨™ã€‚\n`;
        report += `â— åˆ¤åˆ†çµæœï¼š${score >= 0 ? 'å‰' : 'å‡¶'} (å¾—åˆ†: ${score})\n`;
        report += `â— æ€¥ç·©åˆ¤å®šï¼š${urgency > 50 ? 'æ€¥è®Š (é€Ÿæˆ°é€Ÿæ±º)' : 'ç·©é€² (äº‹ç·©å‰‡åœ“)'}\n`;
        report += `â— æ·±åº¦å»ºè­°ï¼šä¾æ“šä¹™å·³å æ•¸æ“šï¼Œ${score > 5 ? 'ä¸»æ°£é‹äº¨é€šï¼Œå®œå¤§è†½é€²å–ã€‚' : 'ä¸»åœ°æ°£æ³¢å‹•ï¼Œå®œå®ˆæˆå®ˆéœã€‚'}\n`;
        
        if(Core.data?.astro) {
            report += "\n--- æ˜Ÿè±¡å­—å…¸è©³ç´°ç´¢å¼• ---\n";
            matches.forEach(m => {
                if(Core.data.astro[m]) report += `[${m}]: ${JSON.stringify(Core.data.astro[m]).substring(0,60)}...\n`;
            });
        }
        return report;
    }

    async function runAnalysis(){
        const input = $('#main-in').val();
        $('#run-btn').prop('disabled', true).text('âŒ› æ¨æ¼”ä¸­...');
        
        if(!IS_AI_OK) {
            $('#out-report').html(runLocalEngine(input));
            goTab(1); $('#run-btn').prop('disabled', false).text('ğŸš€ å•Ÿå‹•æ¨æ¼”');
            return;
        }

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents:[{parts:[{text: `ä»¿ä¹™å·³å é¢¨æ ¼åˆ†æï¼š${input}ã€‚å›å‚³JSON:{"report":"..","score":0,"urgency":50}`}]}], generationConfig:{responseMimeType:"application/json"} })
            });
            const d = await res.json();
            const r = JSON.parse(d.candidates[0].content.parts[0].text);
            $('#out-report').html(r.report);
            $('#total-score').text(r.score); $('#urgency-val').text(r.urgency);
            goTab(1);
        } catch(e) {
            $('#out-report').html(runLocalEngine(input) + `\n\n(AI ç•°å¸¸å›é€€: ${e.message})`);
            goTab(1);
        } finally { $('#run-btn').prop('disabled', false).text('ğŸš€ å•Ÿå‹•æ¨æ¼”'); }
    }

    function goTab(i){ $('.page').removeClass('active'); $(`#p${i}`).addClass('active'); $('.tab').removeClass('active').eq(i).addClass('active'); }
    function downloadThis(){ const b=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Golden_ECI_V10.html'; a.click(); }
    $(document).ready(init);
</script>
</body>
</html>
