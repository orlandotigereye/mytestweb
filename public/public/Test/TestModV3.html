<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡‘ç¢§åå…¨ Pro - è‡ªå‹•å®¹éŒ¯ç‰ˆ</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://orlandotigereye.github.io/mytestweb/public/public/core.js"></script>
    <style>
        :root { --bg-gold: #FFFDE7; --main-gold: #D4AF37; --deep-gold: #B8860B; --coin-gold: #FFD700; --text-brown: #3E2723; --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%); --font-size: 0.5rem; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png') fixed; color: var(--text-brown); font-size: var(--font-size); line-height: 1.4; width: 100vw; overflow-x: hidden; }
        header { height: 45px; background: var(--gold-grad); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-bottom: 2px solid var(--deep-gold); position: sticky; top: 0; z-index: 1000; }
        .status-bar { background: rgba(255,255,255,0.9); padding: 5px; display: flex; gap: 8px; border-bottom: 1px solid var(--main-gold); font-size: 0.4rem; overflow-x: auto; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 2px; }
        .ok { background: #2E7D32; } .fail { background: #C62828; } .wait { background: #F9A825; }
        .nav-tabs { display: flex; background: #FFF; border-bottom: 1px solid var(--main-gold); }
        .tab { flex: 1; text-align: center; padding: 10px 0; font-weight: 900; color: #A68B5A; cursor: pointer; font-size: var(--font-size); }
        .tab.active { background: rgba(255, 215, 0, 0.2); border-bottom: 3px solid var(--deep-gold); color: var(--text-brown); }
        .content { padding: 10px; padding-bottom: 20px; }
        .page { display: none; } .page.active { display: block; }
        .card { background: rgba(255,255,255,0.9); border: 1.5px solid var(--coin-gold); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .title-gold { color: var(--deep-gold); font-weight: 900; margin-bottom: 6px; border-left: 3px solid var(--main-gold); padding-left: 6px; }
        textarea { width: 100%; height: 80px; border: 1px solid var(--main-gold); border-radius: 4px; padding: 6px; font-size: var(--font-size); background: #FFFEF9; }
        .btn { border: none; border-radius: 4px; font-weight: 900; font-size: var(--font-size); cursor: pointer; padding: 10px; width: 100%; margin-top: 10px; }
        .btn-p { background: var(--gold-grad); border: 1px solid var(--deep-gold); color: var(--text-brown); }
        .error-note { background: #FFEBEE; border: 1px solid #FFCDD2; padding: 8px; border-radius: 4px; margin-top: 10px; color: #C62828; font-size: 0.45rem; line-height: 1.2; }
        .dl-btn { position: fixed; bottom: 10px; right: 10px; width: 45px; height: 45px; background: #000; color: #fff; border-radius: 50%; font-size: 0.4rem; z-index: 3000; border: 1px solid var(--coin-gold); }
    </style>
</head>
<body>
<header><div style="font-weight:900;">ğŸ”± åå…¨ Core Pro V2</div><div id="json-info" style="font-size:0.4rem;"></div></header>
<div class="status-bar" id="mod-status"></div>
<nav class="nav-tabs"><div class="tab active" onclick="goTab(0)">æ¨æ¼”</div><div class="tab" onclick="goTab(1)">å ±å‘Š</div><div class="tab" onclick="goTab(2)">æ„è±¡</div></nav>
<div class="content">
    <div id="p0" class="page active">
        <div class="card"><div class="title-gold">å¤©æ©Ÿè¼¸å…¥</div><textarea id="main-in">æœˆäº®ï¼šä¸Šå¼¦
å¤ªé™½ä½ç½®ï¼š78.5Â°
æ°´æ˜Ÿï¼š94.1Â°
è«‹æ ¹æ“šæ˜Ÿè±¡å­—å…¸åˆ†æå½±éŸ¿ã€‚</textarea><button class="btn btn-p" id="run-btn" onclick="runAnalysis()">ğŸš€ å•Ÿå‹•æ¨æ¼”</button></div>
        <div id="error-footer" class="error-note" style="display:none;"></div>
    </div>
    <div id="p1" class="page"><div class="card"><div class="title-gold">æ¨æ¼”å ±å‘Š</div><div id="out-report" style="white-space: pre-wrap;">ç­‰å¾…è¼¸å…¥...</div></div></div>
    <div id="p2" class="page">
        <div class="card"><div class="title-gold">ä¸‰æ‰æ„è±¡ (Imagen éœ€è¦ Key)</div>
            <div id="img-container">
                <img id="v1" style="width:100%; border-radius:4px; margin-bottom:5px;">
                <p id="s1" style="text-align:center;"></p>
            </div>
        </div>
    </div>
</div>
<button class="dl-btn" onclick="downloadThis()">ä¸‹è¼‰<br>ä»£ç¢¼</button>
<script>
    let API_KEY = ""; 
    let IS_KEY_VALID = false;
    const URL_API_CONFIG = "https://orlandotigereye.github.io/mytestweb/config/api.js";

    async function init(){
        try {
            const res = await fetch(URL_API_CONFIG);
            const txt = await res.text();
            const match = txt.match(/"([a-fA-F0-9]+)"/);
            if(match) {
                API_KEY = decodeHex(match[1]);
                const check = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                IS_KEY_VALID = check.ok;
            }
        } catch(e) { IS_KEY_VALID = false; }
        
        await Core.initAll();
        renderStatus();
        checkFailures();
    }

    function decodeHex(h){ let s=""; for(let i=0;i<h.length;i+=2) s+=String.fromCharCode(parseInt(h.substr(i,2),16)); return s; }

    function renderStatus(){
        const con = $('#mod-status').empty();
        con.append(`<span><i class="status-dot ${IS_KEY_VALID?'ok':'fail'}"></i>AI_Key</span>`);
        if(Core.modules) Object.entries(Core.modules).forEach(([k,v])=>{ con.append(`<span><i class="status-dot ${v.status?'ok':'fail'}"></i>${k}</span>`); });
    }

    function checkFailures(){
        let msg = [];
        if(!IS_KEY_VALID) msg.push("âŒ AI Key å¤±æ•ˆï¼šGemini é›²ç«¯æ¨æ¼”èˆ‡ Imagen ç¹ªåœ–ä¸å¯ç”¨ã€‚");
        if(Core.data && !Core.data.astro) msg.push("âŒ å­—å…¸ç¼ºå¤±ï¼šç„¡æ³•è®€å–æ˜Ÿè±¡ JSONã€‚");
        if(msg.length > 0) $('#error-footer').html(msg.join('<br>') + "<br>â„¹ï¸ ç³»çµ±å·²è‡ªå‹•åˆ‡æ›ç‚ºã€åœ¨åœ°æ˜Ÿè±¡ JSON æ¨¡å¼ã€‘").show();
    }

    // åœ¨åœ°åˆ†ææ¨¡å¼ï¼šéæ­· JSON åŒ¹é…è¼¸å…¥é—œéµå­—
    function runLocalAnalysis(input) {
        let report = "<b>[æœ¬åœ°æ¨¡å¼åˆ†æå ±å‘Š]</b>\nç”±æ–¼ AI æœå‹™ä¸å¯ç”¨ï¼Œç³»çµ±ç›´æ¥èª¿ç”¨æ˜Ÿè±¡å­—å…¸è³‡æ–™ï¼š\n\n";
        if(!Core.data || !Core.data.astro) return report + "éŒ¯èª¤ï¼šæ˜Ÿè±¡å­—å…¸æœªè¼‰å…¥ï¼Œç„¡æ³•åˆ†æã€‚";
        
        let found = false;
        Object.keys(Core.data.astro).forEach(key => {
            if(input.includes(key)) {
                found = true;
                const detail = Core.data.astro[key];
                report += `ã€${key}ã€‘\næè¿°ï¼š${JSON.stringify(detail)}\n\n`;
            }
        });
        
        if(!found) report += "æç¤ºï¼šè¼¸å…¥å…§å®¹æœªåŒ¹é…åˆ°å­—å…¸é—œéµå­—ï¼Œè«‹è¼¸å…¥å…·é«”æ˜Ÿé«”åç¨±ï¼ˆå¦‚ï¼šå¤ªé™½ã€æœˆäº®ï¼‰ã€‚";
        return report;
    }

    async function runAnalysis(){
        const input = $('#main-in').val();
        $('#run-btn').prop('disabled', true).text('âŒ› è™•ç†ä¸­...');
        
        if(!IS_KEY_VALID) {
            $('#out-report').html(runLocalAnalysis(input));
            goTab(1);
            $('#run-btn').prop('disabled', false).text('ğŸš€ å•Ÿå‹•æ¨æ¼”');
            return;
        }

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents:[{parts:[{text: `è«‹åˆ†æï¼š${input}ã€‚å›å‚³JSON:{"report":"..","p1":"..","s1":".."}`}]}], generationConfig:{responseMimeType:"application/json"} })
            });
            const d = await res.json();
            
            // é—œéµä¿®æ­£ï¼šæª¢æŸ¥ candidates æ˜¯å¦å­˜åœ¨
            if(d.candidates && d.candidates[0]) {
                const r = JSON.parse(d.candidates[0].content.parts[0].text);
                $('#out-report').html(r.report);
                $('#s1').text(r.s1);
                genImg(1, r.p1);
            } else {
                throw new Error("AI å›å‚³æ ¼å¼ç•°å¸¸");
            }
            goTab(1);
        } catch(e) {
            console.warn("AI å¤±æ•—ï¼Œåˆ‡æ›åœ¨åœ°åˆ†æ", e);
            $('#out-report').html(runLocalAnalysis(input) + `\n\n(ç³»çµ±å‚™è¨»: AI éŒ¯èª¤ - ${e.message})`);
            goTab(1);
        } finally {
            $('#run-btn').prop('disabled', false).text('ğŸš€ å•Ÿå‹•æ¨æ¼”');
        }
    }

    async function genImg(idx, p){
        if(!IS_KEY_VALID) return;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ instances:[{prompt:"Gold mystic, "+p}], parameters:{sampleCount:1} })
            });
            const d = await res.json();
            if(d.predictions) $(`#v${idx}`).attr('src', `data:image/png;base64,${d.predictions[0].bytesBase64Encoded}`);
        } catch(e){}
    }

    function goTab(i){ $('.page').removeClass('active'); $(`#p${i}`).addClass('active'); $('.tab').removeClass('active').eq(i).addClass('active'); }
    function downloadThis(){ const b=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Golden_Core_Stable.html'; a.click(); }
    $(document).ready(init);
</script>
</body>
</html>
