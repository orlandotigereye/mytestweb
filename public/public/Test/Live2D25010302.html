<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>é‡‘è¼ Live2D åŠ‡æœ¬è¦–ç•Œç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <style>
        :root {
            --gold-light: #fef3c7;
            --gold-main: #fbbf24;
            --gold-dark: #b45309;
            --panel-bg: rgba(251, 191, 36, 0.95);
        }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: #fffbeb;
            color: #451a03;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            overflow: hidden;
            font-size: 0.5rem;
        }
        #master-bg {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0;
            background-size: cover;
            background-position: center;
            background-image: url('https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?auto=format&fit=crop&q=80&w=2000');
            transition: opacity 0.5s;
        }
        .sparkle-overlay {
            position: fixed; inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/gold-dust.png');
            pointer-events: none;
            z-index: 1;
            opacity: 0.35;
        }
        .ui-root {
            position: relative;
            z-index: 100;
            display: flex;
            flex-direction: column;
            height: 100vh;
            pointer-events: none;
        }
        .top-bar {
            background: var(--panel-bg);
            padding: 8px 12px;
            border-bottom: 3px solid #fcd34d;
            box-shadow: 0 4px 15px rgba(180, 83, 9, 0.4);
            pointer-events: auto;
        }
        .btn-gold {
            background: linear-gradient(to bottom, #fef3c7, #fbbf24);
            border: 1px solid #b45309;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.5rem;
            font-weight: 900;
            color: #451a03;
            cursor: pointer;
            box-shadow: 2px 2px 0 #b45309;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
        }
        #console {
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px inset #b45309;
            margin-top: 6px;
            padding: 4px 8px;
            overflow-y: auto;
            font-size: 0.5rem;
            border-radius: 4px;
        }
        .stage {
            position: fixed;
            bottom: 0; left: 0;
            width: 100vw; height: 85vh;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 50;
            pointer-events: none;
        }
        iframe {
            width: 45%; height: 100%;
            border: none;
            pointer-events: auto;
            background: transparent;
        }
        input[type="text"] {
            border: 1px solid #b45309;
            background: #fff;
            padding: 2px 6px;
            font-size: 0.5rem;
            border-radius: 3px;
        }
        #dl-btn {
            position: fixed; bottom: 15px; right: 15px;
            background: #10b981; color: #fff;
            padding: 6px 12px; border-radius: 6px;
            font-size: 0.5rem; z-index: 200; border: 2px solid #fff;
            font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="master-bg"></div>
<div class="sparkle-overlay"></div>

<button id="dl-btn" onclick="downloadMe()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼ç¢¼</button>

<div class="ui-root">
    <div class="top-bar">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-amber-900" style="font-size:0.6rem">âœ¨ é‡‘è¼ Live2D åŠ‡æœ¬è¦–ç•Œç³»çµ± V3 (åŠ‡æƒ…ä¿®å¾©ç‰ˆ)</span>
            <div class="flex gap-3">
                <button class="btn-gold" onclick="document.getElementById('f-in').click()">ä¸Šå‚³èƒŒæ™¯</button>
                <button class="btn-gold" onclick="setBgUrl()">æ›´æ›ç¶²å€</button>
                <button class="btn-gold" id="script-trigger" onclick="runScript()">å•Ÿå‹•é›²ç«¯åŠ‡æœ¬</button>
            </div>
        </div>
        <input type="file" id="f-in" hidden accept="image/*" onchange="readBg(this)">
        <div class="flex gap-2 items-center">
            <span style="white-space:nowrap; font-weight:bold;">åŠ‡æœ¬ ID:</span>
            <input type="text" id="sheet-id" class="w-full" value="15h6v7zh05fbtNfoauduL9OjpzF8pIeMl86JR9Y9aZbU">
        </div>
        <div id="console">ç³»çµ±å°±ç·’ã€‚ç­‰å¾…æŒ‡ä»¤...</div>
    </div>
</div>

<div class="stage" id="main-stage"></div>

<script>
    const logBox = document.getElementById('console');
    const bgLayer = document.getElementById('master-bg');

    function log(msg) {
        const d = new Date();
        const t = d.toLocaleTimeString('zh-TW', { hour12: false });
        const entry = document.createElement('div');
        entry.innerHTML = `<span style="color:#b45309;">[${t}]</span> ${msg}`;
        logBox.prepend(entry);
    }

    function readBg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                log("æœ¬åœ°èƒŒæ™¯å·²è¼‰å…¥ã€‚");
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function setBgUrl() {
        const url = prompt("è«‹è¼¸å…¥èƒŒæ™¯åœ–ç‰‡ç¶²å€:");
        if(url) {
            bgLayer.style.backgroundImage = `url('${url}')`;
            log("èƒŒæ™¯ç¶²å€å·²åˆ‡æ›ã€‚");
        }
    }

    const models = [
        { id: "L", path: "https://cdn.jsdelivr.net/gh/fghrsh/live2d_api/model/shizuku/model.json" },
        { id: "R", path: "https://cdn.jsdelivr.net/gh/fghrsh/live2d_api/model/koharu/model.json" }
    ];

    function initChars() {
        const stage = document.getElementById('main-stage');
        stage.innerHTML = "";
        models.forEach(m => {
            const iframe = document.createElement('iframe');
            iframe.id = `char-${m.id}`;
            stage.appendChild(iframe);
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`
                <html>
                <head>
                    <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"><\/script>
                    <style>
                        body { margin:0; padding:0; background:transparent; overflow:hidden; }
                        #msg-box { 
                            position:fixed; top:20%; left:5%; right:5%; 
                            background:rgba(255,255,255,0.95); 
                            border:4px solid #fbbf24; border-radius:15px; 
                            padding:12px; font-size:24px; font-weight:bold;
                            display:none; text-align:center; z-index:9999;
                            box-shadow: 0 8px 20px rgba(180,83,9,0.5);
                            color: #451a03;
                            animation: pop 0.3s ease-out;
                        }
                        @keyframes pop { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }
                    </style>
                </head>
                <body>
                    <div id="msg-box"></div>
                    <script>
                        window.onload = () => {
                            L2Dwidget.init({
                                model: { jsonPath: "${m.path}" },
                                display: { position: "center", width: 350, height: 700 },
                                mobile: { show: true, scale: 0.6 },
                                react: { opacity: 1 }
                            });
                        };
                        window.addEventListener('message', e => {
                            const mb = document.getElementById('msg-box');
                            mb.innerText = e.data; 
                            mb.style.display = 'block';
                            setTimeout(()=> { mb.style.display = 'none'; }, 5000);
                        });
                    <\/script>
                </body>
                </html>
            `);
            doc.close();
        });
        log("è¦–ç•Œäººç‰©æ¨¡çµ„åˆå§‹åŒ–æˆåŠŸã€‚");
    }

    async function runScript() {
        const sid = document.getElementById('sheet-id').value;
        const btn = document.getElementById('script-trigger');
        btn.disabled = true;
        btn.innerText = "åŠ‡æœ¬æ¼”ç¹¹ä¸­...";
        
        log(`é–‹å§‹ç²å–åŠ‡æœ¬: ${sid}`);
        try {
            const response = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=0&t=${Date.now()}`);
            if(!response.ok) throw new Error("ç¶²è·¯è«‹æ±‚å¤±æ•—");
            
            const textData = await response.text();
            // CSV æ­£å‰‡è§£æè™•ç†åˆ†è¡Œèˆ‡å¼•è™Ÿ
            const rows = textData.split(/\r?\n/).filter(line => line.trim() !== "");
            
            log(`åŠ‡æœ¬æˆåŠŸè®€å–ï¼Œå…± ${rows.length - 1} æ®µåŠ‡æƒ…ã€‚`);
            
            for(let i = 1; i < rows.length; i++) {
                // ç°¡å–®è§£æ CSV é€—è™Ÿ
                const parts = rows[i].split(',');
                if(parts.length < 2) continue;
                
                const role = parts[0].replace(/"/g, '').trim().toLowerCase();
                const dialogue = parts[1].replace(/"/g, '').trim();
                
                const targetId = (role.includes('right') || role.includes('koharu') || role.includes('r')) ? 'char-R' : 'char-L';
                
                log(`[æ¼”ç¹¹] ${role.toUpperCase()}: ${dialogue}`);
                
                const frame = document.getElementById(targetId);
                if(frame && frame.contentWindow) {
                    frame.contentWindow.postMessage(dialogue, '*');
                }
                
                // ç­‰å¾…å°è©±é¡¯ç¤ºæ™‚é–“
                await new Promise(r => setTimeout(r, 6000));
            }
            
            log("åŠ‡æœ¬æ¼”ç¹¹çµæŸã€‚");
        } catch(err) {
            log(`éŒ¯èª¤: ${err.message}`);
        } finally {
            btn.disabled = false;
            btn.innerText = "å•Ÿå‹•é›²ç«¯åŠ‡æœ¬";
        }
    }

    function downloadMe() {
        const content = document.documentElement.outerHTML;
        const blob = new Blob([content], {type:'text/html'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Golden_Live2D_V3.html";
        link.click();
    }

    window.onload = () => {
        setTimeout(initChars, 800);
    };
</script>
</body>
</html>
