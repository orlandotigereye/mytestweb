<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å¤©è±¡æ¸¬è©¦é  V2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: system-ui; font-size: 13px; padding: 10px; background:#FFF8E7; color:#5D4037; }
.ok { color: #2ecc71; }
.fail { color: #e74c3c; }
button { margin: 6px 0; padding:5px 10px; cursor:pointer; }
textarea { width:100%; height:120px; margin:6px 0; }
#report { border:1px solid #C5A059; padding:10px; background:#FFFEF0; margin-top:10px; }
</style>

<!-- æ ¸å¿ƒ JS -->
<script src="https://orlandotigereye.github.io/mytestweb/public/public/core.js"></script>

</head>
<body>

<h2>ğŸŒŸ å¤©è±¡æ¸¬è©¦é  V2</h2>

<h3>ğŸ“¦ æ¨¡çµ„è¼‰å…¥ç‹€æ…‹</h3>
<div id="status"></div>
<button onclick="reInit()">ğŸ”„ é‡æ–°åˆå§‹åŒ–</button>

<h3>ğŸ“ è¼¸å…¥è§€æ¸¬å…§å®¹</h3>
<textarea id="obsInput" placeholder="è¼¸å…¥è§€æ¸¬å…§å®¹..."></textarea>
<button onclick="startAnalyze()">ğŸš€ æ ¸å¿ƒåˆ†æ</button>

<h3>ğŸ“Š JSON æ‘˜è¦</h3>
<div id="jsonSummary"></div>

<h3>ğŸ–¼ å ±å‘Šå°å‡º</h3>
<div id="report">
  <h3 id="reportTitle">å°šç„¡åˆ†æ</h3>
  <div id="reportContent"></div>
  <button onclick="exportReport()">ğŸ“¥ å°å‡ºå ±å‘Šåœ–</button>
</div>

<script>
/* ========================
  æ¸²æŸ“æ¨¡çµ„ç‹€æ…‹
======================== */
function renderStatus() {
  const box = document.getElementById("status");
  box.innerHTML = "";
  Object.entries(Core.modules).forEach(([k,v])=>{
    const d=document.createElement("div");
    d.className = v.status?"ok":"fail";
    d.textContent = `${k}: ${v.status?"OK":"FAILED"}`;
    if(v.err)d.textContent+=` (${v.err})`;
    box.appendChild(d);
  });
}

/* ========================
  é‡æ–°åˆå§‹åŒ–
======================== */
async function reInit() {
  document.getElementById("status").textContent="åˆå§‹åŒ–ä¸­...";
  try{
    await Core.initAll(); // ç­‰å¾…æ‰€æœ‰æ¨¡çµ„èˆ‡ JSON è¼‰å…¥å®Œæˆ
  }catch(e){
    console.error("åˆå§‹åŒ–å¤±æ•—:", e);
  }
  renderStatus();
  renderJSONSummary();
}

/* ========================
  JSON æ‘˜è¦
======================== */
function renderJSONSummary() {
  const summary=document.getElementById("jsonSummary");
  summary.innerHTML="";
  const astroCount = Core.data?.astro?.length || 0;
  const cjkCount = Core.data?.cjk?.length || 0;
  summary.innerHTML = `<b>æ˜Ÿè±¡è³‡æ–™ç­†æ•¸ï¼š</b>${astroCount}<br>`;
  summary.innerHTML += `<b>CJK å­—å…¸ç­†æ•¸ï¼š</b>${cjkCount}<br>`;
}

/* ========================
  æ ¸å¿ƒåˆ†æ (å‘¼å« API)
======================== */
async function startAnalyze() {
  const input=document.getElementById("obsInput").value.trim();
  if(!input){ alert("è«‹è¼¸å…¥è§€æ¸¬å…§å®¹"); return; }
  if(!Core.data?.astro || !Core.data?.cjk){ alert("è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ"); return; }

  const prompt = `è«‹åˆ†æä»¥ä¸‹å…§å®¹ä¸¦ä»¥ JSON æ ¼å¼å›å‚³ (åŒ…å« title, content)ï¼š\n${input}`;
  const apiKey = window.__apiKey||"YOUR_API_KEY";

  document.getElementById("reportTitle").textContent="åˆ†æä¸­...";
  document.getElementById("reportContent").textContent="è«‹ç¨å€™...";

  try{
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {method:"POST",
       headers:{"Content-Type":"application/json"},
       body:JSON.stringify({
         contents:[{parts:[{text:prompt}]}],
         generationConfig:{responseMimeType:"application/json"}
       })}
    );
    const data=await res.json();
    const parsed=JSON.parse(data.candidates[0].content.parts[0].text);

    document.getElementById("reportTitle").textContent=parsed.title;
    document.getElementById("reportContent").textContent=parsed.content;
  }catch(e){
    document.getElementById("reportTitle").textContent="åˆ†æå¤±æ•—";
    document.getElementById("reportContent").textContent=e.message;
  }
}

/* ========================
  å°å‡ºå ±å‘Šåœ–
======================== */
async function exportReport(){
  if(!window.html2canvas){ alert("html2canvas å°šæœªè¼‰å…¥"); return; }
  const el=document.getElementById("report");
  const canvas=await html2canvas(el,{scale:2});
  const link=document.createElement("a");
  link.href=canvas.toDataURL();
  link.download="å¤©è±¡å ±å‘Š.png";
  link.click();
}

/* ========================
  é é¢åˆå§‹åŒ–
======================== */
reInit();
</script>

</body>
</html>
