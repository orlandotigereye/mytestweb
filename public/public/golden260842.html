<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘ç¢§å¤©è±¡ G-4.5 MEGA MONITOR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- å¼•å…¥å®˜æ–¹æ¨™æº–åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <style>
        :root {
            --bg-gold: #FFFDE7;
            --coin-gold: #FFD700;
            --main-gold: #D4AF37;
            --deep-gold: #B8860B;
            --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%);
            --font-size: 0.5rem; /* åš´æ ¼ 0.5rem */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0; 
            background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png'); 
            color: #3E2723;
            font-size: var(--font-size); 
            overflow-x: hidden; width: 100vw;
            line-height: 1.8;
        }

        /* é‡‘ç¢§è¼ç…Œå°èˆª */
        header {
            height: 75px; background: var(--gold-grad);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 5px solid var(--deep-gold);
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 15px rgba(184, 134, 11, 0.4);
        }

        .logo-text { font-size: 0.6rem; font-weight: 900; color: #3E2723; }

        .nav-tabs {
            display: flex; background: #FFF; border-bottom: 2px solid var(--main-gold);
            position: sticky; top: 75px; z-index: 999;
        }
        .tab {
            flex: 1; text-align: center; padding: 18px 0;
            font-size: 0.5rem; font-weight: 900; color: #A68B5A; cursor: pointer;
            transition: 0.3s; border-right: 1px solid #F0F0F0;
        }
        .tab.active {
            color: #3E2723; background: rgba(255, 215, 0, 0.25);
            border-bottom: 6px solid var(--deep-gold);
        }

        .content-area { padding: 15px; padding-bottom: 100px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: rgba(255, 255, 255, 0.98); border: 2.5px solid var(--coin-gold);
            border-radius: 15px; padding: 20px; margin-bottom: 22px;
            box-shadow: 0 8px 20px rgba(184, 134, 11, 0.2);
        }
        .card-title {
            font-size: 0.55rem; font-weight: 900; margin-bottom: 15px;
            color: #5D4037; border-left: 10px solid var(--deep-gold); padding-left: 12px;
        }

        textarea {
            width: 100%; height: 240px; border: 2.5px solid var(--main-gold);
            border-radius: 10px; padding: 15px; font-size: 0.5rem;
            background: #FFFEF2; resize: none; color: #3E2723;
        }

        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            font-weight: 900; font-size: 0.52rem; cursor: pointer; margin-top: 12px;
        }
        .btn-primary { background: var(--gold-grad); color: #3E2723; border: 1.5px solid var(--deep-gold); box-shadow: 0 5px 0 #B8860B; }
        .btn-secondary { background: #FFF; border: 2.5px solid var(--main-gold); color: var(--main-gold); }

        /* è¨ºæ–·æ¢ */
        .diag-item { margin-bottom: 15px; }
        .diag-label { font-size: 0.5rem; font-weight: 900; display: flex; justify-content: space-between; }
        .diag-bar { height: 14px; background: #EEE; border-radius: 7px; overflow: hidden; margin-top: 6px; border: 1px solid #DDD; }
        .diag-fill { height: 100%; width: 0%; background: var(--gold-grad); transition: width 0.8s ease; }

        /* æ„è±¡åœ– */
        .art-box { width: 100%; min-height: 300px; background: #111; border-radius: 12px; margin-top: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 4px solid var(--main-gold); }
        .art-box img { width: 100%; height: auto; display: block; }
        .loading-text { color: var(--coin-gold); font-size: 0.5rem; font-weight: bold; text-align: center; }

        #overlay {
            position: fixed; inset: 0; background: var(--bg-gold);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 60px; height: 60px; border: 8px solid #F3F3F3; border-top: 8px solid var(--coin-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #msg-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 90%; pointer-events: none; }
        .msg-item { background: #3E2723; color: var(--coin-gold); padding: 12px 20px; border-radius: 20px; font-size: 0.5rem; text-align: center; margin-top: 10px; border: 2px solid var(--coin-gold); }

        #d3-stage { width: 100%; height: 400px; background: #0A0A0A; border-radius: 12px; border: 3px solid var(--coin-gold); }
    </style>
</head>
<body>

<div id="overlay">
    <div class="spinner"></div>
    <div style="margin-top:25px; font-weight:900; font-size:0.6rem; color:var(--deep-gold);">å¤©è±¡ç³»çµ±å®‰å…¨é€£ç·šä¸­</div>
    <div id="load-status" style="margin-top:10px; font-size:0.5rem;">æ­£åœ¨é©—è­‰ API æ†‘è­‰...</div>
</div>

<div id="msg-box"></div>

<header>
    <div class="logo-text">ğŸ”± G-4.5 MEGA ULTIMATE</div>
    <button class="btn-secondary" style="width:auto; margin:0; padding:8px 15px; font-size:0.5rem;" onclick="downloadCode()">ğŸ’¾ ä¸‹è¼‰æºç¢¼</button>
</header>

<nav class="nav-tabs">
    <div class="tab active" data-pg="0">å•Ÿå‹•</div>
    <div class="tab" data-pg="1">åˆ†æ</div>
    <div class="tab" data-pg="2">èƒ½é‡</div>
    <div class="tab" data-pg="3">æ„è±¡</div>
    <div class="tab" data-pg="4">æ±ºç­–</div>
</nav>

<div class="content-area">
    <section id="pg-0" class="page active">
        <div class="card">
            <div class="card-title">ğŸ“¡ é›²ç«¯é€£ç·šè¨ºæ–·</div>
            <div class="diag-item" id="diag-api"><div class="diag-label"><span>API æˆæ¬Šé‡‘é‘°</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
            <div class="diag-item" id="diag-cjk"><div class="diag-label"><span>ä¸­æ–‡å­—å…¸è³‡æº</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
            <div class="diag-item" id="diag-ast"><div class="diag-label"><span>æ˜Ÿè±¡æ•¸æ“šçŸ©é™£</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
        </div>

        <div class="card">
            <div class="card-title">âŒ¨ï¸ è¼¸å…¥è§€æ¸¬æ¨£æœ¬</div>
            <textarea id="main-input">ä¹™å·³å¹´ æˆŠå­æœˆ å·±å·³æ—¥ ç™¸é…‰æ™‚ è§€æ¸¬ï¼š
æœˆç›¸ï¼šä¸Šå¼¦ | å¤ªé™½ 73.7Â° | å®¿æ›œï¼šè»«æœ¨èŸ¹ (æœ¨)
äº”è¡Œåˆ†ä½ˆï¼šæœ¨:28 ç«:33 åœŸ:25 é‡‘:20 æ°´:35</textarea>
            
            <div id="process-monitor" style="display:none; margin-top:20px; border-top:2px dashed var(--main-gold); padding-top:20px;">
                <div class="diag-item" id="diag-gemini"><div class="diag-label"><span>Gemini é‚è¼¯å°è£</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
                <div class="diag-item" id="diag-imagen"><div class="diag-label"><span>Imagen æ„è±¡æ¸²æŸ“</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
            </div>
            <button id="btn-go" class="btn btn-primary" disabled>è¼‰å…¥è³‡æºä¸­...</button>
        </div>
    </section>

    <section id="pg-1" class="page"></section>
    <section id="pg-2" class="page">
        <div class="card"><div class="card-title">ğŸŒ€ äº”è¡Œèƒ½é‡æµå‹•å ´</div><div id="d3-stage"></div></div>
        <div id="energy-stats"></div>
    </section>
    <section id="pg-3" class="page"></section>
    <section id="pg-4" class="page"></section>
</div>

<script>
let API_KEY = "";
// ä½¿ç”¨å…·å‚™ master çš„ç©©å®šè·¯å¾‘
const API_URL = "https://orlandotigereye.github.io/mytestweb/config/api.js";
const CJK_URL = "https://raw.githubusercontent.com/max32002/chinese_dictionary/master/Dictionary.json";
const AST_URL = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

let DB_CJK = null, DB_AST = null, STATE = null;

function msg(t) {
    const $m = $(`<div class="msg-item">${t}</div>`);
    $('#msg-box').append($m);
    setTimeout(() => $m.fadeOut(500, () => $m.remove()), 4000);
}

function updateDiag(id, per, txt, err=false) {
    const $i = $('#' + id);
    $i.find('.diag-fill').css('width', per + '%');
    $i.find('.v').text(txt).css('color', err ? '#FF5252' : '');
}

function decodeHex(h) {
    let s = "";
    for (let i = 0; i < h.length; i += 2) s += String.fromCharCode(parseInt(h.substr(i, 2), 16));
    return s;
}

async function boot() {
    try {
        const akRes = await fetch(API_URL);
        const akTxt = await akRes.text();
        const m = akTxt.match(/["']([a-fA-F0-9]+)["']/);
        if(m) {
            API_KEY = decodeHex(m[1]);
            updateDiag('diag-api', 100, 'å°±ç·’');
        }

        updateDiag('diag-cjk', 20, 'ä¸‹è¼‰ä¸­');
        updateDiag('diag-ast', 20, 'ä¸‹è¼‰ä¸­');

        const [c, a] = await Promise.all([
            fetch(CJK_URL).then(r => r.json()),
            fetch(AST_URL).then(r => r.json())
        ]);

        DB_CJK = c; updateDiag('diag-cjk', 100, 'å°±ç·’');
        DB_AST = a; updateDiag('diag-ast', 100, 'å°±ç·’');

        $('#btn-go').prop('disabled', false).text('ğŸš€ å•Ÿå‹•å…¨å¤©è±¡ç²¾ç®—');
        $('#overlay').fadeOut(800);
    } catch(e) {
        msg("è³‡æºé€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–åˆ†æ”¯è·¯å¾‘");
        console.error(e);
    }
}

function getStrokes(str) {
    let count = 0;
    const clean = str.replace(/[^\u4e00-\u9fa5]/g, '');
    for(let char of clean) {
        const f = DB_CJK.find(d => d.word === char);
        count += f ? parseInt(f.stroke_count) : 8;
    }
    return count || 10;
}

async function run() {
    const input = $('#main-input').val().trim();
    if(!API_KEY) return msg("API Key æœªæ­£ç¢ºè§£æ");

    $('#process-monitor').fadeIn();
    updateDiag('diag-gemini', 20, 'å°è£æ•¸æ“š');
    
    const strokes = getStrokes(input);
    const prompt = `è§€æ¸¬è³‡æ–™ï¼š${input}ã€‚èƒ½é‡æ¬Šé‡ç­†åŠƒï¼š${strokes}ã€‚
    è«‹åˆ†æå¤©è±¡èˆ‡äº”è¡Œï¼Œå›å‚³ JSON (åš´æ ¼ç¦æ­¢åŒ…å« markdown æ¨™ç±¤)ï¼š
    {
      "brief": "ä¸€å¥è©±ç¸½è¦½å¤©æ©Ÿ",
      "logic": [{"t": "ç¶­åº¦æ¨™é¡Œ", "c": "åˆ†æå…§å®¹ï¼Œéœ€è±å¯Œå…·æ„è±¡"}],
      "elements": {"wood": 0.2, "fire": 0.3, "earth": 0.2, "metal": 0.15, "water": 0.15},
      "render": [{"p": "Detailed AI Art Prompt", "l": "æ„è±¡åœ–å"}],
      "guide": {"do": "å®œ", "no": "å¿Œ", "final": "æ ¸å¿ƒæ–·èª"}
    }`;

    try {
        updateDiag('diag-gemini', 60, 'é›²ç«¯é‹ç®—');
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const data = await res.json();
        let raw = data.candidates[0].content.parts[0].text;
        // é—œéµä¿®å¾©ï¼šå‰é›¢å¯èƒ½çš„ Markdown æ¨™ç±¤
        raw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
        STATE = JSON.parse(raw);
        
        updateDiag('diag-gemini', 100, 'é‹ç®—å®Œæˆ');
        renderUI();
        msg("é‚è¼¯åˆ†æå®Œç•¢ï¼Œé–‹å§‹æ¸²æŸ“æ„è±¡åœ–...");
        $('[data-pg=1]').click();
    } catch(e) {
        updateDiag('diag-gemini', 0, 'å¤±æ•—', true);
        msg("Gemini å°è£å¤±æ•—: " + e.message);
    }
}

function renderUI() {
    // P1
    let h1 = `<div class="card"><div class="card-title">ğŸ”® å¤©æ©Ÿæ‘˜è¦</div><p style="font-size:0.55rem; font-weight:900;">${STATE.brief}</p></div>`;
    STATE.logic.forEach(l => h1 += `<div class="card"><div class="card-title">${l.t}</div><p>${l.c}</p></div>`);
    $('#pg-1').html(h1);

    // P2 æ•¸æ“š
    let h2 = `<div class="card"><table style="width:100%; font-size:0.5rem;">`;
    const dict = {wood:"æœ¨", fire:"ç«", earth:"åœŸ", metal:"é‡‘", water:"æ°´"};
    Object.entries(STATE.elements).forEach(([k,v]) => {
        h2 += `<tr><td style="color:var(--deep-gold); font-weight:900; padding:8px;">${dict[k]}èƒ½é‡</td><td>${(v*100).toFixed(2)}%</td></tr>`;
    });
    $('#energy-stats').html(h2 + `</table></div>`);

    // P4 æ±ºç­–
    $('#pg-4').html(`
        <div class="card" style="background:var(--gold-grad); border:4px solid #3E2723; padding:40px; text-align:center;">
            <div style="font-size:0.7rem; font-weight:900; color:#3E2723;">ã€Œ${STATE.guide.final}ã€</div>
        </div>
        <div class="card"><div class="card-title">âœ… è¶¨å‰æŒ‡å—</div><p style="color:#2E7D32; font-weight:900;">å®œï¼š${STATE.guide.do}</p></div>
        <div class="card"><div class="card-title">âŒ é¿å‡¶ç¦å¿Œ</div><p style="color:#C62828; font-weight:900;">å¿Œï¼š${STATE.guide.no}</p></div>
    `);

    renderArt();
}

async function renderArt() {
    let h = "";
    updateDiag('diag-imagen', 10, 'ä½‡åˆ—ä¸­');
    for(let i=0; i<STATE.render.length; i++) {
        const item = STATE.render[i];
        const bid = `art-${i}`;
        h += `<div class="card"><div class="card-title">${item.l}</div><div class="art-box" id="${bid}"><div class="loading-text">Imagen 4.0 ç”Ÿæˆä¸­...</div></div></div>`;
        
        (async () => {
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`, {
                    method: "POST",
                    body: JSON.stringify({ instances: { prompt: item.p }, parameters: { sampleCount: 1 } })
                });
                const d = await r.json();
                const b64 = d.predictions[0].bytesBase64Encoded;
                $(`#${bid}`).html(`<img src="data:image/png;base64,${b64}">`);
                updateDiag('diag-imagen', 100, 'å®Œæˆ');
            } catch(e) {
                $(`#${bid}`).html('<div class="loading-text" style="color:red;">æ¸²æŸ“å¤±æ•—</div>');
            }
        })();
    }
    $('#pg-3').html(h);
}

function runD3Force() {
    const el = d3.select("#d3-stage");
    el.selectAll("*").remove();
    const w = $('#d3-stage').width(), h = 400;
    const svg = el.append("svg").attr("width", w).attr("height", h);
    
    const colors = {wood:"#4CAF50", fire:"#FF5252", earth:"#FBC02D", metal:"#E0E0E0", water:"#2196F3"};
    const nodes = Object.entries(STATE.elements).map(([k,v]) => ({
        id: k, name: {wood:"æœ¨", fire:"ç«", earth:"åœŸ", metal:"é‡‘", water:"æ°´"}[k], r: 40 + (v * 120), color: colors[k]
    }));

    const sim = d3.forceSimulation(nodes)
        .force("center", d3.forceCenter(w/2, h/2))
        .force("collide", d3.forceCollide().radius(d => d.r + 10))
        .force("charge", d3.forceManyBody().strength(-300));

    const g = svg.selectAll("g").data(nodes).enter().append("g");
    g.append("circle").attr("r", d => d.r).attr("fill", d => d.color).attr("stroke", "#FFD700").attr("stroke-width", 3);
    g.append("text").text(d => d.name).attr("text-anchor", "middle").attr("dy", ".35em").style("font-weight", "900").style("fill", "#FFF").style("font-size", "0.6rem");

    sim.on("tick", () => g.attr("transform", d => `translate(${d.x},${d.y})`));
}

function downloadCode() {
    const blob = new Blob([document.documentElement.outerHTML], {type: "text/html"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "G45_MEGA_STABLE_FIX.html";
    a.click();
}

$(document).ready(() => {
    boot();
    $('.tab').click(function() {
        const p = $(this).data('pg');
        $('.tab, .page').removeClass('active');
        $(this).addClass('active');
        $(`#pg-${p}`).addClass('active');
        if(p == 2 && STATE) setTimeout(runD3Force, 50);
    });
    $('#btn-go').click(run);
});
</script>
</body>
</html>

