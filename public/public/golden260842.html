<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é‡‘ç¢§å¤©è±¡ G-4.5 MEGA ULTIMATE</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
<style>
:root{
--bg-gold:#FFFDE7;
--coin-gold:#FFD700;
--main-gold:#D4AF37;
--deep-gold:#B8860B;
--gold-grad:linear-gradient(135deg,#FFD700 0%,#FFF176 50%,#DAA520 100%);
--font-size:0.5rem;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
margin:0;padding:0;font-family:'PingFang TC','Noto Sans TC',sans-serif;
background:var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png');
color:#3E2723;font-size:var(--font-size);line-height:1.6;overflow-x:hidden;
}
header{
height:75px;background:var(--gold-grad);display:flex;justify-content:space-between;
align-items:center;padding:0 15px;border-bottom:5px solid var(--deep-gold);
position:sticky;top:0;z-index:1000;box-shadow:0 5px 15px rgba(184,134,11,.3);
}
.nav-tabs{display:flex;background:#FFF;border-bottom:2px solid var(--main-gold);position:sticky;top:75px;z-index:999}
.tab{flex:1;text-align:center;padding:15px 0;font-weight:900;color:#A68B5A;cursor:pointer;border-right:1px solid #F0F0F0;font-size:var(--font-size)}
.tab.active{background:rgba(255,215,0,.2);border-bottom:5px solid var(--deep-gold);color:#3E2723}
.content-area{padding:15px;padding-bottom:100px}
.page{display:none}.page.active{display:block}
.card{background:rgba(255,255,255,.98);border:2.5px solid var(--coin-gold);border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 8px 20px rgba(184,134,11,.1)}
.card-title{font-size:0.5rem;font-weight:900;margin-bottom:15px;color:#5D4037;border-left:8px solid var(--deep-gold);padding-left:12px}
textarea{width:100%;height:220px;border:2.5px solid var(--main-gold);border-radius:10px;padding:12px;font-size:0.5rem;background:#FFFEF2;resize:none;color:#3E2723}
.btn{width:100%;padding:18px;border:none;border-radius:12px;font-weight:900;font-size:0.5rem;cursor:pointer;margin-top:12px}
.btn-primary{background:var(--gold-grad);color:#3E2723;border:1px solid var(--deep-gold);box-shadow:0 5px 0 #B8860B}
.btn-secondary{background:#FFF;border:2.5px solid var(--main-gold);color:var(--main-gold)}
.diag-item{margin-bottom:12px}
.diag-label{font-size:0.5rem;font-weight:900;display:flex;justify-content:space-between}
.diag-bar{height:12px;background:#EEE;border-radius:6px;overflow:hidden;margin-top:5px;border:1px solid #DDD}
.diag-fill{height:100%;width:0%;background:var(--gold-grad);transition:width .8s ease}
.art-viewport{width:100%;min-height:320px;background:#111;border-radius:12px;margin-top:15px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:4px solid var(--main-gold)}
.art-viewport img{width:100%;height:auto;display:block}
.loading-txt{color:var(--coin-gold);font-size:0.5rem;font-weight:bold;animation:pulse 1.5s infinite}
@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
#overlay{position:fixed;inset:0;background:var(--bg-gold);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center}
.spinner{width:60px;height:60px;border:8px solid #F3F3F3;border-top:8px solid var(--coin-gold);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#msg-box{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:5000;width:90%;pointer-events:none}
.msg-item{background:#3E2723;color:var(--coin-gold);padding:12px 20px;border-radius:20px;font-size:0.5rem;text-align:center;margin-top:10px;border:2px solid var(--coin-gold);box-shadow:0 4px 10px rgba(0,0,0,.3)}
#d3-stage{width:100%;height:400px;background:#0A0A0A;border-radius:12px;border:3px solid var(--coin-gold)}
</style>
</head>
<body>
<div id="overlay"><div class="spinner"></div><div style="margin-top:25px;font-weight:900;font-size:0.5rem;color:var(--deep-gold)">é€£ç·šè‡³å¤©è±¡æ ¸å¿ƒ...</div><div id="boot-status" style="margin-top:10px;font-size:0.5rem">é©—è­‰é ç«¯ Master åˆ†æ”¯...</div></div>
<div id="msg-box"></div>
<header><div style="font-weight:900;font-size:0.5rem">ğŸ”± G-4.5 MEGA MONITOR</div><button class="btn-secondary" style="width:auto;margin:0;padding:8px 15px;font-size:0.5rem" onclick="exportDoc()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼ç¢¼</button></header>
<nav class="nav-tabs">
<div class="tab active" data-p="0">å•Ÿå‹•</div><div class="tab" data-p="1">åˆ†æ</div><div class="tab" data-p="2">èƒ½é‡</div><div class="tab" data-p="3">æ„è±¡</div><div class="tab" data-p="4">æ±ºç­–</div>
</nav>
<div class="content-area">
<section id="pg-0" class="page active">
<div class="card"><div class="card-title">ğŸ“¡ è³‡æºéˆçµç‹€æ…‹</div>
<div class="diag-item" id="d-cjk"><div class="diag-label"><span>CJK å­—å…¸ (Master)</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
<div class="diag-item" id="d-ast"><div class="diag-label"><span>æ˜Ÿè±¡å¤§æ•¸æ“šåº«</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
</div>
<div class="card"><div class="card-title">âŒ¨ï¸ è§€æ¸¬æ¨£æœ¬è¼¸å…¥</div>
<textarea id="main-input">ä¹™å·³å¹´ æˆŠå­æœˆ å·±å·³æ—¥ è§€æ¸¬æ¨£æœ¬ï¼š
æœˆç›¸ï¼šä¸Šå¼¦ | å¤ªé™½ 73.7Â° | å®¿æ›œï¼šè»«æœ¨èŸ¹ (æœ¨)
äº”è¡Œåˆ†ä½ˆï¼šæœ¨:28 ç«:33 åœŸ:25 é‡‘:20 æ°´:35</textarea>
<div id="run-mon" style="display:none;margin-top:20px;border-top:2px dashed var(--main-gold);padding-top:20px">
<div class="diag-item" id="d-gemini"><div class="diag-label"><span>Gemini 2.5 é‚è¼¯</span><span class="v">ä½‡åˆ—ä¸­</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
<div class="diag-item" id="d-imagen"><div class="diag-label"><span>Imagen 4.0 æ„è±¡</span><span class="v">ä½‡åˆ—ä¸­</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
</div>
<button id="btn-run" class="btn btn-primary" disabled>è¼‰å…¥ä¸­...</button>
</div>
</section>
<section id="pg-1" class="page"></section>
<section id="pg-2" class="page">
<div class="card"><div class="card-title">ğŸŒ€ äº”è¡Œèƒ½é‡æµå‹•å ´</div><div id="d3-stage"></div></div>
<div id="energy-list"></div>
</section>
<section id="pg-3" class="page"></section>
<section id="pg-4" class="page"></section>
</div>
<script>
const apiKey = ""; // å¿…é ˆç‚ºç©ºï¼Œç”±ç’°å¢ƒæ³¨å…¥
let DB_CJK=[];let DB_AST=null;let APP_STATE=null;
const URL_CJK="https://raw.githubusercontent.com/max32002/chinese_dictionary/master/Dictionary.json";
const URL_AST="https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

function log(t){const m=$(`<div class="msg-item">${t}</div>`);$('#msg-box').append(m);setTimeout(()=>m.fadeOut(500,()=>m.remove()),4000)}
function setD(id,p,v,e=false){const i=$('#'+id);i.find('.diag-fill').css('width',p+'%');i.find('.v').text(v).css('color',e?'#FF5252':'')}

async function boot(){
try{
setD('d-cjk',20,'ä¸‹è¼‰ä¸­');setD('d-ast',20,'ä¸‹è¼‰ä¸­');
const [cjkRes, astRes]=await Promise.all([
    fetch(URL_CJK).then(r=>r.json()),
    fetch(URL_AST).then(r=>r.json())
]);
DB_CJK = Array.isArray(cjkRes) ? cjkRes : (cjkRes.values || []);
DB_AST = astRes; 
setD('d-cjk', 100, 'å°±ç·’');setD('d-ast', 100, 'å°±ç·’');
$('#btn-run').prop('disabled',false).text('ğŸš€ å•Ÿå‹•æ¼”ç®—');
$('#overlay').fadeOut(600);
}catch(e){log("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");setD('d-cjk',0,'éŒ¯èª¤',true)}
}

function getStrokes(s){
let total=0;const chars=s.replace(/[^\u4e00-\u9fa5]/g,'');
for(let c of chars){const f=DB_CJK.find(d=>d.word===c);total+=f?parseInt(f.stroke_count):8}
return total||10;
}

async function apiCall(prompt){
    let retry = 0;
    const delays = [1000, 2000, 4000, 8000, 16000];
    while(retry < 5){
        try{
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if(!r.ok) throw new Error(r.status);
            return await r.json();
        } catch(e){
            if(retry === 4) throw e;
            await new Promise(res => setTimeout(res, delays[retry]));
            retry++;
        }
    }
}

async function start(){
const input=$('#main-input').val().trim();
$('#run-mon').fadeIn();setD('d-gemini',20,'æ•¸æ“šå°è£ä¸­');
const strokes=getStrokes(input);
const prompt=`åˆ†ææ¨£æœ¬ï¼š${input}ã€‚ç­†åŠƒæ¬Šé‡ï¼š${strokes}ã€‚å›å‚³ JSONï¼š
{"brief":"å¤©æ©Ÿæ‘˜è¦","logic":[{"t":"ç¶­åº¦","c":"å…§å®¹"}],"elements":{"wood":0.2,"fire":0.2,"earth":0.2,"metal":0.2,"water":0.2},"advice":{"do":"å®œ","no":"å¿Œ","final":"çµè«–"},"arts":[{"p":"AI Art Prompt","l":"åœ–å"}]}`;

try{
setD('d-gemini',50,'Gemini é‹ç®—ä¸­');
const d = await apiCall(prompt);
let txt = d.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
APP_STATE = JSON.parse(txt);
setD('d-gemini',100,'æ¼”ç®—å®Œæˆ');
render();log("æ•¸æ“šå°è£å®Œæˆï¼Œå•Ÿå‹•æ„è±¡æ¸²æŸ“...");
$('[data-p=1]').click();
}catch(e){setD('d-gemini',0,'API æ‹’çµ•é€£ç·š (403/Key Error)',true);log("è«‹ç¢ºèªç’°å¢ƒ API Key å·²æ³¨å…¥");}
}

function render(){
let h1=`<div class="card"><div class="card-title">ğŸ”® å¤©æ©Ÿæ‘˜è¦</div><p style="font-weight:900">${APP_STATE.brief}</p></div>`;
APP_STATE.logic.forEach(l=>h1+=`<div class="card"><div class="card-title">${l.t}</div><p>${l.c}</p></div>`);
$('#pg-1').html(h1);
let h2=`<div class="card"><table style="width:100%">`;
const dict={wood:"æœ¨",fire:"ç«",earth:"åœŸ",metal:"é‡‘",water:"æ°´"};
Object.entries(APP_STATE.elements).forEach(([k,v])=>{
h2+=`<tr><td style="color:var(--deep-gold);font-weight:900;padding:8px">${dict[k]}èƒ½é‡</td><td>${(v*100).toFixed(2)}%</td></tr>`;
});
$('#energy-list').html(h2+`</table></div>`);
$('#pg-4').html(`<div class="card" style="background:var(--gold-grad);text-align:center;padding:40px"><div style="font-size:0.7rem;font-weight:900">ã€Œ${APP_STATE.advice.final}ã€</div></div><div class="card"><div class="card-title">âœ… å®œ</div><p>${APP_STATE.advice.do}</p></div><div class="card"><div class="card-title">âŒ å¿Œ</div><p>${APP_STATE.advice.no}</p></div>`);
renderArts();
}

async function renderArts(){
let h='';setD('d-imagen',10,'æ¸²æŸ“ä½‡åˆ—ä¸­');
for(let i=0;i<APP_STATE.arts.length;i++){
const it=APP_STATE.arts[i];const bid=`art-${i}`;
h+=`<div class="card"><div class="card-title">${it.l}</div><div class="art-viewport" id="${bid}"><div class="loading-txt">Imagen 4.0 æ¸²æŸ“ä¸­...</div></div></div>`;
(async()=>{
try{
const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`,{
method:"POST",body:JSON.stringify({instances:{prompt:it.p},parameters:{sampleCount:1}})
});
const d=await r.json();const b64=d.predictions[0].bytesBase64Encoded;
$(`#${bid}`).html(`<img src="data:image/png;base64,${b64}">`);
setD('d-imagen',100,'æ¸²æŸ“å®Œæˆ');
}catch(e){$(`#${bid}`).html('<div class="loading-txt" style="color:#FF5252">æ¸²æŸ“å—é™</div>')}
})();
}
$('#pg-3').html(h);
}

function runD3(){
const el=d3.select("#d3-stage");el.selectAll("*").remove();
const w=$("#d3-stage").width(),h=400;const svg=el.append("svg").attr("width",w).attr("height",h);
const colors={wood:"#4CAF50",fire:"#FF5252",earth:"#FBC02D",metal:"#E0E0E0",water:"#2196F3"};
const nodes=Object.entries(APP_STATE.elements).map(([k,v])=>({id:k,name:({wood:"æœ¨",fire:"ç«",earth:"åœŸ",metal:"é‡‘",water:"æ°´"})[k],r:40+(v*120),color:colors[k]}));
const sim=d3.forceSimulation(nodes).force("center",d3.forceCenter(w/2,h/2)).force("collide",d3.forceCollide().radius(d=>d.r+10)).force("charge",d3.forceManyBody().strength(-300));
const g=svg.selectAll("g").data(nodes).enter().append("g");
g.append("circle").attr("r",d=>d.r).attr("fill",d=>d.color).attr("stroke","#FFD700").attr("stroke-width",3);
g.append("text").text(d=>d.name).attr("text-anchor","middle").attr("dy",".35em").style("font-weight","900").style("fill","#FFF").style("font-size","0.6rem");
sim.on("tick",()=>g.attr("transform",d=>`translate(${d.x},${d.y})`));
}

function exportDoc(){
const b=new Blob([document.documentElement.outerHTML],{type:"text/html"});
const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download="G45_MEGA_REPAIR.html";a.click();
}

$(document).ready(()=>{
boot();
$('.tab').click(function(){
const p=$(this).data('p');$('.tab,.page').removeClass('active');$(this).addClass('active');$(`#pg-${p}`).addClass('active');
if(p==2 && APP_STATE) setTimeout(runD3,50);
});
$('#btn-run').click(start);
});
</script>
</body>
</html>
