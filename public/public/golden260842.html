<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘ç¢§å¤©è±¡ G-4.5 HEX ULTIMATE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- å¼•å…¥å®˜æ–¹æ¨™æº–åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <style>
        :root {
            --bg-gold: #FFFDE7;
            --coin-gold: #FFD700;
            --main-gold: #D4AF37;
            --deep-gold: #B8860B;
            --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%);
            --font-size: 0.5rem; /* åš´æ ¼ 0.5rem */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0; 
            background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png'); 
            color: #3E2723;
            font-size: var(--font-size); 
            overflow-x: hidden; width: 100vw;
            line-height: 1.6;
        }

        header {
            height: 70px; background: var(--gold-grad);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 4px solid var(--deep-gold);
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 10px rgba(184, 134, 11, 0.3);
        }

        .logo { font-size: 0.6rem; font-weight: 900; color: #3E2723; text-shadow: 1px 1px 0px #FFF; }

        .nav-tabs {
            display: flex; background: #FFF; border-bottom: 2px solid var(--main-gold);
            position: sticky; top: 70px; z-index: 999;
        }
        .tab {
            flex: 1; text-align: center; padding: 15px 0;
            font-size: 0.5rem; font-weight: 900; color: #A68B5A; cursor: pointer;
            transition: 0.3s;
        }
        .tab.active {
            color: #3E2723; background: rgba(255, 215, 0, 0.2);
            border-bottom: 4px solid var(--deep-gold);
        }

        .content { padding: 15px; padding-bottom: 80px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: rgba(255, 255, 255, 0.95); border: 2px solid var(--coin-gold);
            border-radius: 12px; padding: 18px; margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(184, 134, 11, 0.1);
        }
        .card-title {
            font-size: 0.52rem; font-weight: 900; margin-bottom: 12px;
            color: #5D4037; border-left: 6px solid var(--deep-gold); padding-left: 10px;
        }

        textarea {
            width: 100%; height: 180px; border: 2px solid var(--main-gold);
            border-radius: 8px; padding: 12px; font-size: 0.5rem;
            color: #3E2723; resize: none; background: #FFFEF9;
        }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-weight: 900; font-size: 0.5rem; cursor: pointer; margin-top: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-gold { background: var(--gold-grad); color: #3E2723; border: 1px solid var(--deep-gold); box-shadow: 0 4px 0 #B8860B; }
        .btn-outline { background: #FFF; border: 2px solid var(--main-gold); color: var(--main-gold); }

        .status-bar { display: flex; flex-direction: column; gap: 8px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; }
        .progress-bg { flex: 1; height: 10px; background: #E0E0E0; border-radius: 5px; margin: 0 10px; overflow: hidden; border: 1px solid #CCC; }
        .progress-fill { width: 0%; height: 100%; background: var(--gold-grad); transition: width 0.5s; }

        #d3-stage { width: 100%; height: 350px; background: #0A0A0A; border-radius: 10px; border: 3px solid var(--coin-gold); }

        #toast-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 85%; pointer-events: none; }
        .toast { background: rgba(62, 39, 35, 0.95); color: var(--coin-gold); padding: 10px 20px; border-radius: 20px; font-size: 0.5rem; text-align: center; margin-top: 10px; border: 1px solid var(--coin-gold); font-weight: 900; }

        #loader {
            position: fixed; inset: 0; background: var(--bg-gold);
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-spin { width: 50px; height: 50px; border: 6px solid #F3F3F3; border-top: 6px solid var(--coin-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .img-container { width: 100%; min-height: 250px; background: #111; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--main-gold); margin-top: 10px; }
        .img-container img { width: 100%; height: auto; border-radius: 8px; }
        .img-label { color: var(--coin-gold); font-size: 0.5rem; }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-spin"></div>
    <div style="margin-top:20px; font-weight:900; color:var(--deep-gold); font-size:0.6rem;">16é€²ä½æ ¡æº–ä¸­...</div>
</div>

<div id="toast-box"></div>

<header>
    <div class="logo">ğŸ”± G-4.5 HEX CORE</div>
    <button class="btn-outline" style="width:auto; padding:8px 15px; margin:0;" onclick="downloadCode()">ğŸ’¾ ä¸‹è¼‰</button>
</header>

<nav class="nav-tabs">
    <div class="tab active" data-target="pg-home">è§€æ¸¬</div>
    <div class="tab" data-target="pg-logic">é‚è¼¯</div>
    <div class="tab" data-target="pg-energy">èƒ½é‡</div>
    <div class="tab" data-target="pg-art">æ„è±¡</div>
    <div class="tab" data-target="pg-result">æ±ºæ–·</div>
</nav>

<div class="content">
    <section id="pg-home" class="page active">
        <div class="card">
            <div class="card-title">ğŸ“¡ ç³»çµ±é€£çµç‹€æ…‹ (HEX API)</div>
            <div class="status-bar">
                <div class="stat-row" id="st-api"><span>å¯†é‘°è§£ç¢¼</span><div class="progress-bg"><div class="progress-fill"></div></div><span class="val">å¾…æ©Ÿ</span></div>
                <div class="stat-row" id="st-cjk"><span>æ¼¢å­—å­—å…¸</span><div class="progress-bg"><div class="progress-fill"></div></div><span class="val">å¾…æ©Ÿ</span></div>
                <div class="stat-row" id="st-ast"><span>æ˜Ÿè±¡çŸ©é™£</span><div class="progress-bg"><div class="progress-fill"></div></div><span class="val">å¾…æ©Ÿ</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">âŒ¨ï¸ è¼¸å…¥è§€æ¸¬åŸå§‹ç¢¼</div>
            <textarea id="txt-input">ä¹™å·³å¹´ æˆŠå­æœˆ å·±å·³æ—¥ ç™¸é…‰æ™‚
è§€æ¸¬å®šä½ï¼šåŒ—ç·¯ 25.03, æ±ç¶“ 121.56
æ ¸å¿ƒæ„åœ–ï¼šæ±‚æ¸¬äº‹æ¥­å‹•èƒ½èˆ‡è²¡ç¥¿æµè½‰</textarea>
            <button id="btn-run" class="btn btn-gold" disabled>åˆå§‹åŒ–è³‡æºä¸­...</button>
        </div>
    </section>

    <section id="pg-logic" class="page"></section>
    
    <section id="pg-energy" class="page">
        <div class="card"><div class="card-title">ğŸŒ€ äº”è¡Œèƒ½é‡åˆ†å¸ƒçŸ©é™£</div><div id="d3-stage"></div></div>
        <div id="energy-list"></div>
    </section>

    <section id="pg-art" class="page"></section>

    <section id="pg-result" class="page"></section>
</div>

<script>
/**
 * G-4.5 HEX CORE ENCRYPTION VERSION
 * å­—é«”å¤§å°: 0.5rem å›ºå®š
 */
let DECODED_API_KEY = "";
const ENDPOINT_API = "https://orlandotigereye.github.io/mytestweb/config/api.js";
const ENDPOINT_CJK = "https://raw.githubusercontent.com/max32002/chinese_dictionary/master/Dictionary.json";
const ENDPOINT_AST = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

let CJK_DATA = null, AST_DATA = null, FINAL_DATA = null;

function msg(t) {
    const $e = $(`<div class="toast">${t}</div>`);
    $('#toast-box').append($e);
    setTimeout(() => $e.fadeOut(400, () => $e.remove()), 4000);
}

function updateStat(id, p, txt, isErr = false) {
    const $r = $(`#${id}`);
    $r.find('.progress-fill').css('width', p + '%');
    $r.find('.val').text(txt).css('color', isErr ? '#F44336' : '#3E2723');
}

// 16 é€²ä½è§£ç¢¼é‚è¼¯
function hexToUtf8(h) {
    let s = "";
    for (let i = 0; i < h.length; i += 2) s += String.fromCharCode(parseInt(h.substr(i, 2), 16));
    return s;
}

async function init() {
    try {
        updateStat('st-api', 30, 'è§£æä¸­');
        const resK = await fetch(ENDPOINT_API);
        const rawK = await resK.text();
        const hexMatch = rawK.match(/["']([a-fA-F0-9]+)["']/);
        if(hexMatch) {
            DECODED_API_KEY = hexToUtf8(hexMatch[1]);
            updateStat('st-api', 100, 'è§£ç¢¼æˆåŠŸ');
        }

        updateStat('st-cjk', 20, 'ä¸‹è¼‰ä¸­');
        updateStat('st-ast', 20, 'ä¸‹è¼‰ä¸­');

        const [cjk, ast] = await Promise.all([
            fetch(ENDPOINT_CJK).then(r => r.json()),
            fetch(ENDPOINT_AST).then(r => r.json())
        ]);

        CJK_DATA = cjk; updateStat('st-cjk', 100, 'å°±ç·’');
        AST_DATA = ast; updateStat('st-ast', 100, 'å°±ç·’');

        $('#btn-run').prop('disabled', false).text('ğŸš€ å•Ÿå‹• HEX å¤©è±¡ç²¾ç®—');
        $('#loader').fadeOut(600);
    } catch(e) {
        msg("è³‡æºåˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– main åˆ†æ”¯è·¯å¾‘ã€‚");
        updateStat('st-api', 0, 'ä¸­æ–·', true);
    }
}

function calcStrokes(txt) {
    let s = 0;
    const chars = txt.replace(/[^\u4e00-\u9fa5]/g, '');
    for(let c of chars) {
        const item = CJK_DATA.find(d => d.word === c);
        s += item ? parseInt(item.stroke_count) : 10;
    }
    return s || 15;
}

async function execute() {
    const input = $('#txt-input').val().trim();
    if(!DECODED_API_KEY) return msg("éŒ¯èª¤ï¼šæœªåµæ¸¬åˆ° HEX API å¯†é‘°");

    msg("æ­£åœ¨å°è£å¤©è±¡é‚è¼¯...");
    const weight = calcStrokes(input);

    const prompt = `è§€æ¸¬è³‡æ–™: "${input}"ã€‚æ¬Šé‡ç­†åŠƒ: ${weight}ã€‚
    è«‹ä¾å¤©è±¡é‹ç®—å›å‚³ JSON æ ¼å¼ (ä¸å¯åŒ…å« Markdown æ¨™è¨˜)ï¼š
    {
      "summary": "æ ¸å¿ƒæ–·èª",
      "analysis": [{"title": "é …ç›®", "desc": "è§£æå…§å®¹"}],
      "elements": {"wood": 0.2, "fire": 0.2, "earth": 0.2, "metal": 0.2, "water": 0.2},
      "visuals": [{"prompt": "AI Art Prompt", "label": "æ„è±¡æ™¯è‡´"}],
      "decisions": {"do": "å®œ", "dont": "å¿Œ", "core": "å®šè«–"}
    }`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${DECODED_API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const json = await res.json();
        let clean = json.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
        FINAL_DATA = JSON.parse(clean);
        
        renderResults();
        msg("ç²¾ç®—å®Œæˆï¼Œè«‹æŸ¥é–±å„åˆ†é ã€‚");
        $('[data-target=pg-logic]').click();
    } catch (e) {
        msg("ç²¾ç®—å¤±æ•—: " + e.message);
    }
}

function renderResults() {
    // é‚è¼¯é 
    let hLogic = `<div class="card"><div class="card-title">ğŸ”® å¤©æ©Ÿæ‘˜è¦</div><p style="font-size:0.55rem; font-weight:bold;">${FINAL_DATA.summary}</p></div>`;
    FINAL_DATA.analysis.forEach(a => {
        hLogic += `<div class="card"><div class="card-title">${a.title}</div><p>${a.desc}</p></div>`;
    });
    $('#pg-logic').html(hLogic);

    // èƒ½é‡åˆ—è¡¨
    let hEng = `<div class="card"><table style="width:100%;">`;
    const labels = {wood:"æœ¨(ä»)", fire:"ç«(ç¦®)", earth:"åœŸ(ä¿¡)", metal:"é‡‘(ç¾©)", water:"æ°´(æ™º)"};
    Object.entries(FINAL_DATA.elements).forEach(([k,v]) => {
        hEng += `<tr><td style="font-weight:900; padding:8px;">${labels[k]}</td><td style="text-align:right;">${(v*100).toFixed(1)}%</td></tr>`;
    });
    $('#energy-list').html(hEng + `</table></div>`);

    // æ±ºç­–é 
    $('#pg-result').html(`
        <div class="card" style="background:var(--gold-grad); text-align:center; padding:30px;">
            <div style="font-size:0.65rem; font-weight:900; color:#3E2723;">${FINAL_DATA.decisions.core}</div>
        </div>
        <div class="card"><div class="card-title">ğŸŒŸ å®œ</div><p style="color:#1B5E20; font-weight:900;">${FINAL_DATA.decisions.do}</p></div>
        <div class="card"><div class="card-title">âš ï¸ å¿Œ</div><p style="color:#B71C1C; font-weight:900;">${FINAL_DATA.decisions.dont}</p></div>
    `);

    renderArt();
}

async function renderArt() {
    let hArt = "";
    for(let i=0; i<FINAL_DATA.visuals.length; i++){
        const v = FINAL_DATA.visuals[i];
        const cid = `img-box-${i}`;
        hArt += `<div class="card"><div class="card-title">${v.label}</div><div class="img-container" id="${cid}"><span class="img-label">Imagen 4.0 æ¸²æŸ“ä¸­...</span></div></div>`;
        
        (async () => {
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${DECODED_API_KEY}`, {
                    method: "POST",
                    body: JSON.stringify({ instances: { prompt: v.prompt }, parameters: { sampleCount: 1 } })
                });
                const d = await r.json();
                const b64 = d.predictions[0].bytesBase64Encoded;
                $(`#${cid}`).html(`<img src="data:image/png;base64,${b64}">`);
            } catch(e) {
                $(`#${cid}`).html('<span class="img-label" style="color:#F44336;">æ„è±¡æ¸²æŸ“é€¾æ™‚</span>');
            }
        })();
    }
    $('#pg-art').html(hArt);
}

function drawForce() {
    const el = d3.select("#d3-stage");
    el.selectAll("*").remove();
    const w = $('#d3-stage').width(), h = 350;
    const svg = el.append("svg").attr("width", w).attr("height", h);
    
    const colors = {wood:"#4CAF50", fire:"#FF5252", earth:"#FBC02D", metal:"#BDBDBD", water:"#2196F3"};
    const names = {wood:"æœ¨", fire:"ç«", earth:"åœŸ", metal:"é‡‘", water:"æ°´"};
    const nodes = Object.entries(FINAL_DATA.elements).map(([k,v]) => ({
        id: k, name: names[k], r: 35 + (v * 100), color: colors[k]
    }));

    const sim = d3.forceSimulation(nodes)
        .force("center", d3.forceCenter(w/2, h/2))
        .force("collide", d3.forceCollide().radius(d => d.r + 10))
        .force("charge", d3.forceManyBody().strength(-200));

    const g = svg.selectAll("g").data(nodes).enter().append("g");
    g.append("circle").attr("r", d => d.r).attr("fill", d => d.color).attr("stroke", "#FFD700").attr("stroke-width", 2);
    g.append("text").text(d => d.name).attr("text-anchor", "middle").attr("dy", ".35em").style("font-weight", "900").style("fill", "#FFF").style("font-size", "0.6rem");

    sim.on("tick", () => g.attr("transform", d => `translate(${d.x},${d.y})`));
}

function downloadCode() {
    const blob = new Blob([document.documentElement.outerHTML], {type: "text/html"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "G45_HEX_CORE_EXPORT.html";
    a.click();
}

$(document).ready(() => {
    init();
    $('.tab').click(function() {
        $('.tab, .page').removeClass('active');
        $(this).addClass('active');
        $(`#${$(this).data('target')}`).addClass('active');
        if($(this).data('target') === 'pg-energy' && FINAL_DATA) setTimeout(drawForce, 50);
    });
    $('#btn-run').click(execute);
});
</script>
</body>
</html>

