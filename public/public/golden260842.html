<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é‡‘ç¢§åå…¨å…¨ç®—è¡“ä¿®æ­£ç‰ˆ G-4.5</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">

<!-- å®˜æ–¹æ¨™æº–åº« -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>

<style>
:root {
    --bg-gold: #FFFDE7;
    --coin-gold: #FFD700;
    --main-gold: #D4AF37;
    --deep-gold: #B8860B;
    --text-brown: #3E2723;
    --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%);
    --font-size: 0.5rem; /* åš´æ ¼é–å®š 0.5rem */
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

body {
    font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
    background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png');
    color: var(--text-brown);
    font-size: var(--font-size);
    overflow-x: hidden;
}

header {
    height: 70px; background: var(--gold-grad);
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 10px; border-bottom: 3px solid var(--deep-gold);
    position: sticky; top: 0; z-index: 1000;
}

.header-title { font-weight: 900; font-size: 0.55rem; }

.nav-tabs {
    display: flex; background: #FFF; border-bottom: 2px solid var(--main-gold);
    position: sticky; top: 70px; z-index: 999;
}

.tab {
    flex: 1; text-align: center; padding: 12px 0; font-weight: 900;
    color: #A68B5A; cursor: pointer; font-size: var(--font-size);
}

.tab.active {
    background: rgba(255, 215, 0, 0.2);
    border-bottom: 4px solid var(--deep-gold);
    color: var(--text-brown);
}

.content-area { padding: 10px; padding-bottom: 80px; }
.page { display: none; }
.page.active { display: block; }

.card {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid var(--coin-gold);
    border-radius: 10px; padding: 12px; margin-bottom: 12px;
    box-shadow: 0 4px 8px rgba(184, 134, 11, 0.1);
}

.card-title {
    font-size: var(--font-size); font-weight: 900;
    margin-bottom: 8px; color: #5D4037;
    border-left: 4px solid var(--deep-gold); padding-left: 8px;
}

textarea {
    width: 100%; height: 200px; border: 2px solid var(--main-gold);
    border-radius: 6px; padding: 10px; font-size: var(--font-size);
    background: #FFFEF2; resize: none; line-height: 1.4; outline: none;
}

.btn {
    width: 100%; padding: 14px; border: none; border-radius: 8px;
    font-weight: 900; font-size: var(--font-size); cursor: pointer;
    margin-top: 8px; transition: all 0.2s;
}
.btn-primary { background: var(--gold-grad); color: var(--text-brown); border: 1px solid var(--deep-gold); }
.btn-secondary { background: #FFF; border: 1px solid var(--main-gold); width: auto; font-size: 0.5rem; padding: 4px 8px; }

.math-block { background: #F7F1E3; padding: 8px; border-radius: 5px; margin: 6px 0; border-left: 3px solid var(--main-gold); }
.formula { font-family: 'Courier New', monospace; color: #8B4513; font-weight: bold; }
.result-val { color: #D32F2F; font-weight: 900; }

#analysis-overlay {
    position: fixed; inset: 0; background: rgba(255, 253, 231, 0.98);
    z-index: 10000; display: none; flex-direction: column;
    align-items: center; justify-content: center; text-align: center;
}
.progress-container {
    width: 80%; height: 10px; background: #EEE; border-radius: 5px;
    border: 2px solid var(--main-gold); overflow: hidden; margin: 15px 0;
}
.progress-bar { width: 0%; height: 100%; background: var(--gold-grad); transition: width 0.3s; }

#msg-box { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 11000; width: 90%; pointer-events: none; }
.msg-item { background: rgba(62, 39, 35, 0.95); color: var(--coin-gold); padding: 10px; border-radius: 6px; font-size: 0.5rem; text-align: center; margin-top: 4px; border: 1px solid var(--coin-gold); }

#init-overlay { position: fixed; inset: 0; background: var(--bg-gold); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }

@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="init-overlay">
    <div style="width: 35px; height: 35px; border: 4px solid #F3F3F3; border-top: 4px solid var(--coin-gold); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div style="margin-top:12px; font-weight:900; color:var(--deep-gold); font-size:0.5rem">ç®—è¡“å¼•æ“åˆå§‹åŒ–ç’°å¢ƒ...</div>
</div>

<div id="analysis-overlay">
    <div style="font-size: 0.6rem; font-weight: 900; color:var(--deep-gold)">âš¡ ç®—è¡“ç¥ç¶“å…ƒéˆæ¥ä¸­ âš¡</div>
    <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
    <div id="p-text" style="font-size:0.5rem; font-weight:900; color:var(--deep-gold);">API æ¡æ‰‹ä¸­...</div>
</div>

<div id="msg-box"></div>

<header>
    <div class="header-title">ğŸ›ï¸ é‡‘ç¢§åå…¨ G-4.5 (ä¿®æ­£ç§»æ¤ç‰ˆ)</div>
    <button class="btn-secondary" onclick="exportFullCode()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼</button>
</header>

<nav class="nav-tabs">
    <div class="tab active" data-p="0">æ•¸æ“šè¼¸å…¥</div>
    <div class="tab" data-p="1">ç®—è¡“å ±å‘Š</div>
    <div class="tab" data-p="2">æ„è±¡æ¼”ç®—</div>
</nav>

<div class="content-area">
    <section id="pg-0" class="page active">
        <div class="card">
            <div class="card-title">ğŸ”® æ¨æ¼”åƒæ•¸è¼‰å…¥</div>
            <textarea id="main-input"></textarea>
            <button id="btn-run" class="btn btn-primary" disabled>è¼‰å…¥å­—å…¸ä¸­...</button>
        </div>
        <div class="card">
            <div style="font-weight:900">ç³»çµ±æµæ°´: <span id="sn-display" style="color:var(--deep-gold)">---</span></div>
            <div style="font-size:0.45rem; color:gray; margin-top:5px;">*æœ¬ç¨‹å¼å·²æ•´åˆé›¢ç·šç®—è¡“é‚è¼¯ï¼ŒAPI æ•…éšœæ™‚ä»å¯é‹ä½œã€‚</div>
        </div>
    </section>

    <section id="pg-1" class="page">
        <div id="math-report-container">
            <div style="text-align:center; padding:50px; color:var(--main-gold); font-weight:900">è«‹å•Ÿå‹•ç®—è¡“æ¨æ¼”ä»¥ç”Ÿæˆæ•¸æ“š</div>
        </div>
    </section>

    <section id="pg-2" class="page">
        <div class="card">
            <div class="card-title">ğŸ–¼ï¸ é‡‘é—• AI åˆæˆæ„è±¡</div>
            <div id="ai-vision-container" style="width:100%; aspect-ratio:1/1; background:#000; border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
                <div id="ai-vision-status" style="color:var(--coin-gold); text-align:center;">âŒ› ç­‰å¾…ç®—è¡“å¼•æ“åŒ¯å‡ºæ•¸æ“š</div>
                <div id="loader-icon" style="display:none; position:absolute; width:40px; height:40px; border:4px solid #FFF; border-top:4px solid var(--coin-gold); border-radius:50%; animation:spin 1s linear infinite;"></div>
                <img id="ai-vision-img" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
            <div id="vision-desc" style="padding:10px; font-weight:900; text-align:center; color:var(--deep-gold);"></div>
        </div>
    </section>
</div>

<script>
/**
 * ==========================================================================
 * å…¨åŸŸé…ç½®èˆ‡ API æŒ‡æ•¸é€€é¿é‚è¼¯
 * ==========================================================================
 */
const apiKey = ""; // åŸ·è¡Œç’°å¢ƒå°‡è‡ªå‹•æ³¨å…¥
const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'g45-math-fix';
const SN_CODE = "G45-" + Math.random().toString(36).substr(2, 6).toUpperCase();

const DICT_URLS = {
    cjk: "https://raw.githubusercontent.com/max32002/chinese_dictionary/0db110bb3dbe335a956732413557a710ef6901dc/Dictionary.json",
    astro: "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json"
};

let REMOTE_DATA = { cjk: null, astro: null };
let CALC_STATE = {};

// æŒ‡æ•¸å‹é€€é¿è«‹æ±‚å‡½å¼
async function fetchWithRetry(url, options, maxRetries = 5) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const res = await fetch(url, options);
            if (res.ok) return await res.json();
            if (res.status === 429 || res.status >= 500) {
                const delay = Math.pow(2, i) * 1000;
                await new Promise(r => setTimeout(r, delay));
                continue;
            }
            throw new Error(`HTTP Error: ${res.status}`);
        } catch (e) {
            if (i === maxRetries - 1) throw e;
            await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
        }
    }
}

/**
 * ==========================================================================
 * ç®—è¡“æ¨æ¼”æ ¸å¿ƒ (Pure Math Engine)
 * ==========================================================================
 */
const CoreMath = {
    // 1. äº”è¡ŒçŸ©é™£æ¼”ç®—
    elements: (w, f, e, m, h) => {
        const arr = [w, f, e, m, h];
        const Î¼ = arr.reduce((a, b) => a + b, 0) / 5;
        const variance = arr.reduce((a, b) => a + Math.pow(b - Î¼, 2), 0) / 5;
        const sd = Math.sqrt(variance);
        const stability = Math.max(0, 100 - (sd * 4)).toFixed(2);
        return { Î¼, variance, sd, stability, formula: "S = 100 - (Ïƒ * 4)" };
    },
    // 2. æ°£é‹å‹•æ…‹ä¿®æ­£
    fortune: (base, cloud, rain) => {
        const cFactor = (cloud / 100) * 1.5;
        const rFactor = rain ? -7.5 : 2.5;
        const result = (base + cFactor + rFactor).toFixed(2);
        return { result, formula: `F = B + (C/100*1.5) + R` };
    },
    // 3. æ˜Ÿé«”é‡åŠ›çŸ©èˆ‡å¤¾è§’
    gravity: (deg) => {
        const rad = deg * (Math.PI / 180);
        const torque = Math.abs(Math.cos(rad)).toFixed(4);
        const impact = (torque * 100).toFixed(2);
        return { torque, impact, formula: `I = |cos(Î¸)| * 100` };
    }
};

/**
 * ==========================================================================
 * ä»‹é¢æ“æ§é‚è¼¯
 * ==========================================================================
 */
function showMsg(t) {
    const el = $(`<div class="msg-item">${t}</div>`);
    $('#msg-box').append(el);
    setTimeout(() => el.fadeOut(400, () => el.remove()), 3000);
}

async function loadDictionaries() {
    try {
        // ä¸¦è¡ŒåŠ è¼‰ä»¥ç¯€çœæ™‚é–“
        const [cjk, astro] = await Promise.all([
            fetch(DICT_URLS.cjk).then(r => r.json()),
            fetch(DICT_URLS.astro).then(r => r.json())
        ]);
        REMOTE_DATA.cjk = cjk;
        REMOTE_DATA.astro = astro;
        showMsg("ğŸ“š å­—å…¸é›†è¼‰å…¥å®Œç•¢");
        $('#btn-run').prop('disabled', false).text('ğŸš€ å•Ÿå‹•å…¨ç®—è¡“æ¨æ¼”');
    } catch (e) {
        showMsg("âš ï¸ é ç«¯æ•¸æ“šé€£ç·šå—é˜»ï¼Œæ¡ç”¨æœ¬åœ°éœæ…‹ç®—è¡“æ¨¡å¼");
        $('#btn-run').prop('disabled', false).text('ğŸš€ å•Ÿå‹•æœ¬åœ°ç®—è¡“æ¨¡å¼');
    }
}

async function runInference() {
    $('#analysis-overlay').css('display', 'flex');
    const pBar = $('#p-bar');
    const pText = $('#p-text');

    const workflow = [
        { t: "æ˜ å°„äº”è¡ŒçŸ©é™£...", p: 20 },
        { t: "æ ¡æº–ç’°å¢ƒæ°£é‹åƒæ•¸...", p: 40 },
        { t: "è¨ˆç®—åœŸæ˜Ÿåè§’åŠ›çŸ©...", p: 60 },
        { t: "è«‹æ±‚ AI ç¸½çµèªç¾©...", p: 80 },
        { t: "åˆæˆè¦–è¦ºæ„è±¡ Prompt...", p: 100 }
    ];

    for (const step of workflow) {
        pText.text(step.t);
        pBar.css('width', `${step.p}%`);
        await new Promise(r => setTimeout(r, 450));
    }

    // åŸ·è¡Œæ ¸å¿ƒç®—è¡“
    CALC_STATE.e = CoreMath.elements(28, 35, 25, 20, 35);
    CALC_STATE.f = CoreMath.fortune(64, 100, true);
    CALC_STATE.g = CoreMath.gravity(2.8);

    try {
        // å‘¼å« Gemini é€²è¡Œç¸½çµ
        const summary = await callGeminiReport();
        renderReport(summary);
        
        // ç•°æ­¥ç”Ÿæˆåœ–ç‰‡ (ä¸é˜»å¡å ±è¡¨é¡¯ç¤º)
        generateImageAndDisplay(summary.image_prompt);

        switchPage(1);
        showMsg("âœ… ç®—è¡“å ±å‘Šç”ŸæˆæˆåŠŸ");
    } catch (e) {
        console.error(e);
        showMsg("âš ï¸ API è«‹æ±‚è¶…æ™‚ï¼Œé¡¯ç¤ºç´”ç®—è¡“çµæœ");
        renderReport({ summary: "ç›®å‰ API é€£ç·šç•°å¸¸ï¼Œä»¥ä¸‹ç‚ºç³»çµ±æ ¸å¿ƒç®—è¡“æ¨å°ä¹‹åŸå§‹æ•¸æ“šã€‚", image_prompt: "Abstract gold geometric pattern" });
        switchPage(1);
    } finally {
        $('#analysis-overlay').fadeOut();
    }
}

async function callGeminiReport() {
    const prompt = `ç®—è¡“çµæœï¼š
    - äº”è¡Œç©©å®šåº¦: ${CALC_STATE.e.stability}% (Ïƒ=${CALC_STATE.e.sd})
    - ä¿®æ­£æ°£é‹: ${CALC_STATE.f.result}
    - åœŸæ˜Ÿé‡åŠ›çŸ©æ„Ÿæ‡‰: ${CALC_STATE.g.impact}
    è«‹æ ¹æ“šã€Œè»«æœ¨èŸ¹å®ˆã€ä¹™å·³å¹´ã€ä¸Šå¼¦æœˆã€å°ä¸­é›¨ã€èƒŒæ™¯çµ¦å‡ºä¸€æ®µå°ˆæ¥­å åœç¸½çµ (100å­—å…§) èˆ‡ç¹ªåœ–æç¤ºè©ã€‚
    JSON æ ¼å¼: {"summary":"...", "image_prompt":"..."}`;

    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json" }
    };

    return await fetchWithRetry(url, { method: "POST", body: JSON.stringify(payload) });
}

async function generateImageAndDisplay(promptText) {
    $('#ai-vision-status').text("ğŸ¨ AI ç•«å¸ƒæ¸²æŸ“ä¸­...");
    $('#loader-icon').show();
    $('#ai-vision-img').hide();

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        const payload = { instances: { prompt: `Elegant Chinese astrology, golden aesthetic, ${promptText}, soft light` }, parameters: { sampleCount: 1 } };
        
        const data = await fetchWithRetry(url, { method: "POST", body: JSON.stringify(payload) });
        const base64 = data.predictions[0].bytesBase64Encoded;
        $('#ai-vision-img').attr('src', `data:image/png;base64,${base64}`).fadeIn();
        $('#ai-vision-status').hide();
        $('#loader-icon').hide();
        $('#vision-desc').text("å·²æˆåŠŸæ“·å–å¤©è±¡æ„è±¡");
    } catch (e) {
        $('#ai-vision-status').text("âŒ æ„è±¡ç”Ÿæˆå¤±æ•—");
        $('#loader-icon').hide();
    }
}

function renderReport(ai) {
    let html = `
    <div class="card" style="background:var(--gold-grad); border:none;">
        <div class="card-title">ğŸ”± é‡‘é—•ç®—è¡“æ ¸å¿ƒç¸½è©•</div>
        <div style="font-weight:900; line-height:1.6;">${ai.summary}</div>
    </div>
    <div class="card">
        <div class="card-title">ğŸ“Š äº”è¡Œç©©å®šåº¦æ¼”ç®— (Elements)</div>
        <div class="math-block">
            <div>å…¬å¼: <span class="formula">${CALC_STATE.e.formula}</span></div>
            <div>æ¨™æº–å·® Ïƒ: <span class="result-val">${CALC_STATE.e.sd.toFixed(2)}</span></div>
            <div>ç©©å®šä¿‚æ•¸: <span class="result-val">${CALC_STATE.e.stability}%</span></div>
        </div>
        <div style="font-size:0.45rem; color:#666;">è§£æï¼šç›®å‰èƒ½é‡åˆ†ä½ˆæ–¼æ°´èˆ‡ç«å…©ç«¯ï¼Œç©©å®šä¿‚æ•¸é©ä¸­ã€‚</div>
    </div>
    <div class="card">
        <div class="card-title">ğŸ“ˆ ç¤¾æœƒæ°£é‹å‹•æ…‹åŠ æ¬Š (Fortune)</div>
        <div class="math-block">
            <div>å…¬å¼: <span class="formula">${CALC_STATE.f.formula}</span></div>
            <div>ä¿®æ­£å¾ŒæŒ‡æ•¸: <span class="result-val">${CALC_STATE.f.result}</span></div>
        </div>
        <div style="font-size:0.45rem; color:#666;">è§£æï¼šé›¨æ°´å› å­å°æ°£é‹é€ æˆç´„ -7.5 çš„è² å‘åç§»ï¼Œé›²å±¤å‰‡æä¾›äº†ç©©å®šè¦†è“‹ã€‚</div>
    </div>
    <div class="card">
        <div class="card-title">ğŸª åœŸæ˜Ÿé‡åŠ›çŸ©æ„Ÿæ‡‰ (Gravity)</div>
        <div class="math-block">
            <div>å…¬å¼: <span class="formula">${CALC_STATE.g.formula}</span></div>
            <div>é¤˜å¼¦åŠ›çŸ©: <span class="result-val">${CALC_STATE.g.torque}</span></div>
            <div>æ„Ÿæ‡‰å¼·åº¦: <span class="result-val">${CALC_STATE.g.impact}</span></div>
        </div>
        <div style="font-size:0.45rem; color:#666;">è§£æï¼šåœŸæ˜Ÿåè§’ 2.8Â° æ¥è¿‘å‚ç›´å¼•åŠ›è»¸ï¼Œæ„Ÿæ‡‰å¼·åº¦æ¥µé«˜ã€‚</div>
    </div>`;

    $('#math-report-container').html(html);
}

function switchPage(i) {
    $('.tab').removeClass('active'); $(`.tab[data-p=${i}]`).addClass('active');
    $('.page').removeClass('active'); $(`#pg-${i}`).addClass('active');
}

function exportFullCode() {
    const b = new Blob([document.documentElement.outerHTML], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b); a.download = `G45_MATH_FIXED_REPORT.html`; a.click();
}

// åˆå§‹åŒ–å•Ÿå‹•
$(document).ready(() => {
    $('#sn-display').text(SN_CODE);
    $('#main-input').val(`æœˆâ†’æœ€è¿‘è¡Œæ˜Ÿ: Saturn | å¤ªé™½: 78.5Â° | æ°´æ˜Ÿ: 94.1Â° | é‡‘æ˜Ÿ: 81.3Â° | ç«æ˜Ÿ: 74.7Â°
å¹²æ”¯ï¼šä¹™å·³ æˆŠå­æœˆ åºšåˆæ—¥ åºšè¾°æ™‚
å®¿æ›œï¼šğŸŒ  è»«æœ¨èŸ¹ (æœ¨) | çŠ¯ / å®ˆ / åˆï¼šå®ˆ
äº”è¡Œèƒ½é‡ï¼šæœ¨:28 ç«:35 åœŸ:25 é‡‘:20 æ°´:35
æ°£é‹: 64 | å€åŸŸ: å°ä¸­ | é›²å±¤: 100% | å¤©æ°£: é›¨`);
    
    loadDictionaries();
    $('#init-overlay').fadeOut(600);
});

$('.tab').click(function(){ switchPage($(this).data('p')); });
$('#btn-run').click(runInference);

</script>
</body>
</html>
