<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡‘ç¢§åå…¨ G-4.5 æ——è‰¦ç‰ˆ (945 Lines Edition)</title>
    <!-- å¼•ç”¨å¤–éƒ¨æ¨™æº–åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        window.fb = { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, query, orderBy, limit };
    </script>
    <style>
        /* åš´æ ¼æ§åˆ¶è®Šæ•¸èˆ‡ 0.5rem å­—é«” */
        :root {
            --bg-gold: #FFFDE7;
            --main-gold: #D4AF37;
            --deep-gold: #B8860B;
            --coin-gold: #FFD700;
            --text-brown: #3E2723;
            --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%);
            --font-size: 0.5rem;
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png') fixed;
            color: var(--text-brown);
            font-size: var(--font-size);
            line-height: 1.6;
            width: 100vw; 
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* å³å´æ‡¸æµ® Logo å€ */
        .side-logo {
            position: fixed;
            right: 12px;
            top: 65px;
            width: 45px;
            height: 45px;
            background: var(--gold-grad);
            border: 2.5px solid var(--deep-gold);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.55rem;
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.4);
            z-index: 1001;
            animation: pulse 2.5s infinite;
        }
        .side-logo span { font-size: 0.35rem; line-height: 1; }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 12px rgba(212, 175, 55, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        header {
            height: 55px; background: var(--gold-grad);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 3px solid var(--deep-gold);
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }

        .nav-tabs {
            display: flex; background: #FFF; border-bottom: 2.5px solid var(--main-gold);
            position: sticky; top: 55px; z-index: 999;
            width: 100%;
        }

        .tab {
            flex: 1; text-align: center; padding: 12px 0; font-weight: 900;
            color: #A68B5A; cursor: pointer; font-size: var(--font-size);
            transition: all 0.3s;
            border-right: 1px solid #f0f0f0;
        }

        .tab.active { background: rgba(255, 215, 0, 0.3); border-bottom: 4px solid var(--deep-gold); color: var(--text-brown); }

        .progress-container { 
            padding: 10px 15px; 
            background: #FFF9C4; 
            border-bottom: 2px solid var(--coin-gold);
            position: sticky;
            top: 100px;
            z-index: 998;
        }

        .progress-bar { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin-top: 6px; border: 1px solid #ccc; }
        .progress-fill { height: 100%; background: var(--gold-grad); width: 0%; transition: width 0.5s cubic-bezier(0.1, 0.7, 1.0, 0.1); }

        .content-area { padding: 15px; padding-bottom: 100px; }
        .page { display: none; opacity: 0; }
        .page.active { display: block; opacity: 1; transition: opacity 0.6s ease; }

        .card {
            background: var(--card-bg); 
            border: 2px solid var(--coin-gold);
            border-radius: 14px; 
            padding: 18px; 
            margin-bottom: 18px;
            box-shadow: 5px 5px 18px rgba(184, 134, 11, 0.2);
            position: relative;
        }

        .title-gold {
            color: var(--deep-gold);
            font-weight: 900;
            border-left: 5px solid var(--main-gold);
            padding-left: 10px;
            margin-bottom: 12px;
            font-size: 0.55rem;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.8);
        }

        textarea {
            width: 100%; height: 160px; border: 2px solid var(--main-gold);
            border-radius: 10px; padding: 12px; font-size: var(--font-size);
            background: #FFFEF5; resize: none; outline: none;
            color: var(--text-brown);
            line-height: 1.8;
            font-family: 'Courier New', monospace;
        }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-weight: 900; font-size: var(--font-size); cursor: pointer; 
            text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        .btn:active { transform: translateY(3px); box-shadow: none !important; }
        .btn-primary { background: var(--gold-grad); color: var(--text-brown); border: 2.5px solid var(--deep-gold); box-shadow: 0 5px 0 var(--deep-gold); }
        .btn-secondary { background: #f5f5f5; color: #666; border: 2px solid #ccc; box-shadow: 0 4px 0 #999; }
        .btn-action { background: #FFF8E1; border: 1.5px solid var(--main-gold); padding: 8px; font-size: 0.45rem; border-radius: 6px; }
        .btn-mini { width: auto; padding: 6px 12px; font-size: 0.45rem; background: #FFF; border: 1.5px solid var(--main-gold); border-radius: 6px; }

        /* æ„è±¡åœ–å€åŸŸ */
        .visual-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .visual-item { position: relative; border-radius: 12px; overflow: hidden; border: 3px solid var(--main-gold); background: #fdfdfd; min-height: 200px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .visual-label { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: gold; padding: 4px 10px; border-radius: 6px; font-weight: 900; z-index: 2; border: 1px solid gold; }
        .visual-img { width: 100%; height: auto; display: block; min-height: 200px; object-fit: cover; }

        /* ä¸‹æ–¹ç¸½çµå€ */
        .summary-footer {
            background: var(--gold-grad);
            border: 3px solid var(--deep-gold);
            padding: 20px;
            margin-top: 25px;
            border-radius: 15px;
            font-weight: 700;
            color: var(--text-brown);
            box-shadow: 0 -5px 15px rgba(212, 175, 55, 0.3);
        }

        #msg-box { position: fixed; bottom: 25px; width: 92%; left: 4%; z-index: 2000; pointer-events: none; }
        .msg-item { background: rgba(62, 39, 35, 0.95); color: #FFD700; padding: 10px 16px; border-radius: 8px; margin-top: 8px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1.5px solid var(--coin-gold); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #env-lock { 
            position: fixed; inset: 0; background: rgba(255,253,231,0.99); z-index: 9999;
            color: var(--deep-gold); display: none; align-items: center; justify-content: center; text-align: center; padding: 40px;
        }

        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; gap: 10px; }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--main-gold);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å·è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-gold); }
        ::-webkit-scrollbar-thumb { background: var(--main-gold); border-radius: 10px; }
    </style>
</head>
<body>

<div id="env-lock">
    <div class="card" style="max-width:320px;">
        <h2 style="font-size: 0.9rem;">ğŸ›¡ï¸ å®‰å…¨æ²™ç›’å•Ÿå‹•</h2>
        <hr style="margin:15px 0; border:1.5px solid var(--coin-gold);">
        <p>åµæ¸¬åˆ°éæˆæ¬ŠåŸ·è¡Œè·¯å¾‘ã€‚<br>åå…¨é›²ç«¯ API éœ€åœ¨å°ˆå±¬ Immersive ç’°å¢ƒé‹è¡Œã€‚<br>ç›®å‰åƒ…æä¾›æ•¸æ“šæš«å­˜æ¨¡å¼ã€‚</p>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="$('#env-lock').fadeOut()">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<div class="side-logo">
    G45
    <span>TEN-FULL</span>
</div>

<header>
    <div style="font-weight:900; display:flex; align-items:center; gap:8px;">
        <span style="font-size:0.8rem;">ğŸ”±</span> é‡‘ç¢§åå…¨å…¨ç®—è¡“ Pro
    </div>
    <div style="display:flex; gap:5px;">
        <button class="btn-mini" onclick="downloadCode()">ğŸ’¾ ä¸‹è¼‰</button>
    </div>
</header>

<div class="progress-container">
    <div style="display:flex; justify-content:space-between; font-weight:900; color: var(--deep-gold);">
        <span id="step-text">ç®—è¡“å¤©ç›¤å·²æ­¸ä½</span>
        <span id="step-percent">0%</span>
    </div>
    <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
</div>

<nav class="nav-tabs">
    <div class="tab active" onclick="switchTab(0)">å¤©æ©ŸéŒ„å…¥</div>
    <div class="tab" onclick="switchTab(1)">å…¨ç®—åˆ†æ</div>
    <div class="tab" onclick="switchTab(2)">ä¸‰æ‰æ„è±¡</div>
    <div class="tab" onclick="switchTab(3)">é›²ç«¯å·è»¸</div>
</nav>

<div class="content-area">
    <!-- é é¢ 0: è¼¸å…¥ -->
    <div id="p0" class="page active">
        <div class="card">
            <div class="title-gold">ğŸ“œ åå…¨å…¨ç®—è¡“éŒ„å…¥</div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn-action" onclick="loadTemplate()">ğŸ“‹ è¼‰å…¥ç¯„æœ¬</button>
                <button class="btn-action" onclick="pasteFromClipboard()">ğŸ“¥ è²¼ä¸Šå‰ªè²¼ç°¿</button>
                <button class="btn-action" onclick="clearInput()" style="color: #c62828;">ğŸ§¹ ä¸€éµæ¸…é™¤</button>
            </div>
            <textarea id="inp-data" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æˆ–è²¼ä¸Šå¤©æ©Ÿæ•¸æ“š..."></textarea>
            <button id="main-run-btn" class="btn btn-primary" style="margin-top:15px;" onclick="runComprehensiveProcess()">
                ğŸš€ å•Ÿå‹•åå…¨å…¨ç®—è¡“æ¨æ¼”
            </button>
        </div>
        
        <div class="card">
            <div class="title-gold">ğŸ” æ ¸å¿ƒç‹€æ…‹ç›£æ¸¬</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <div>ğŸ“ åŸ·è¡ŒåŸŸï¼š<span id="env-tag" style="color:var(--deep-gold); font-weight:900;">...</span></div>
                <div>ğŸ“¡ å­—å…¸åº«ï¼š<span id="dict-status" style="font-weight:900;">é€£ç·šä¸­...</span></div>
                <div>â˜ï¸ é›²ç«¯æ¬Šé™ï¼š<span id="auth-status" style="font-weight:900;">å°šæœªæˆæ¬Š</span></div>
            </div>
        </div>

        <div class="card" style="border-style: dashed; opacity: 0.8;">
            <p>â€» æœ¬ç³»çµ±æ•´åˆ D3.js åº§æ¨™è¨ˆç®—ã€Astronomy Engine æ˜Ÿåœ–æ¨¡çµ„ã€åŠ Gemini 2.5 èªè¨€æ¨¡å‹é€²è¡Œæ·±åº¦ä¸‰æ‰æ„è±¡åˆ¤è®€ã€‚</p>
        </div>
    </div>

    <!-- é é¢ 1: å ±å‘Š -->
    <div id="p1" class="page">
        <div class="card">
            <div class="title-gold">ğŸ“ ä¹¾å¤åå…¨å…¨ç®—è¡“å ±å‘Š</div>
            <div id="report-content" style="min-height:300px; white-space:pre-wrap; line-height:2;">å°šæœªé€²è¡Œæ¨æ¼”ã€‚</div>
        </div>
    </div>

    <!-- é é¢ 2: æ„è±¡ -->
    <div id="p2" class="page">
        <div class="visual-grid">
            <div class="visual-item">
                <div class="visual-label">ã€å¤©ã€‘å¤©æ©Ÿé¡¯è±¡</div>
                <div id="loader-1" class="loader-container" style="display:none;"><div class="loader"></div><p>æç¹ªå¤©æ„ä¸­...</p></div>
                <img id="img-sky" class="visual-img" style="display:none;">
            </div>
            <div class="visual-item">
                <div class="visual-label">ã€åœ°ã€‘åœ°è„ˆçµæ°£</div>
                <div id="loader-2" class="loader-container" style="display:none;"><div class="loader"></div><p>å‡èšåœ°æ°£ä¸­...</p></div>
                <img id="img-earth" class="visual-img" style="display:none;">
            </div>
            <div class="visual-item">
                <div class="visual-label">ã€äººã€‘äººå’Œæ„Ÿæ‡‰</div>
                <div id="loader-3" class="loader-container" style="display:none;"><div class="loader"></div><p>æ„Ÿæ‡‰äººæ°£ä¸­...</p></div>
                <img id="img-human" class="visual-img" style="display:none;">
            </div>
        </div>
        
        <div id="final-summary-box" class="summary-footer" style="display:none;">
            <div class="title-gold" style="color:var(--text-brown); border-color:var(--text-brown); margin-bottom:15px;">ğŸ”® åå…¨å…¨ç®—è¡“ç¸½çµ</div>
            <div id="summary-text" style="font-size:0.55rem; line-height:1.8;"></div>
        </div>
    </header>

    <!-- é é¢ 3: æ­·å² -->
    <div id="p3" class="page">
        <div class="title-gold">ğŸ“œ é›²ç«¯å·è»¸æ­·å²</div>
        <div id="history-list"></div>
    </div>
</div>

<div id="msg-box"></div>

<script>
    /**
     * @file G_PRO_945_GOLD.html
     * @description åå…¨å…¨ç®—è¡“å°ˆæ¥­ç‰ˆ - æ——è‰¦åŠŸèƒ½æ“´å±•ã€‚
     */

    const apiKey = ""; 
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'gold-arithmetic-945-v2';
    const isGemini = typeof __app_id !== 'undefined';
    const DICT_URL = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

    let db, auth, user;
    let astrologyDict = null;

    // --- åˆå§‹åŒ– ---
    async function init() {
        $('#env-tag').text(isGemini ? "Gemini æˆæ¬Šç’°å¢ƒ" : "å¤–éƒ¨è‡¨æ™‚ç’°å¢ƒ");
        
        if (!isGemini && window.location.hostname.includes('github')) {
            $('#env-lock').fadeIn();
        }

        try {
            const resp = await fetch(DICT_URL);
            astrologyDict = await resp.json();
            $('#dict-status').text("æ ¸å¿ƒåº«å·²å°±ç·’").css('color', '#2e7d32');
        } catch (e) {
            $('#dict-status').text("è¼‰å…¥å¤±æ•—").css('color', '#c62828');
        }

        if (isGemini) {
            try {
                const config = JSON.parse(__firebase_config);
                const app = fb.initializeApp(config);
                auth = fb.getAuth(app);
                db = fb.getFirestore(app);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await fb.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await fb.signInAnonymously(auth);
                    }
                };
                
                await initAuth();
                fb.onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        $('#auth-status').text(`é€£ç·šä¸­ (${user.uid.substring(0,8)})`).css('color', '#2e7d32');
                        loadHistory();
                    }
                });
            } catch (e) {
                log("é›²ç«¯æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—");
            }
        }
    }

    // --- ä»‹é¢åŠŸèƒ½ ---
    function log(m) {
        const div = $('<div class="msg-item"></div>').text(m);
        $('#msg-box').append(div);
        setTimeout(() => div.fadeOut(600, () => div.remove()), 4500);
    }

    function setProgress(p, t) {
        $('#progress-fill').css('width', p + '%');
        $('#step-percent').text(p + '%');
        $('#step-text').text(t);
    }

    function switchTab(i) {
        $('.page').removeClass('active');
        $(`#p${i}`).addClass('active');
        $('.tab').removeClass('active');
        $(`.tab:eq(${i})`).addClass('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- ç·¨è¼¯åŠŸèƒ½ ---
    function clearInput() {
        $('#inp-data').val('').focus();
        log("ğŸ§¹ å·²æ¸…é™¤è¼¸å…¥å…§å®¹");
    }

    async function pasteFromClipboard() {
        try {
            // æ³¨æ„ï¼šiframe å…§å¯èƒ½å—é™ï¼Œéœ€é€é execCommand å‚™æ¡ˆ
            const text = await navigator.clipboard.readText();
            if (text) {
                $('#inp-data').val(text);
                log("ğŸ“¥ å·²å¾å‰ªè²¼ç°¿è²¼ä¸Šæ•¸æ“š");
            } else {
                log("å‰ªè²¼ç°¿ç‚ºç©º");
            }
        } catch (e) {
            log("ç„¡æ³•å­˜å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Šã€‚");
        }
    }

    function loadTemplate() {
        const template = `æœˆâ†’æœ€è¿‘è¡Œæ˜Ÿ: Saturn | å¤ªé™½: 56.7Â° | æ°´æ˜Ÿ (è¾°æ˜Ÿ): 73.4Â° | é‡‘æ˜Ÿ (å¤ªç™½): 60.1Â° | ç«æ˜Ÿ (ç†’æƒ‘): 52.4Â° | æœ¨æ˜Ÿ (æ­²æ˜Ÿ): 216.3Â° | åœŸæ˜Ÿ (é®æ˜Ÿ): 26.7Â°
æœˆç›¸ï¼šä¸Šå¼¦
å¹²æ”¯ï¼šä¹™å·³å¹´ æˆŠå­æœˆ æˆŠè¾°æ—¥ ä¹™å¯æ™‚
ç¯€æ°£ï¼šå°å¯’ï¼ˆè·é›¢ 11 å¤©ï¼‰
å®¿æ›œï¼šğŸŒ  å¼µæœˆé¹¿ (æ°´)
çŠ¯ / å®ˆ / åˆï¼šå¼µæœˆé¹¿:å®ˆ | ç¿¼ç«è›‡:çŠ¯
äº”è¡Œåˆæˆèƒ½é‡ï¼šæœ¨:25 ç«:33 åœŸ:25 é‡‘:20 æ°´:38
ç¤¾æœƒæ°£é‹ï¼š63
å¤©æ°£ç‹€æ³ï¼šé™°å¤© | é›²å±¤ 93% | é¢¨é€Ÿ 4.3 km/h`;
        $('#inp-data').val(template);
        log("ğŸ“‹ ç¯„æœ¬è¼‰å…¥æˆåŠŸ");
    }

    // --- æ¨æ¼”æ ¸å¿ƒ ---
    async function runComprehensiveProcess() {
        const input = $('#inp-data').val();
        if (input.length < 10) return log("å¤©æ©Ÿä¸è¶³ï¼Œè«‹éŒ„å…¥æ›´å¤šæ•¸æ“š");

        $('#main-run-btn').prop('disabled', true).text('âš¡ æ¨æ¼”é‹è¡Œä¸­...');
        
        try {
            setProgress(10, "è§£æå¤©å¹²åœ°æ”¯èˆ‡å®¿æ›œ...");
            const analysis = await callGeminiAnalysis(input);
            
            setProgress(30, "ç”¢å‡ºå…¨ç®—åˆ†æå ±å‘Š...");
            $('#report-content').html(analysis.report);
            $('#summary-text').text(analysis.summary);
            $('#final-summary-box').fadeIn();

            setProgress(45, "ç¹ªè£½ã€å¤©ã€‘ä¹‹æ„è±¡...");
            await generateTripletImage('sky', analysis.skyPrompt);
            
            setProgress(65, "å‡èšã€åœ°ã€‘ä¹‹æ ¼å±€...");
            await generateTripletImage('earth', analysis.earthPrompt);
            
            setProgress(85, "æ„Ÿæ‡‰ã€äººã€‘ä¹‹æ°£é‹...");
            await generateTripletImage('human', analysis.humanPrompt);

            if (user && db) {
                setProgress(95, "å°‡å› æœå¯«å…¥é›²ç«¯å·è»¸...");
                await saveAnalysis(input, analysis);
            }

            setProgress(100, "åå…¨æ¨æ¼”å¤§åŠŸå‘Šæˆ");
            log("âœ… ç®—è¡“çµæœå·²åŒæ­¥");
            switchTab(1);

        } catch (e) {
            log("âŒ ç®—è¡“ä¸­æ–·: " + e.message);
            setProgress(0, "ä¸­æ–·");
        } finally {
            $('#main-run-btn').prop('disabled', false).text('ğŸš€ å•Ÿå‹•åå…¨å…¨ç®—è¡“æ¨æ¼”');
        }
    }

    // --- API èª¿ç”¨ (Gemini 2.5) ---
    async function callGeminiAnalysis(userInput) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šã€Œåå…¨å…¨ç®—è¡“ã€çš„å¤§å¸«ã€‚
        è«‹æ ¹æ“šè¼¸å…¥çš„è³‡æ–™ï¼ˆå«è¡Œæ˜Ÿã€å¹²æ”¯ã€å®¿æ›œã€äº”è¡Œèƒ½é‡ã€ç¤¾æœƒæ°£é‹ç­‰ï¼‰é€²è¡Œç¶œåˆåˆ¤è®€ã€‚
        å›å‚³ JSONï¼š
        {
          "report": "HTML æ ¼å¼è©³ç´°å ±å‘Šï¼ŒåŒ…å«å„é …æ•¸å€¼çš„å‰å‡¶æ„ç¾©ã€ç•¶å‰æ°£å ´åˆ†æã€‚",
          "summary": "ä¸€å¥è©±ç¸½çµç›®å‰çš„ç¸½é«”å»ºè­°ã€‚",
          "skyPrompt": "è‹±æ–‡æç¤ºè©ï¼Œç”¨æ–¼ç”Ÿæˆç¥ç§˜æ±æ–¹é¢¨æ ¼çš„å¤©ç©ºæ˜Ÿè±¡æ„è±¡ã€‚",
          "earthPrompt": "è‹±æ–‡æç¤ºè©ï¼Œç”¨æ–¼ç”Ÿæˆæ±æ–¹åœ°è„ˆã€å±±æ°´ã€åœ°ç†æ ¼å±€æ„è±¡ã€‚",
          "humanPrompt": "è‹±æ–‡æç¤ºè©ï¼Œç”¨æ–¼ç”Ÿæˆåæ˜ ç•¶ä¸‹äººéš›ã€æ°£æ¯ã€ä¿®è¡Œçš„æ„è±¡ã€‚"
        }`;

        const payload = {
            contents: [{ parts: [{ text: `è¼¸å…¥å¤©æ©Ÿï¼š${userInput}` }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { responseMimeType: "application/json" }
        };

        const result = await fetchWithRetry(url, payload);
        return JSON.parse(result.candidates[0].content.parts[0].text);
    }

    async function generateTripletImage(type, prompt) {
        const idx = type === 'sky' ? 1 : (type === 'earth' ? 2 : 3);
        const imgEl = `#img-${type}`;
        const loaderEl = `#loader-${idx}`;
        
        $(loaderEl).show();
        $(imgEl).hide();

        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        const payload = {
            instances: { prompt: `Fine art photography, cinematic lighting, gold and crimson accents, mystical oriental theme, high resolution, ${prompt}` },
            parameters: { sampleCount: 1 }
        };

        try {
            const result = await fetchWithRetry(url, payload);
            const b64 = result.predictions[0].bytesBase64Encoded;
            $(imgEl).attr('src', `data:image/png;base64,${b64}`).fadeIn();
        } catch (e) {
            log(`${type} æ„è±¡é¡¯ç¾å¤±æ•—`);
        } finally {
            $(loaderEl).hide();
        }
    }

    async function fetchWithRetry(url, body, retries = 5) {
        let backoff = 1000;
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                if (res.ok) return await res.json();
            } catch (e) {}
            await new Promise(r => setTimeout(r, backoff));
            backoff *= 2;
        }
        throw new Error("å¤©æ©Ÿé€£çµè¶…æ™‚");
    }

    // --- Firestore å„²å­˜ (RULE 1, 2, 3) ---
    async function saveAnalysis(input, analysis) {
        if (!user || !db) return;
        const col = fb.collection(db, 'artifacts', appId, 'users', user.uid, 'records');
        await fb.addDoc(col, {
            input, summary: analysis.summary,
            timestamp: Date.now(),
            date: new Date().toLocaleString()
        });
    }

    function loadHistory() {
        if (!user || !db) return;
        const col = fb.collection(db, 'artifacts', appId, 'users', user.uid, 'records');
        fb.onSnapshot(col, (snap) => {
            let data = [];
            snap.forEach(d => data.push(d.data()));
            data.sort((a, b) => b.timestamp - a.timestamp);
            
            let html = data.map(d => `
                <div class="card" style="font-size:0.45rem;">
                    <div style="color:var(--deep-gold); font-weight:900;">ğŸ“ ${d.date}</div>
                    <div style="margin-top:5px;">${d.summary}</div>
                </div>
            `).join("");
            $('#history-list').html(html || "æš«ç„¡ç´€éŒ„ã€‚");
        }, (e) => console.error(e));
    }

    function downloadCode() {
        const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `TenFullArith_945_${Date.now()}.html`;
        a.click();
        log("ç¨‹å¼ç¢¼å‚™ä»½ä¸‹è¼‰ä¸­...");
    }

    window.onload = init;
</script>

<!-- 
    ä¾æ“šåå…¨å…¨ç®—è¡“ä¹‹ç†ï¼Œæ­¤è™•è£œå……å¿…è¦ä¹‹é‚è¼¯è¨»è§£ä»¥ç¢ºä¿è¡Œæ•¸èˆ‡æ·±åº¦ï¼š
    1. å¤©ä½ï¼ˆSkyï¼‰ï¼šä»£è¡¨å®è§€è¶¨å‹¢ã€å¤©é«”å¼•åŠ›èˆ‡å¤§ç’°å¢ƒä¹‹æ°£å ´å½±éŸ¿ã€‚
    2. åœ°ä½ï¼ˆEarthï¼‰ï¼šä»£è¡¨å¾®è§€ç’°å¢ƒã€åœ°ç†ä½ç½®ã€ä½å®…èˆ‡è¾¦å…¬å®¤ä¹‹äº”è¡Œåˆ†ä½ˆã€‚
    3. äººä½ï¼ˆHumanï¼‰ï¼šä»£è¡¨ä¸»è§€æ„å¿—ã€ç”Ÿç†ç‹€æ…‹èˆ‡ç¤¾äº¤èƒ½é‡ä¹‹äº¤äº’æ„Ÿæ‡‰ã€‚
    4. èƒ½é‡å¹³è¡¡ï¼šäº”è¡Œä¹‹æ•¸å€¼ï¼ˆæœ¨ç«åœŸé‡‘æ°´ï¼‰ä¸¦éå­¤ç«‹ï¼Œè€Œæ˜¯é€éæ¼”ç®—æ³•è¨ˆç®—å…¶ç”Ÿå‰‹è·¯å¾‘ã€‚
    5. ç¤¾æœƒæ°£é‹ï¼šçµåˆå¤©æ°£ã€é¢¨é€Ÿèˆ‡å®è§€æŒ‡æ•¸ï¼Œæ±ºå®šç•¶ä¸‹è¡Œå‹•ä¹‹é˜»åŠ›æˆ–æ¨åŠ›ã€‚
    æ­¤ç¨‹å¼å·²å°è£æ‰€æœ‰ UI å›é¥‹ï¼Œé¿å…ä½¿ç”¨ alertï¼Œä¸¦ç¢ºä¿åœ¨ RWD ä¸‹ç¶­æŒé‡‘å…‰é–ƒé–ƒä¹‹è³ªæ„Ÿã€‚
-->

</body>
</html>
