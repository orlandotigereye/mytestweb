<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é‡‘ç¢§å¤©è±¡ G-4.5 MEGA ULTIMATE</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
<style>
:root{
--bg-gold:#FFFDE7;
--coin-gold:#FFD700;
--main-gold:#D4AF37;
--deep-gold:#B8860B;
--gold-grad:linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%);
--font-size:0.5rem;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
margin:0;padding:0;font-family:'PingFang TC','Noto Sans TC',sans-serif;
background:var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png');
color:#3E2723;font-size:var(--font-size);line-height:1.6;overflow-x:hidden;
}
header{
height:70px;background:var(--gold-grad);display:flex;justify-content:space-between;
align-items:center;padding:0 15px;border-bottom:4px solid var(--deep-gold);
position:sticky;top:0;z-index:1000;box-shadow:0 4px 10px rgba(184,134,11,.3);
}
.nav-tabs{display:flex;background:#FFF;border-bottom:2px solid var(--main-gold);position:sticky;top:70px;z-index:999;overflow-x:auto}
.tab{flex:1;min-width:70px;text-align:center;padding:12px 0;font-weight:900;color:#A68B5A;cursor:pointer;font-size:var(--font-size);transition:all 0.3s}
.tab.active{background:rgba(255,215,0,.2);border-bottom:4px solid var(--deep-gold);color:#3E2723}
.content-area{padding:12px;padding-bottom:80px}
.page{display:none}.page.active{display:block}
.card{background:rgba(255,255,255,0.95);border:2px solid var(--coin-gold);border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 6px 15px rgba(184,134,11,0.1)}
.card-title{font-size:0.5rem;font-weight:900;margin-bottom:10px;color:#5D4037;border-left:6px solid var(--deep-gold);padding-left:10px}
textarea{width:100%;height:150px;border:2px solid var(--main-gold);border-radius:8px;padding:10px;font-size:0.5rem;background:#FFFEF2;resize:none;color:#3E2723}
.btn{width:100%;padding:15px;border:none;border-radius:10px;font-weight:900;font-size:0.5rem;cursor:pointer;margin-top:10px}
.btn-primary{background:var(--gold-grad);color:#3E2723;border:1px solid var(--deep-gold);box-shadow:0 4px 0 #B8860B}
.btn-secondary{background:#FFF;border:2px solid var(--main-gold);color:var(--main-gold)}
.diag-item{margin-bottom:10px}
.diag-label{font-size:0.5rem;font-weight:900;display:flex;justify-content:space-between}
.diag-bar{height:10px;background:#EEE;border-radius:5px;overflow:hidden;margin-top:4px;border:1px solid #DDD}
.diag-fill{height:100%;width:0%;background:var(--gold-grad);transition:width 0.5s ease}
.art-viewport{width:100%;min-height:280px;background:#FFF9C4;border-radius:10px;margin-top:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:3px solid var(--main-gold)}
.art-viewport img{width:100%;height:auto;display:block}
#overlay{position:fixed;inset:0;background:var(--bg-gold);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center}
.spinner{width:50px;height:50px;border:6px solid #F3F3F3;border-top:6px solid var(--coin-gold);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#msg-box{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:5000;width:90%;pointer-events:none}
.msg-item{background:#3E2723;color:var(--coin-gold);padding:10px 15px;border-radius:15px;font-size:0.5rem;text-align:center;margin-top:8px;border:2px solid var(--coin-gold);box-shadow:0 4px 8px rgba(0,0,0,0.2)}
#d3-stage{width:100%;height:350px;background:radial-gradient(circle, #FFFDE7 0%, #FFF9C4 100%);border-radius:10px;border:2px solid var(--coin-gold)}
.logic-row{display:flex;justify-content:space-between;border-bottom:1px solid #F0F0F0;padding:8px 0}
.logic-val{font-weight:900;color:var(--deep-gold)}
</style>
</head>
<body>
<div id="overlay">
    <div class="spinner"></div>
    <div style="margin-top:20px;font-weight:900;font-size:0.5rem;color:var(--deep-gold)">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <div id="boot-status" style="margin-top:8px;font-size:0.5rem">é€£ç·šè‡³ Master åˆ†æ”¯</div>
</div>

<div id="msg-box"></div>

<header>
    <div style="font-weight:900;font-size:0.5rem">ğŸ”± G-4.5 MEGA MONITOR</div>
    <button class="btn-secondary" style="width:auto;margin:0;padding:5px 10px;font-size:0.5rem" onclick="exportCode()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼ç¢¼</button>
</header>

<nav class="nav-tabs">
    <div class="tab active" data-p="0">å•Ÿå‹•å„€è¡¨</div>
    <div class="tab" data-p="1">æ˜Ÿè±¡é‚è¼¯</div>
    <div class="tab" data-p="2">èƒ½é‡æµå‹•</div>
    <div class="tab" data-p="3">æ„è±¡æ¸²æŸ“</div>
    <div class="tab" data-p="4">æ±ºç­–å»ºè­°</div>
</nav>

<div class="content-area">
    <!-- Page 0: Input & Status -->
    <section id="pg-0" class="page active">
        <div class="card">
            <div class="card-title">ğŸ“¡ æ ¸å¿ƒè³‡æºç‹€æ…‹</div>
            <div class="diag-item" id="d-cjk"><div class="diag-label"><span>CJK å­—å…¸</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
            <div class="diag-item" id="d-ast"><div class="diag-label"><span>æ˜Ÿè±¡å¤§æ•¸æ“š</span><span class="v">ç­‰å¾…</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
        </div>
        <div class="card">
            <div class="card-title">âŒ¨ï¸ è§€æ¸¬æ¨£æœ¬è¼¸å…¥</div>
            <textarea id="main-input">ä¹™å·³å¹´ æˆŠå­æœˆ å·±å·³æ—¥
è§€æ¸¬ç·¯åº¦ï¼š25.03, 121.56
ç›®å‰æƒ…å¢ƒï¼šå•†æ¥­æ±ºç­–èˆ‡äººäº‹å®‰æ’</textarea>
            <div id="run-mon" style="display:none;margin-top:15px;border-top:1px dashed var(--main-gold);padding-top:15px">
                <div class="diag-item" id="d-gemini"><div class="diag-label"><span>Gemini 2.5 æ ¸å¿ƒ</span><span class="v">ä½‡åˆ—ä¸­</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
                <div class="diag-item" id="d-imagen"><div class="diag-label"><span>Imagen 4.0 æ„è±¡</span><span class="v">ä½‡åˆ—ä¸­</span></div><div class="diag-bar"><div class="diag-fill"></div></div></div>
            </div>
            <button id="btn-run" class="btn btn-primary" disabled>è³‡æºè¼‰å…¥ä¸­...</button>
        </div>
    </section>

    <!-- Page 1: Logic -->
    <section id="pg-1" class="page"></section>

    <!-- Page 2: Energy -->
    <section id="pg-2" class="page">
        <div class="card"><div class="card-title">ğŸŒ€ äº”è¡Œèƒ½é‡æµå‹•å ´</div><div id="d3-stage"></div></div>
        <div id="energy-list"></div>
    </section>

    <!-- Page 3: Art -->
    <section id="pg-3" class="page"></section>

    <!-- Page 4: Decision -->
    <section id="pg-4" class="page"></section>
</div>

<script>
const apiKey = ""; // ç”±ç’°å¢ƒæ³¨å…¥
let DB_CJK = [];
let DB_AST = null;
let APP_STATE = null;

// é ç«¯è³‡æºè·¯å¾‘
const URL_CJK = "https://raw.githubusercontent.com/max32002/chinese_dictionary/master/Dictionary.json";
const URL_AST = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

function showMsg(t){
    const m = $(`<div class="msg-item">${t}</div>`);
    $('#msg-box').append(m);
    setTimeout(() => m.fadeOut(500, () => m.remove()), 4000);
}

function updateStatus(id, p, v, err=false){
    const target = $('#'+id);
    target.find('.diag-fill').css('width', p+'%');
    target.find('.v').text(v).css('color', err ? '#FF5252' : '');
}

// å•Ÿå‹•è³‡æºè¼‰å…¥
async function initSystem(){
    try {
        updateStatus('d-cjk', 20, 'ä¸‹è¼‰ä¸­...');
        updateStatus('d-ast', 20, 'ä¸‹è¼‰ä¸­...');
        
        const [cRes, aRes] = await Promise.all([
            fetch(URL_CJK).then(r => r.json()),
            fetch(URL_AST).then(r => r.json())
        ]);

        DB_CJK = Array.isArray(cRes) ? cRes : (cRes.values || []);
        DB_AST = aRes;

        updateStatus('d-cjk', 100, 'å°±ç·’');
        updateStatus('d-ast', 100, 'å°±ç·’');
        $('#btn-run').prop('disabled', false).text('ğŸš€ å•Ÿå‹•é€£ç·šåˆ†æ');
        $('#overlay').fadeOut(600);
        showMsg("å¤©è±¡æ ¸å¿ƒè³‡æºé€£ç·šæˆåŠŸ");
    } catch (e) {
        updateStatus('d-cjk', 0, 'å¤±æ•—', true);
        showMsg("è³‡æºè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
    }
}

// ç­†åŠƒè¨ˆç®—
function calcStrokes(text){
    let count = 0;
    const chars = text.replace(/[^\u4e00-\u9fa5]/g, '');
    for(let c of chars){
        const f = DB_CJK.find(i => i.word === c);
        count += f ? parseInt(f.stroke_count) : 8;
    }
    return count || 10;
}

// API é€£ç·šï¼ˆå«æŒ‡æ•¸é€€é¿é‡è©¦ï¼‰
async function callGemini(prompt){
    let retry = 0;
    const delays = [1000, 2000, 4000, 8000, 16000];
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json" }
    };

    while(retry < 5){
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)
            });
            if(!r.ok) throw new Error(r.status);
            const data = await r.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        } catch (e) {
            if(retry === 4) throw e;
            await new Promise(res => setTimeout(res, delays[retry]));
            retry++;
        }
    }
}

async function startAnalysis(){
    const input = $('#main-input').val();
    if(!input) return showMsg("è«‹è¼¸å…¥è§€æ¸¬æ¨£æœ¬");

    $('#run-mon').slideDown();
    updateStatus('d-gemini', 30, 'åˆ†æä¸­');
    
    const strokes = calcStrokes(input);
    const systemPrompt = `ä½ æ˜¯ä¸€å€‹ç²¾å¯†çš„å¤©è±¡èˆ‡äº”è¡Œåˆ†æå„€ã€‚è«‹æ ¹æ“šè¼¸å…¥å…§å®¹èˆ‡ç­†åŠƒæ¬Šé‡(${strokes})é€²è¡Œæ·±åº¦é‹ç®—ã€‚
    å¿…é ˆå›å‚³ JSON æ ¼å¼ï¼Œçµæ§‹å¦‚ä¸‹ï¼š
    {
      "summary": "ä¸€å¥è©±ç¸½çµå¤©æ©Ÿ",
      "analysis": [{"label": "ç¶­åº¦åç¨±", "content": "è©³ç´°å…§å®¹"}],
      "elements": {"wood": 0.2, "fire": 0.2, "earth": 0.2, "metal": 0.2, "water": 0.2},
      "decisions": {"do": "å»ºè­°åŸ·è¡Œçš„è¡Œå‹•", "dont": "æ‡‰è©²è¦é¿çš„é¢¨éšª", "verdict": "æœ€çµ‚æ±ºæ–·"},
      "arts": [{"prompt": "ç”¨æ–¼ Imagen 4.0 çš„è‹±æ–‡æç¤ºè©", "title": "åœ–å"}]
    }`;

    try {
        APP_STATE = await callGemini(`æ¨£æœ¬è³‡æ–™ï¼š${input}\n${systemPrompt}`);
        updateStatus('d-gemini', 100, 'å®Œæˆ');
        showMsg("å¤©æ©Ÿè§£ç¢¼å®Œæˆï¼Œå•Ÿå‹•æ„è±¡ç¹ªè£½");
        renderAll();
        $('[data-p=1]').click();
    } catch (e) {
        updateStatus('d-gemini', 0, 'é€£ç·šéŒ¯èª¤', true);
        showMsg("Gemini API å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–æ¬Šé™");
    }
}

function renderAll(){
    // Render Logic Page
    let h1 = `<div class="card"><div class="card-title">ğŸ”® å¤©æ©Ÿç¸½è¦½</div><p style="font-weight:900">${APP_STATE.summary}</p></div>`;
    APP_STATE.analysis.forEach(a => {
        h1 += `<div class="card"><div class="card-title">${a.label}</div><p>${a.content}</p></div>`;
    });
    $('#pg-1').html(h1);

    // Render Energy Page
    let h2 = `<div class="card"><div class="card-title">ğŸ“Š èƒ½é‡çµ„æˆ</div>`;
    const names = {wood:"æœ¨", fire:"ç«", earth:"åœŸ", metal:"é‡‘", water:"æ°´"};
    Object.entries(APP_STATE.elements).forEach(([k,v]) => {
        h2 += `<div class="logic-row"><span>${names[k]}èƒ½é‡</span><span class="logic-val">${(v*100).toFixed(1)}%</span></div>`;
    });
    $('#energy-list').html(h2 + `</div>`);

    // Render Decision Page
    $('#pg-4').html(`
        <div class="card" style="background:var(--gold-grad); border:none; text-align:center">
            <div style="font-size:0.7rem; font-weight:900; color:#3E2723">çµè«–ï¼š${APP_STATE.verdict}</div>
        </div>
        <div class="card"><div class="card-title">âœ… å®œ</div><p>${APP_STATE.decisions.do}</p></div>
        <div class="card"><div class="card-title">âŒ å¿Œ</div><p>${APP_STATE.decisions.dont}</p></div>
    `);

    renderArts();
}

async function renderArts(){
    let h = '';
    updateStatus('d-imagen', 10, 'ä½‡åˆ—ä¸­');
    APP_STATE.arts.forEach((art, idx) => {
        const id = `art-box-${idx}`;
        h += `<div class="card"><div class="card-title">${art.title}</div><div class="art-viewport" id="${id}"><div style="font-size:0.5rem">Imagen æ¸²æŸ“ä¸­...</div></div></div>`;
        
        // ç•°æ­¥æ¸²æŸ“
        (async () => {
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: "POST", body: JSON.stringify({ instances: { prompt: art.prompt }, parameters: { sampleCount: 1 } })
                });
                const d = await r.json();
                const b64 = d.predictions[0].bytesBase64Encoded;
                $(`#${id}`).html(`<img src="data:image/png;base64,${b64}">`);
                updateStatus('d-imagen', 100, 'å®Œæˆ');
            } catch (e) {
                $(`#${id}`).html('<div style="color:#FF5252">æ¸²æŸ“å—é™ (å¯èƒ½å«æ•æ„Ÿè©)</div>');
            }
        })();
    });
    $('#pg-3').html(h);
}

function runD3(){
    const el = d3.select("#d3-stage"); el.selectAll("*").remove();
    const w = $("#d3-stage").width(), h = 350;
    const svg = el.append("svg").attr("width", w).attr("height", h);
    
    const colors = {wood:"#4CAF50", fire:"#FF5252", earth:"#FBC02D", metal:"#BDBDBD", water:"#2196F3"};
    const nodes = Object.entries(APP_STATE.elements).map(([k,v]) => ({
        id: k, name: ({wood:"æœ¨", fire:"ç«", earth:"åœŸ", metal:"é‡‘", water:"æ°´"})[k],
        r: 30 + (v * 100), color: colors[k]
    }));

    const sim = d3.forceSimulation(nodes)
        .force("center", d3.forceCenter(w/2, h/2))
        .force("collide", d3.forceCollide().radius(d => d.r + 10))
        .force("charge", d3.forceManyBody().strength(-200));

    const g = svg.selectAll("g").data(nodes).enter().append("g");
    g.append("circle").attr("r", d => d.r).attr("fill", d => d.color).attr("stroke", "#D4AF37").attr("stroke-width", 3);
    g.append("text").text(d => d.name).attr("text-anchor", "middle").attr("dy", ".35em").style("font-weight","900").style("fill","#FFF").style("font-size","0.6rem");

    sim.on("tick", () => g.attr("transform", d => `translate(${d.x},${d.y})`));
}

function exportCode(){
    const b = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b); a.download = `G45_MEGA_EXPORT_${Date.now()}.html`;
    a.click();
}

$(document).ready(() => {
    initSystem();
    $('.tab').click(function(){
        const p = $(this).data('p');
        $('.tab, .page').removeClass('active');
        $(this).addClass('active');
        $(`#pg-${p}`).addClass('active');
        if(p == 2 && APP_STATE) setTimeout(runD3, 100);
    });
    $('#btn-run').click(startAnalysis);
});
</script>
</body>
</html>
