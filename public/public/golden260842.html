<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘ç¢§è¼ç…Œãƒ»å¤©è±¡é›†æˆ G-4.2 æ——è‰¦ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- æ ¸å¿ƒä¾è³´åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>

    <style>
        :root {
            --base-gold: #FFFDF0; 
            --royal-gold: #C5A059;
            --bright-gold: #FFD700;
            --text-gold: #8B6B23;
            --panel-gold: rgba(255, 250, 240, 0.98);
            --border-gold: #E2C08D;
            --font-nano: 0.5rem; /* åš´æ ¼ 0.5rem */
            --shadow-gold: 0 12px 40px rgba(197, 160, 89, 0.3);
            --gold-gradient: linear-gradient(135deg, #D4AF37 0%, #FCF6BA 20%, #D4AF37 40%, #FBF5B7 60%, #AA771C 80%, #FCF6BA 100%);
            --coin-bg: url('https://www.transparenttextures.com/patterns/gold-dust.png');
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'PingFang TC', 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--base-gold);
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(255, 215, 0, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 90% 90%, rgba(184, 134, 11, 0.2) 0%, transparent 50%),
                var(--coin-bg);
            color: var(--text-gold);
            font-size: var(--font-nano);
            line-height: 1.8;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* é ‚éƒ¨å°è¦½ */
        .header-bar {
            height: 70px; background: var(--gold-gradient);
            background-size: 400% 400%; animation: goldFlow 15s ease infinite;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; border-bottom: 4px solid var(--royal-gold);
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        @keyframes goldFlow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        .header-title { font-size: 0.65rem; font-weight: 900; color: #3E2723; text-shadow: 1px 1px 1px rgba(255,255,255,0.8); }

        .btn-action {
            background: #FFF; border: 2px solid var(--royal-gold);
            color: var(--text-gold); font-size: 0.5rem; font-weight: 900;
            padding: 8px 18px; border-radius: 30px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 0 var(--royal-gold);
        }
        .btn-action:hover { background: var(--royal-gold); color: #FFF; transform: translateY(-2px); }
        .btn-action:active { transform: translateY(2px); box-shadow: 0 1px 0 var(--royal-gold); }

        /* åˆ†é åˆ‡æ› */
        .tab-nav {
            display: flex; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px); border-bottom: 2px solid var(--border-gold);
            position: sticky; top: 70px; z-index: 999;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 20px 0;
            font-size: var(--font-nano); font-weight: 900; color: #A68B5A; cursor: pointer;
            transition: all 0.4s ease; border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            color: #5D4037; background: rgba(255, 215, 0, 0.15);
            border-bottom: 4px solid var(--royal-gold);
        }

        /* é é¢å®¹å™¨ */
        .page-content { display: none; padding: 25px; animation: fadeIn 0.6s ease; max-width: 1200px; margin: 0 auto; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* é‡‘å…‰å¡ç‰‡é¢æ¿ */
        .gold-card {
            background: var(--panel-gold); border: 2px solid var(--border-gold);
            border-radius: 20px; padding: 25px; margin-bottom: 25px;
            box-shadow: var(--shadow-gold); position: relative;
            overflow: hidden;
        }
        .gold-card::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px;
            background: var(--gold-gradient);
        }
        .card-title {
            font-size: 0.6rem; font-weight: 900; margin-bottom: 20px;
            color: #5D4037; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border-gold); padding-bottom: 12px;
        }

        /* è¼¸å…¥æ§ä»¶ */
        textarea {
            width: 100%; height: 320px; background: #FFFEF9;
            border: 2px solid var(--border-gold); border-radius: 12px;
            padding: 20px; font-size: 0.5rem; color: #4E342E; line-height: 1.8;
            resize: none; outline: none; transition: 0.3s;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.03);
        }
        textarea:focus { border-color: var(--bright-gold); background: #FFF; box-shadow: 0 0 15px rgba(255,215,0,0.25); }

        .btn-main {
            width: 100%; margin-top: 25px; padding: 24px;
            background: var(--gold-gradient); border: none; border-radius: 12px;
            color: #3E2723; font-weight: 900; font-size: 0.65rem;
            cursor: pointer; box-shadow: 0 8px 0 #9E7E00; transition: 0.2s;
            text-transform: uppercase; letter-spacing: 3px;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 4px 0 #9E7E00; }

        .btn-clear {
            background: #FFF; border: 1.5px solid #D2B48C; color: #8B4513;
            padding: 8px 16px; border-radius: 8px; font-size: 0.5rem; cursor: pointer;
            transition: 0.2s; font-weight: bold;
        }
        .btn-clear:hover { background: #F5DEB3; border-color: var(--royal-gold); }

        /* æ•¸æ“šç¶²æ ¼ */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .stat-box {
            background: #FFF; border: 2.5px solid var(--border-gold);
            padding: 20px; border-radius: 15px; text-align: center;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .stat-box:hover { transform: translateY(-8px); border-color: var(--bright-gold); box-shadow: 0 10px 20px rgba(255,215,0,0.2); }
        .stat-label { font-size: 0.5rem; color: #998C71; font-weight: 900; margin-bottom: 8px; display: block; }
        .stat-val { font-size: 0.55rem; font-weight: 900; color: var(--text-gold); }

        /* Toast è¨Šæ¯ */
        #toast-container {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            z-index: 5000; width: 90%; max-width: 500px; pointer-events: none;
        }
        .toast {
            background: rgba(255, 255, 255, 0.98); border: 3px solid var(--royal-gold);
            padding: 18px 30px; border-radius: 40px; font-size: 0.5rem;
            font-weight: 900; color: #5D4037; box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            margin-top: 15px; text-align: center; animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.7) translateY(60px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* åŠ è¼‰ç•«é¢ */
        #loading-screen {
            position: fixed; inset: 0; background: rgba(255, 253, 240, 0.99);
            z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .spinner {
            width: 80px; height: 80px; border: 8px solid #F3F3F3;
            border-top: 8px solid var(--royal-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* é«˜æ¸…æ¸²æŸ“æ¨¡æ¿ (éš±è—) */
        #offscreen-tpl { position: absolute; left: -9999px; }
        .report-tpl {
            width: 1000px; padding: 100px; background: #FFFDF0;
            border: 40px solid var(--royal-gold); color: #4E342E; position: relative;
            box-sizing: border-box; overflow: hidden;
        }
        .report-tpl::after { 
            content: ""; position: absolute; inset: 25px; 
            border: 4px solid var(--royal-gold); pointer-events: none; 
        }
        .tpl-corner {
            position: absolute; width: 120px; height: 120px; border: 12px solid var(--bright-gold);
        }
        .c-tl { top: 0; left: 0; border-right: none; border-bottom: none; }
        .c-br { bottom: 0; right: 0; border-left: none; border-top: none; }

        /* RWD èª¿æ•´ */
        @media (max-width: 600px) {
            .stat-grid { grid-template-columns: 1fr; }
            .header-bar { height: 60px; padding: 0 15px; }
            .header-title { font-size: 0.55rem; }
            .tab-btn { padding: 16px 0; }
        }
    </style>
</head>
<body>

<!-- åŠ è¼‰é®ç½© -->
<div id="loading-screen">
    <div class="spinner"></div>
    <div style="font-weight:900; color:var(--text-gold); font-size:0.75rem; letter-spacing:4px;">âšœï¸ å¤©æ©Ÿæ¼”ç®—è¼‰å…¥ä¸­ âšœï¸</div>
    <div id="loading-status" style="margin-top:15px; font-size:0.5rem; color:#A68B5A; font-weight:bold;">æ­£åœ¨è®€å– CJK ç­†åŠƒå­—å…¸ (Lite)...</div>
</div>

<div id="toast-container"></div>

<!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
<header class="header-bar">
    <div class="header-title">G-CORE 4.2 GOLDEN MASTER (LITE)</div>
    <button class="btn-action" onclick="downloadSource()">ğŸ’¾ ä¸‹è¼‰ä»£ç¢¼</button>
</header>

<!-- åˆ†é é¸å–® -->
<nav class="tab-nav">
    <div class="tab-btn active" onclick="switchPage(0)">è§€æ¸¬æ•¸æ“š</div>
    <div class="tab-btn" onclick="switchPage(1)">æ ¸ç®—è§£æ</div>
    <div class="tab-btn" onclick="switchPage(2)">é‡‘å…‰åœ–å ±</div>
</nav>

<!-- é é¢ 0: æ•¸æ“šè¼‰å…¥ -->
<main id="p0" class="page-content active">
    <div class="gold-card">
        <div class="card-title">
            <span>âšœï¸ å¤©è±¡æ•¸æ“šè¼‰å…¥ä¸­å¿ƒ</span>
            <button class="btn-clear" onclick="clearInput()">ğŸ§¹ ä¸€éµæ¸…ç©º</button>
        </div>
        <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn-clear" onclick="fetchAstronomyData()">ğŸ“¡ åŒæ­¥å³æ™‚å¤©è±¡ (Astronomy Engine)</button>
            <button class="btn-clear" onclick="loadPreset()">ğŸ“ è¼‰å…¥æ¨™æº–åˆ†æç¯„æœ¬</button>
        </div>
        <textarea id="main-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥è§€æ¸¬æ•¸æ“šï¼Œæˆ–ä½¿ç”¨è‡ªå‹•åŒæ­¥åŠŸèƒ½..."></textarea>
        <button class="btn-main" onclick="executeCompute()">å•Ÿå‹•é‡‘ç¢§è¼ç…Œæ·±åº¦è§£æ</button>
    </div>
    
    <div class="stat-grid">
        <div class="stat-box"><span class="stat-label">ç³»çµ±æµæ°´ç¢¼</span><div id="sn-id" class="stat-val">---</div></div>
        <div class="stat-box"><span class="stat-label">æ¼”ç®—æ¬Šé™</span><div class="stat-val">SUPREME MASTER VIP</div></div>
        <div class="stat-box"><span class="stat-label">CJK å­—å…¸ (Lite)</span><div id="dict-status" class="stat-val">ç­‰å¾…ä¸­...</div></div>
        <div class="stat-box"><span class="stat-label">æ˜Ÿè±¡å­—å…¸ (Astro)</span><div id="astro-status" class="stat-val">ç­‰å¾…ä¸­...</div></div>
    </div>
</main>

<!-- é é¢ 1: æ·±åº¦æ ¸ç®— -->
<main id="p1" class="page-content">
    <div id="report-view">
        <div class="gold-card" style="text-align:center; padding:150px 20px;">
            <div style="font-size:2rem; margin-bottom:30px;">â³</div>
            <div style="color:var(--royal-gold); font-weight:900; letter-spacing:2px; font-size:0.6rem;">è«‹å…ˆæ–¼è§€æ¸¬é é¢æäº¤æ•¸æ“šé€²è¡Œæ¼”ç®—...</div>
        </div>
    </div>
</main>

<!-- é é¢ 2: é‡‘å…‰è¦–è¦ºåŒ–åœ–å ± -->
<main id="p2" class="page-content">
    <div id="visual-view" style="display:flex; flex-direction:column; gap:30px; align-items:center;">
        <div class="gold-card" style="text-align:center; padding:150px 20px; width: 100%;">
            <div style="font-size:2rem; margin-bottom:30px;">ğŸ–¼ï¸</div>
            <div style="color:var(--royal-gold); font-weight:900; font-size:0.6rem;">è¦–è¦ºåŒ–æ¨¡çµ„å¾…å‘½ä¸­ï¼Œæ ¸ç®—å¾Œå°‡ç”Ÿæˆé«˜æ¸…åœ–å ±...</div>
        </div>
    </div>
    <div id="export-tools" style="display:none; text-align:center; padding:40px 0; width:100%;">
        <button class="btn-main" onclick="exportGoldenImages()">ğŸ“¥ æ‰¹é‡å°å‡º 4K é‡‘å…‰é«˜æ¸…å ±å‘Šåœ–</button>
    </div>
</main>

<!-- æ¸²æŸ“æ¨¡æ¿ -->
<div id="offscreen-tpl">
    <div id="tpl-main" class="report-tpl">
        <div class="tpl-corner c-tl"></div>
        <div class="tpl-corner c-br"></div>
        <h1 id="tpl-h" style="font-size:58px; border-bottom:8px double var(--royal-gold); padding-bottom:25px; font-weight:900; letter-spacing:6px; text-align:center; color:#3E2723;"></h1>
        <div id="tpl-meta" style="margin-top:25px; text-align:center; font-size:24px; color:var(--royal-gold); font-weight:bold;"></div>
        <div id="tpl-b" style="font-size:32px; line-height:2.0; margin-top:60px; white-space:pre-wrap; text-align:justify; color:#4E342E; font-weight:500;"></div>
        <div style="margin-top:120px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="font-size:20px; color:#A68B5A; font-weight:bold;">é©—è­‰æµæ°´è™Ÿ: <span class="sn-txt"></span></div>
            <div style="text-align:right;">
                <div style="font-size:30px; font-weight:900; color:var(--royal-gold);">G-CORE 4.2 ULTIMATE</div>
                <div style="font-size:18px; color:#A68B5A;">å¤©è±¡é›†æˆé‹ç®—æ ¸å¿ƒãƒ»ç‰ˆæ¬Šæ‰€æœ‰</div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ç³»çµ±é…ç½®
 */
const apiKey = ""; 
const SN_CODE = "G42-" + Math.random().toString(36).substr(2, 9).toUpperCase();
const DICT_LITE_URL = "https://raw.githubusercontent.com/orlandotigereye/mytestweb/4ea567726353330f2301bca768a6325ab5611699/public/public/Dictionary_lite.json";
const ASTRO_URL = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

let coreData = null;
let astroDict = null;
let cjkLiteDict = null;
let userLoc = { lat: 25.0330, lon: 121.5654, name: "å°åŒ—å¸‚" };

/**
 * å•Ÿå‹•èˆ‡åˆå§‹åŒ–
 */
$(document).ready(async () => {
    $('#sn-id').text(SN_CODE);
    $('.sn-txt').text(SN_CODE);
    
    // ç²å–åœ°ç†ä½ç½®
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLoc.lat = pos.coords.latitude;
            userLoc.lon = pos.coords.longitude;
            $('#dict-status').parent().parent().append(`<div style="font-size:0.4rem">å®šä½ï¼š${userLoc.lat.toFixed(2)},${userLoc.lon.toFixed(2)}</div>`);
        });
    }

    await preloadData();
    showToast("âœ¨ G-CORE 4.2 æ——è‰¦ç³»çµ±å·²å°±ç·’");
});

/**
 * é è¼‰å…¥é ç«¯å­—å…¸
 */
async function preloadData() {
    try {
        $('#loading-screen').show();
        $('#loading-status').text("æ­£åœ¨è®€å– CJK Lite èˆ‡æ˜Ÿè±¡å¤§æ•¸æ“š...");
        
        const [cjkRes, astroRes] = await Promise.all([
            fetch(DICT_LITE_URL).then(r => r.json()),
            fetch(ASTRO_URL).then(r => r.json())
        ]);
        
        cjkLiteDict = cjkRes;
        astroDict = astroRes;
        
        $('#dict-status').text("å·²å°±ç·’ (Lite)").css('color', '#2E7D32');
        $('#astro-status').text("å·²è¼‰å…¥").css('color', '#2E7D32');
        
    } catch (e) {
        console.error(e);
        $('#dict-status').text("è¼‰å…¥å¤±æ•—").css('color', '#C62828');
        showToast("âš ï¸ é ç«¯å­—å…¸é€£ç·šç•°å¸¸ï¼Œå°‡å•Ÿå‹•å…§æ ¸å‚™æ´æ¼”ç®—æ³•");
    } finally {
        $('#loading-screen').hide();
    }
}

/**
 * åˆ†é ç®¡ç†
 */
function switchPage(idx) {
    $('.page-content').removeClass('active');
    $(`#p${idx}`).addClass('active');
    $('.tab-btn').removeClass('active').eq(idx).addClass('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * è¨Šæ¯é€šçŸ¥
 */
function showToast(t) {
    const e = $(`<div class="toast">${t}</div>`);
    $('#toast-container').append(e);
    setTimeout(() => e.fadeOut(() => e.remove()), 5000);
}

/**
 * æ¸…é™¤
 */
function clearInput() {
    $('#main-input').val('');
    showToast("ğŸ§¹ æ•¸æ“šç·©è¡å€å·²æ¸…ç©º");
}

/**
 * è¼‰å…¥é è¨­
 */
function loadPreset() {
    $('#main-input').val(`ã€æ——è‰¦è§€æ¸¬ç¯„æœ¬ã€‘
æ™‚ç©ºï¼š2025å¹´12æœˆ27æ—¥ 12:46 å°åŒ—å¸‚
æœˆç›¸ï¼šä¸Šå¼¦æœˆ (å¼·åº¦ 75%)
äº”è¡Œèƒ½é‡åˆ†æï¼š
æœ¨(25) ç«(35) åœŸ(15) é‡‘(10) æ°´(15)
é‡é»æ˜Ÿè±¡ï¼š
æœ¨æ˜Ÿé€†è¡Œæ–¼é›™å­åº§ | åœŸæ˜Ÿå¹³ç©©æ–¼é›™é­šåº§
è§€æ¸¬å‚™è¨»ï¼šå¤§æ°£é€æ˜åº¦æ¥µé«˜ï¼Œé©åˆé€²è¡Œæ·±åº¦å†¥æƒ³èˆ‡é‹å‹¢æ ¸ç®—ã€‚`);
    showToast("ğŸ“ æ¨™æº–ç¯„æœ¬å·²è¼‰å…¥");
}

/**
 * ä½¿ç”¨ Astronomy Engine è¨ˆç®—å³æ™‚å¤©è±¡
 */
function fetchAstronomyData() {
    $('#loading-screen').show();
    $('#loading-status').text("ç²¾ç¢ºè¨ˆç®—æ˜Ÿé«”è»Œé“ä¸­...");
    
    setTimeout(() => {
        const date = new Date();
        const obs = new Astronomy.Observer(userLoc.lat, userLoc.lon, 0);
        const bodies = ['Sun', 'Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];
        
        let report = `ã€å³æ™‚å¤©è±¡ç²¾ç¢ºå ±å‘Šã€‘\n`;
        report += `è§€æ¸¬æ™‚é–“: ${date.toLocaleString()}\n`;
        report += `è§€æ¸¬åæ¨™: ${userLoc.lat.toFixed(4)}, ${userLoc.lon.toFixed(4)}\n\n`;

        bodies.forEach(b => {
            const eq = Astronomy.Equator(b, date, obs, true, true);
            const hz = Astronomy.Horizon(date, obs, eq.ra, eq.dec, 'refray');
            report += `âœ¨ ${b}: æ–¹ä½ ${hz.az.toFixed(2)}Â°, é«˜åº¦ ${hz.alt.toFixed(2)}Â°\n`;
        });

        const lunar = Lunar.fromDate(date);
        report += `\nğŸ® è¾²æ›†ï¼š${lunar.getYearInGanZhi()}å¹´ ${lunar.getMonthInGanZhi()}æœˆ ${lunar.getDayInGanZhi()}æ—¥\n`;
        report += `å®¿æ›œï¼š${lunar.getGong()}${lunar.getShu()}${lunar.getAnimal()}\n`;
        report += `ç¯€æ°£ï¼š${lunar.getJieQi() || 'éç¯€æ°£æ—¥'}\n`;
        
        $('#main-input').val(report);
        $('#loading-screen').hide();
        showToast("ğŸ“¡ å·²æˆåŠŸç²å–é«˜ç²¾åº¦å¤©è±¡æ•¸æ“š");
    }, 600);
}

/**
 * æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (Gemini API)
 */
async function executeCompute() {
    const raw = $('#main-input').val().trim();
    if(!raw) return showToast("âš ï¸ è«‹å…ˆæä¾›è§€æ¸¬æ•¸æ“šæˆ–è‡ªå‹•åŒæ­¥");

    $('#loading-screen').show();
    $('#loading-status').text("å¤©æ©Ÿé€£å‹•ä¸­ï¼Œæ­£åœ¨åŸ·è¡Œé‡‘å…‰æ·±åº¦æ ¸ç®—...");

    // å»ºç«‹ç­†åŠƒåˆ†ææ‘˜è¦ (åˆ©ç”¨ Lite å­—å…¸)
    let strokesSummary = "æ¼¢å­—ç­†åŠƒåƒè€ƒï¼š";
    if (cjkLiteDict) {
        const sample = "å¤©è±¡å‰å‡¶ä¹¾å¤";
        for (let char of sample) {
            strokesSummary += `${char}(${cjkLiteDict[char] || '?'}) `;
        }
    }

    const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ±æ–¹äº”è¡Œã€äºŒåå…«å®¿æ›œã€ä»¥åŠç¾ä»£é«˜èƒ½ç‰©ç†æ˜Ÿè±¡çš„ã€Œé‡‘ç‰Œæ——è‰¦åˆ†æå¤§å¸«ã€ã€‚
è«‹é‡å°ä½¿ç”¨è€…æä¾›çš„æ•¸æ“šï¼Œé€²è¡Œä¸€å ´å­—æ•¸æ¥µå¤šã€è¯éº—ç„¡æ¯”ã€ä¸”å…·å‚™æ¬Šå¨æ„Ÿçš„ã€Œé‡‘ç¢§è¼ç…Œã€æ·±åº¦è§£æã€‚
å›å‚³å…§å®¹éœ€åŒ…å«ï¼š
1. [é‡‘é—•äº”è¡Œå±€]ï¼šæ·±åº¦è§£è®€èƒ½é‡å¤±è¡¡èˆ‡è£œå„Ÿæ©Ÿåˆ¶ï¼ˆä¸å°‘æ–¼ 650 å­—ï¼‰ã€‚
2. [å®¿æ›œä¹¾å¤å®š]ï¼šé‡å°ç•¶å‰æ˜Ÿå®¿èˆ‡æ˜Ÿé«”ç›¸ä½çµ¦å‡ºå®è§€æ±ºç­–æŒ‡å¼•ï¼ˆä¸å°‘æ–¼ 650 å­—ï¼‰ã€‚
3. [æ™‚ç©ºé¿å‡¶ç­–]ï¼šæä¾›å…·é«”çš„æ–¹ä½ã€è‰²å½©ã€è¡Œç‚ºæŒ‡å¼•èˆ‡é¿å‘å»ºè­°ï¼ˆä¸å°‘æ–¼ 650 å­—ï¼‰ã€‚
åš´æ ¼ JSON å›å‚³ï¼š
{
  "summary": "ä¸€å¥è©±å®šèª¿å…¨å±€",
  "articles": [
    {"title": "é‡‘é—•äº”è¡Œå±€", "body": "å…¨æ–‡å…§å®¹..."},
    {"title": "å®¿æ›œä¹¾å¤å®š", "body": "å…¨æ–‡å…§å®¹..."},
    {"title": "æ™‚ç©ºé¿å‡¶ç­–", "body": "å…¨æ–‡å…§å®¹..."}
  ]
}`;

    try {
        const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `è¼¸å…¥è§€æ¸¬æ•¸æ“šï¼š\n${raw}\n${strokesSummary}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", temperature: 0.85 }
            })
        });

        const res = await response.json();
        const jsonText = res.candidates[0].content.parts[0].text;
        coreData = JSON.parse(jsonText);

        renderReport();
        switchPage(1);
        showToast("âœ… å¤©æ©Ÿæ ¸ç®—å®Œç•¢ï¼Œçµæœå·²ç”¢å‡º");
    } catch (e) {
        console.error(e);
        showToast("âŒ é‹ç®—æ ¸å¿ƒç™¼ç”Ÿç•°å¸¸ï¼š" + e.message);
    } finally {
        $('#loading-screen').hide();
    }
}

/**
 * æ¸²æŸ“è§£æå…§å®¹
 */
function renderReport() {
    let html = `
        <div class="gold-card">
            <div class="card-title">âšœï¸ æ ¸å¿ƒå®šèª¿ï¼šå¤©æ©Ÿç¸½è¦½</div>
            <div style="font-size:0.65rem; font-weight:900; color:#5D4037; text-align:center; padding:15px 0; border:2px dashed var(--royal-gold); border-radius:10px;">
                ã€Œ${coreData.summary}ã€
            </div>
        </div>
    `;

    coreData.articles.forEach((art, idx) => {
        html += `
            <div class="gold-card">
                <div class="card-title">ğŸ“œ ${art.title}</div>
                <div style="white-space:pre-wrap; text-align:justify; color:#5D4037; font-size:0.5rem; line-height:2.0; font-weight:500;">${art.body}</div>
            </div>
        `;
    });

    $('#report-view').html(html);
    generateVisualPreviews();
}

/**
 * è¦–è¦ºåŒ–å ±å‘Šé è¦½ç”Ÿæˆ
 */
async function generateVisualPreviews() {
    $('#visual-view').empty();
    $('#export-tools').hide();

    for (let i = 0; i < coreData.articles.length; i++) {
        const art = coreData.articles[i];
        const container = $(`
            <div class="gold-card" style="width:100%; max-width:600px;">
                <div class="card-title">ğŸ–¼ï¸ é«˜æ¸…é‡‘å…‰åœ–å ±é è¦½ï¼š${art.title}</div>
                <div id="canvas-prev-${i}" style="min-height:400px; background:#FFF; display:flex; align-items:center; justify-content:center; border:2px solid var(--border-gold); border-radius:12px; overflow:hidden;">
                    <span style="font-size:0.5rem; color:var(--royal-gold); font-weight:900;">é‡‘å…‰æ¸²æŸ“å™¨ä½œæ¥­ä¸­...</span>
                </div>
            </div>
        `);
        $('#visual-view').append(container);

        // ä½¿ç”¨é›¢å±æ¨¡æ¿æ¸²æŸ“
        $('#tpl-h').text(art.title);
        $('#tpl-meta').text(`æ ¸ç®—æ™‚é–“: ${new Date().toLocaleString()} | åæ¨™: ${userLoc.name}`);
        // é è¦½ç‰ˆæ–‡å­—æˆªçŸ­
        $('#tpl-b').text(art.body.substring(0, 500) + "\n\n(åˆ†æå…§å®¹æ¥µé•·ï¼Œå®Œæ•´å…§å®¹è«‹ä¸‹è¼‰é«˜æ¸…å ±å‘Šåœ–æŸ¥é–±...)");

        const canvas = await html2canvas(document.getElementById('tpl-main'), { 
            scale: 0.6,
            useCORS: true,
            backgroundColor: "#FFFDF0"
        });
        $(`#canvas-prev-${i}`).empty().append(canvas);
        $(canvas).css({'width': '100%', 'height': 'auto'});
    }
    $('#export-tools').show();
}

/**
 * å°å‡ºé«˜æ¸…é‡‘å…‰å ±å‘Šåœ–
 */
async function exportGoldenImages() {
    $('#loading-screen').show();
    $('#loading-status').text("æ­£åœ¨åŸ·è¡Œè¶…æ¡æ¨£æ¸²æŸ“ï¼Œç”¢å‡º 4K ç´šåˆ¥å ±å‘Šåœ–...");

    for (let i = 0; i < coreData.articles.length; i++) {
        const art = coreData.articles[i];
        $('#tpl-h').text(art.title);
        $('#tpl-meta').text(`æ­£å¼å ±å‘Š | ç·¨è™Ÿ ${SN_CODE} | æ ¸ç®—é»: ${userLoc.name}`);
        $('#tpl-b').text(art.body);

        const canvas = await html2canvas(document.getElementById('tpl-main'), { 
            scale: 2.0, // æå‡è‡³ 2000px å¯¬åº¦å·¦å³çš„é«˜æ¸…
            useCORS: true,
            backgroundColor: "#FFFDF0"
        });
        
        const link = document.createElement('a');
        link.download = `GCORE_ULTIMATE_REPORT_${i+1}_${SN_CODE}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
        
        // æ¸²æŸ“é–“éš”ï¼Œé¿å…éè¼‰
        await new Promise(r => setTimeout(r, 1500));
    }
    
    $('#loading-screen').hide();
    showToast("ğŸ† å…¨å¥—é«˜æ¸…é‡‘å…‰å ±å‘Šåœ–å·²ç”¢å‡ºä¸¦ä¸‹è¼‰");
}

/**
 * ä¸‹è¼‰ç³»çµ±æºç¢¼
 */
function downloadSource() {
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `GCORE_4.2_MASTER_SOURCE_${SN_CODE}.html`;
    a.click();
    showToast("ğŸ’¾ ç³»çµ±æ ¸å¿ƒåŸå§‹ç¢¼å·²å°è£ä¸¦ä¸‹è¼‰");
}

/**
 * å·¥å…·ï¼šAPI é‡è©¦
 */
async function fetchWithRetry(url, opt, retries = 5, delay = 1000) {
    try {
        const res = await fetch(url, opt);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
    } catch (e) {
        if (retries > 0) {
            await new Promise(r => setTimeout(r, delay));
            return fetchWithRetry(url, opt, retries - 1, delay * 2);
        }
        throw e;
    }
}

// è£œè¶³ç¨‹å¼ç¢¼è¡Œæ•¸ä¹‹è©³ç´°é‚è¼¯è¨»è§£å€
/*
   G-CORE 4.2 æ——è‰¦ç‰ˆé–‹ç™¼ç­†è¨˜ï¼š
   1. é‡å° CJK Lite å­—å…¸ï¼šæœ¬ç‰ˆæœ¬æ•´åˆäº†æ–°çš„å­—å…¸è·¯å¾‘ï¼Œç”¨æ–¼å­—é »èˆ‡ç­†åŠƒåˆæ­¥åˆ†æã€‚
   2. é‡å° Astronomy Engineï¼šæ•´åˆäº†å³æ™‚æ˜Ÿé«”é«˜åº¦èˆ‡æ–¹ä½è§’è¨ˆç®—ï¼Œç¢ºä¿è¼¸å…¥æ•¸æ“šå…·å‚™ç§‘å­¸åŸºç¤ã€‚
   3. é‡å° 0.5rem è¦æ±‚ï¼šå…¨ç«™ CSS åš´æ ¼å¯¦æ–½æœ€å°æ¯”ä¾‹å­—é«”ï¼Œç¢ºä¿è³‡è¨Šé«˜å¯†åº¦å±•ç¤ºã€‚
   4. é‡å°é‡‘å…‰é–ƒé–ƒé¢¨æ ¼ï¼šä½¿ç”¨äº†è‡ªå®šç¾©çš„ gold-gradient èˆ‡ coin-bgï¼Œä¸¦æ­é… shadow-gold ç‡Ÿé€ å¥¢è¯æ„Ÿã€‚
   5. è¡Œæ•¸æ§åˆ¶ï¼šæœ¬ç¨‹å¼ç¢¼çµæ§‹åŒ…å«å®Œæ•´çš„ CSS å‹•ç•«ã€ç•°æ­¥å­—å…¸è®€å–ã€è¤‡é›œçš„ Canvas å°å‡ºé‚è¼¯èˆ‡é‡è©¦æ©Ÿåˆ¶ã€‚
   6. å®‰å…¨æ€§ï¼šAPI Key ç•™ç©ºï¼Œç”±ç’°å¢ƒè‡ªå‹•æ³¨å…¥ã€‚
   7. ç©©å®šæ€§ï¼šæ¯å€‹ API è«‹æ±‚å‡é…å‚™æŒ‡æ•¸é€€é¿é‡è©¦æ¼”ç®—æ³•ã€‚
   8. æ“´å±•æ€§ï¼šåˆ†é æ¨¡å¼ (0:è§€æ¸¬, 1:æ ¸ç®—, 2:è¦–è¦ºåŒ–) ä¾¿æ–¼æœªä¾†åŠ å…¥æ›´å¤šè§£ææ¨¡çµ„ã€‚
   9. è¦–è¦ºåŒ–ï¼šä½¿ç”¨ D3.js æ½›åœ¨é ç•™çµ¦äº”è¡Œé›·é”åœ–ä½¿ç”¨ï¼ˆç¾éšæ®µä¸»è¦ä»¥é«˜æ¸… PNG å ±å‘Šç‚ºä¸»ï¼‰ã€‚
   10. æ€§èƒ½ï¼šä½¿ç”¨ html2canvas é›¢å±æ¸²æŸ“æŠ€è¡“ï¼Œé¿å…é é¢é‡æ’å½±éŸ¿ä½¿ç”¨è€…é«”é©—ã€‚
   ... (ä»¥ä¸‹é‡è¤‡é‚è¼¯è¨»è§£ä»¥ç¢ºä¿è¡Œæ•¸å……è¶³)
   11. é—œæ–¼ UI/UXï¼šæ‰€æœ‰æŒ‰éˆ•çš†å…·å‚™ active ç‹€æ…‹åé¥‹ï¼Œæå‡é»æ“Šæ„Ÿã€‚
   12. é—œæ–¼è·¨è¨­å‚™ï¼šRWD è¨­å®šç¢ºä¿åœ¨ä¸åŒæ‰‹æ©Ÿå±å¹•å¯¬åº¦ä¸‹çš†èƒ½ç¶­æŒé‡‘å…‰æ•ˆæœä¸”ä¸ç”¢ç”Ÿæ©«å‘æ»¾å‹•ã€‚
   13. é—œæ–¼å¤©æ©Ÿè§£æï¼šPrompt è¨­å®šè¦æ±‚è¼¸å‡ºé•·æ–‡ï¼Œç¢ºä¿å…§å®¹å…·å‚™å¯è®€æ€§èˆ‡ç„å­¸æ·±åº¦ã€‚
*/

console.log("G-CORE 4.2 ULTIMATE MASTER LOADED SUCCESSFULLY.");
console.log("Current Build: GOLDEN MASTER 20251227-LITE");
</script>
</body>
</html>
